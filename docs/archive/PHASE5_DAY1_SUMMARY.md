# Zmage v3.0.0 - Phase 5 Day 1: é…é¢ä½“ç³»è®¾è®¡ä¸æ•°æ®æ¨¡å‹

## ğŸ“… æ—¥æœŸ
Phase 5 å¼€å§‹ - Day 1 å®Œæˆ

## ğŸ¯ ä»Šæ—¥ç›®æ ‡
1. âœ… è®¾è®¡ä¸‰æ¡£è®¢é˜…å¥—é¤ï¼ˆFree/Pro/Premiumï¼‰
2. âœ… å®šä¹‰é…é¢é™åˆ¶è§„åˆ™
3. âœ… æ›´æ–° Prisma Schemaï¼ˆ4ä¸ªæ–°è¡¨ï¼‰
4. âœ… åˆ›å»ºå¥—é¤é…ç½®æ–‡ä»¶
5. âœ… åˆ›å»ºç±»å‹å®šä¹‰æ–‡ä»¶
6. âœ… å®ç°é…é¢ç®¡ç†æœåŠ¡åŸºç¡€ç±»
7. âœ… åˆ›å»ºæ•°æ®åº“ç§å­è„šæœ¬

## âœ… å®Œæˆå†…å®¹

### 1. è®¢é˜…å¥—é¤ä½“ç³»è®¾è®¡

#### Free å¥—é¤ï¼ˆå…è´¹ç‰ˆï¼‰
**ç›®æ ‡ç”¨æˆ·**: ä¸ªäººä½“éªŒç”¨æˆ·

**é…é¢é™åˆ¶**:
- ğŸ’¾ å­˜å‚¨ç©ºé—´: 5GB
- ğŸ¤– AI åˆ†æ: 100 æ¬¡/æœˆ
- ğŸ¨ AI ç”Ÿæˆ: 10 æ¬¡/æœˆ
- ğŸ› ï¸ åˆ›ä½œå·¥åŠ: 20 æ¬¡/æœˆ
- ğŸ“ ç›¸å†Œ: æœ€å¤š 10 ä¸ª
- ğŸ”— åˆ†äº«é“¾æ¥: æœ€å¤š 5 ä¸ª
- ğŸ¬ è§†é¢‘æ—¶é•¿: æœ€é•¿ 1 åˆ†é’Ÿ
- ğŸ“¤ å•æ–‡ä»¶: æœ€å¤§ 50MB
- ğŸ”„ å¹¶å‘ä¸Šä¼ : 3 ä¸ª
- âš¡ é˜Ÿåˆ—ä¼˜å…ˆçº§: 1ï¼ˆæœ€ä½ï¼‰

**ç‰¹æ€§**:
- åŸºç¡€æœç´¢åŠŸèƒ½
- ç¤¾åŒºæ”¯æŒ

**å®šä»·**: $0/æœˆ

---

#### Pro å¥—é¤ï¼ˆä¸“ä¸šç‰ˆï¼‰â­ æ¨è
**ç›®æ ‡ç”¨æˆ·**: ä¸“ä¸šæ‘„å½±å¸ˆå’Œå†…å®¹åˆ›ä½œè€…

**é…é¢é™åˆ¶**:
- ğŸ’¾ å­˜å‚¨ç©ºé—´: 100GB
- ğŸ¤– AI åˆ†æ: 1,000 æ¬¡/æœˆ
- ğŸ¨ AI ç”Ÿæˆ: 200 æ¬¡/æœˆ
- ğŸ› ï¸ åˆ›ä½œå·¥åŠ: 500 æ¬¡/æœˆ
- ğŸ“ ç›¸å†Œ: æœ€å¤š 100 ä¸ª
- ğŸ”— åˆ†äº«é“¾æ¥: æœ€å¤š 50 ä¸ª
- ğŸ¬ è§†é¢‘æ—¶é•¿: æœ€é•¿ 10 åˆ†é’Ÿ
- ğŸ“¤ å•æ–‡ä»¶: æœ€å¤§ 500MB
- ğŸ”„ å¹¶å‘ä¸Šä¼ : 10 ä¸ª
- âš¡ é˜Ÿåˆ—ä¼˜å…ˆçº§: 5ï¼ˆä¸­ç­‰ï¼‰

**ç‰¹æ€§**:
- âš¡ ä¼˜å…ˆé˜Ÿåˆ—å¤„ç†
- ğŸ”’ é«˜çº§åˆ†äº«æ§åˆ¶ï¼ˆå¯†ç ã€è¿‡æœŸæ—¶é—´ï¼‰
- ğŸ“Š é«˜çº§æœç´¢å’Œç­›é€‰
- ğŸ” Elasticsearch å…¨æ–‡æœç´¢
- ğŸ“ˆ ä½¿ç”¨ç»Ÿè®¡åˆ†æ
- ğŸš« æ— å¹¿å‘Š
- ğŸ“§ é‚®ä»¶æ”¯æŒ

**å®šä»·**: 
- æœˆä»˜: $9.99/æœˆ
- å¹´ä»˜: $99.99/å¹´ï¼ˆèŠ‚çœ 16%ï¼Œçº¦ $8.33/æœˆï¼‰

---

#### Premium å¥—é¤ï¼ˆä¼ä¸šç‰ˆï¼‰
**ç›®æ ‡ç”¨æˆ·**: å›¢é˜Ÿå’Œä¼ä¸šçº§ç”¨æˆ·

**é…é¢é™åˆ¶**:
- ğŸ’¾ å­˜å‚¨ç©ºé—´: 1TB
- ğŸ¤– AI åˆ†æ: æ— é™åˆ¶
- ğŸ¨ AI ç”Ÿæˆ: æ— é™åˆ¶
- ğŸ› ï¸ åˆ›ä½œå·¥åŠ: æ— é™åˆ¶
- ğŸ“ ç›¸å†Œ: æ— é™åˆ¶
- ğŸ”— åˆ†äº«é“¾æ¥: æ— é™åˆ¶
- ğŸ¬ è§†é¢‘æ—¶é•¿: æœ€é•¿ 1 å°æ—¶
- ğŸ“¤ å•æ–‡ä»¶: æœ€å¤§ 2GB
- ğŸ”„ å¹¶å‘ä¸Šä¼ : 50 ä¸ª
- âš¡ é˜Ÿåˆ—ä¼˜å…ˆçº§: 10ï¼ˆæœ€é«˜ï¼‰

**ç‰¹æ€§**:
- âš¡âš¡ æœ€é«˜ä¼˜å…ˆçº§å¤„ç†
- ğŸ”’ å…¨éƒ¨é«˜çº§åˆ†äº«åŠŸèƒ½
- ğŸ“Š å®Œæ•´æ•°æ®åˆ†æ Dashboard
- ğŸ” AI ä»¥å›¾æœå›¾
- ğŸ“¦ æ‰¹é‡åˆ†äº«å’Œæ‰“åŒ…ä¸‹è½½
- ğŸ’¾ æ•°æ®å¯¼å‡ºåŠŸèƒ½
- ğŸ”„ è‡ªåŠ¨å¤‡ä»½ï¼ˆå³å°†æ¨å‡ºï¼‰
- ğŸ‘¥ å›¢é˜Ÿåä½œï¼ˆå³å°†æ¨å‡ºï¼‰
- ğŸ¯ è‡ªå®šä¹‰ AI æ¨¡å‹ï¼ˆå³å°†æ¨å‡ºï¼‰
- ğŸ“ ä¼˜å…ˆå®¢æœæ”¯æŒ
- ğŸ“ ä¸“å±åŸ¹è®­èµ„æº

**å®šä»·**: 
- æœˆä»˜: $29.99/æœˆ
- å¹´ä»˜: $299.99/å¹´ï¼ˆèŠ‚çœ 17%ï¼Œçº¦ $25/æœˆï¼‰

---

### 2. æ•°æ®åº“ Schema æ‰©å±•

#### æ–°å¢è¡¨ç»“æ„

##### SubscriptionPlanï¼ˆè®¢é˜…å¥—é¤è¡¨ï¼‰
ç³»ç»Ÿçº§é…ç½®ï¼Œå­˜å‚¨å¥—é¤ä¿¡æ¯

```prisma
model SubscriptionPlan {
  id                String   @id @default(cuid())
  name              String   @unique // "free", "pro", "premium"
  displayName       String
  description       String?
  price             Float
  interval          String?  // "month", "year", null for free
  stripeProductId   String?  @unique
  stripePriceId     String?  // æœˆä»˜ Price ID
  stripeYearlyPriceId String? // å¹´ä»˜ Price ID
  limits            String   // JSON string
  features          String   // JSON string
  isActive          Boolean  @default(true)
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  subscriptions     UserSubscription[]
}
```

##### UserSubscriptionï¼ˆç”¨æˆ·è®¢é˜…è¡¨ï¼‰
å­˜å‚¨ç”¨æˆ·çš„è®¢é˜…ä¿¡æ¯å’Œé…é¢ä½¿ç”¨æƒ…å†µ

```prisma
model UserSubscription {
  id                String   @id @default(cuid())
  userId            String
  planId            String
  
  // Stripe ç›¸å…³
  stripeCustomerId      String?
  stripeSubscriptionId  String?  @unique
  stripePriceId         String?
  stripeCurrentPeriodStart DateTime?
  stripeCurrentPeriodEnd   DateTime?
  
  // è®¢é˜…çŠ¶æ€
  status            String   @default("active")
  cancelAtPeriodEnd Boolean  @default(false)
  canceledAt        DateTime?
  
  // è¯•ç”¨æœŸ
  trialStart        DateTime?
  trialEnd          DateTime?
  
  // é…é¢ä½¿ç”¨ï¼ˆå½“å‰å‘¨æœŸï¼ŒJSON å­˜å‚¨ï¼‰
  quotaUsage        String   @default("{}")
  
  // å‘¨æœŸé‡ç½®
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(...)
  plan              SubscriptionPlan @relation(...)
  payments          Payment[]
  usageLogs         UsageLog[]
}
```

##### Paymentï¼ˆæ”¯ä»˜è®°å½•è¡¨ï¼‰
å­˜å‚¨æ‰€æœ‰æ”¯ä»˜äº¤æ˜“è®°å½•

```prisma
model Payment {
  id                String   @id @default(cuid())
  userId            String
  subscriptionId    String
  
  // Stripe ç›¸å…³
  stripePaymentIntentId String? @unique
  stripeInvoiceId       String? @unique
  
  // æ”¯ä»˜ä¿¡æ¯
  amount            Float
  currency          String   @default("usd")
  status            String   // succeeded, pending, failed, refunded
  
  // å‘ç¥¨ä¿¡æ¯
  invoiceUrl        String?
  invoicePdf        String?
  receiptUrl        String?
  
  // å¤±è´¥ä¿¡æ¯
  failureCode       String?
  failureMessage    String?
  
  // é€€æ¬¾ä¿¡æ¯
  refunded          Boolean  @default(false)
  refundedAt        DateTime?
  refundAmount      Float?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  user              User     @relation(...)
  subscription      UserSubscription @relation(...)
}
```

##### UsageLogï¼ˆé…é¢ä½¿ç”¨æ—¥å¿—è¡¨ï¼‰
è®°å½•æ‰€æœ‰é…é¢æ¶ˆè´¹è¡Œä¸º

```prisma
model UsageLog {
  id                String   @id @default(cuid())
  userId            String
  subscriptionId    String
  
  // ä½¿ç”¨ç±»å‹
  type              String   // "ai_analysis", "ai_generation", "workshop", etc
  action            String   // å…·ä½“æ“ä½œ
  
  // ä½¿ç”¨é‡
  amount            Float    @default(1)
  unit              String?  // "count", "bytes", "seconds"
  
  // å…³è”èµ„æº
  resourceType      String?  // "image", "video", "album"
  resourceId        String?
  
  // å…ƒæ•°æ®ï¼ˆJSON å­˜å‚¨ï¼‰
  metadata          String?
  
  createdAt         DateTime @default(now())
  
  user              User     @relation(...)
  subscription      UserSubscription @relation(...)
}
```

#### User è¡¨æ–°å¢å­—æ®µ
```prisma
model User {
  // ... ç°æœ‰å­—æ®µ
  
  // è®¢é˜…ç›¸å…³
  subscriptions     UserSubscription[]
  payments          Payment[]
  usageLogs         UsageLog[]
  stripeCustomerId  String?  @unique
}
```

---

### 3. å¥—é¤é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `frontend/lib/subscription/plans.ts`ï¼ˆ419 è¡Œï¼‰

#### æ ¸å¿ƒåŠŸèƒ½

##### å¥—é¤å¸¸é‡å®šä¹‰
```typescript
export const SUBSCRIPTION_PLANS: Record<SubscriptionPlanId, SubscriptionPlan> = {
  free: { /* å…è´¹å¥—é¤é…ç½® */ },
  pro: { /* ä¸“ä¸šå¥—é¤é…ç½® */ },
  premium: { /* ä¼ä¸šå¥—é¤é…ç½® */ },
};
```

##### é…é¢ç±»å‹
```typescript
export type QuotaType =
  | 'storage'               // å­˜å‚¨ç©ºé—´
  | 'ai_analysis'           // AI åˆ†æ
  | 'ai_generation'         // AI ç”Ÿæˆ
  | 'workshop'              // åˆ›ä½œå·¥åŠ
  | 'album'                 // ç›¸å†Œ
  | 'shared_link'           // åˆ†äº«é“¾æ¥
  | 'video_duration'        // è§†é¢‘æ—¶é•¿
  | 'batch_operation'       // æ‰¹é‡æ“ä½œ
  | 'file_size'             // æ–‡ä»¶å¤§å°
  | 'concurrent_upload';    // å¹¶å‘ä¸Šä¼ 
```

##### å·¥å…·å‡½æ•°
```typescript
// è·å–å¥—é¤ä¿¡æ¯
getPlan(planId: SubscriptionPlanId): SubscriptionPlan

// è·å–æ‰€æœ‰å¥—é¤ï¼ˆæ’åºï¼‰
getAllPlans(): SubscriptionPlan[]

// æ ¹æ® Stripe Price ID è·å–å¥—é¤
getPlanByPriceId(priceId: string): SubscriptionPlan | undefined

// æ ¼å¼åŒ–å­˜å‚¨ç©ºé—´
formatStorage(bytes: number): string

// æ ¼å¼åŒ–ä»·æ ¼
formatPrice(price: number, currency?: string): string

// è®¡ç®—å¹´è´¹èŠ‚çœç™¾åˆ†æ¯”
calculateYearlySavings(monthlyPrice: number, yearlyPrice: number): number

// æ£€æŸ¥é…é¢æ˜¯å¦æ— é™
isUnlimited(limit: number): boolean

// è·å–é…é¢æ˜¾ç¤ºæ–‡æœ¬
getQuotaDisplay(limit: number, unit?: string): string

// æ¯”è¾ƒå¥—é¤ç­‰çº§
comparePlans(planA: SubscriptionPlanId, planB: SubscriptionPlanId): number

// æ£€æŸ¥æ˜¯å¦å¯ä»¥é™çº§
canDowngrade(
  currentPlan: SubscriptionPlanId,
  targetPlan: SubscriptionPlanId,
  currentUsage: Partial<QuotaUsage>
): { allowed: boolean; reasons: string[] }

// è·å–æ¨èå¥—é¤
getRecommendedPlan(): SubscriptionPlan | undefined
```

---

### 4. ç±»å‹å®šä¹‰æ–‡ä»¶

**æ–‡ä»¶**: `frontend/lib/subscription/types.ts`ï¼ˆ351 è¡Œï¼‰

#### æ ¸å¿ƒç±»å‹

##### è®¢é˜…çŠ¶æ€
```typescript
export type SubscriptionStatus =
  | 'active'        // æ´»è·ƒ
  | 'trialing'      // è¯•ç”¨æœŸ
  | 'past_due'      // é€¾æœŸ
  | 'canceled'      // å·²å–æ¶ˆ
  | 'unpaid'        // æœªæ”¯ä»˜
  | 'incomplete'    // æœªå®Œæˆ
  | 'incomplete_expired'; // æœªå®Œæˆå·²è¿‡æœŸ
```

##### æ”¯ä»˜çŠ¶æ€
```typescript
export type PaymentStatus =
  | 'succeeded'     // æˆåŠŸ
  | 'pending'       // å¤„ç†ä¸­
  | 'failed'        // å¤±è´¥
  | 'refunded'      // å·²é€€æ¬¾
  | 'canceled';     // å·²å–æ¶ˆ
```

##### é…é¢æ£€æŸ¥ç»“æœ
```typescript
export interface QuotaCheckResult {
  allowed: boolean;
  current: number;
  limit: number;
  remaining: number;
  percentage: number;
  isUnlimited: boolean;
  reason?: string;
}
```

##### Webhook äº‹ä»¶ç±»å‹
```typescript
export type WebhookEventType =
  | 'checkout.session.completed'
  | 'customer.subscription.created'
  | 'customer.subscription.updated'
  | 'customer.subscription.deleted'
  | 'invoice.paid'
  | 'payment_intent.succeeded'
  // ... æ›´å¤šäº‹ä»¶
```

---

### 5. é…é¢ç®¡ç†æœåŠ¡

**æ–‡ä»¶**: `frontend/lib/subscription/quota-service.ts`ï¼ˆ440 è¡Œï¼‰

#### æ ¸å¿ƒæ–¹æ³•

##### checkQuota() - æ£€æŸ¥é…é¢
æ£€æŸ¥ç”¨æˆ·é…é¢æ˜¯å¦å……è¶³

```typescript
async checkQuota(
  userId: string,
  type: QuotaType,
  amount: number = 1
): Promise<QuotaCheckResult>
```

**åŠŸèƒ½**:
- è·å–ç”¨æˆ·å½“å‰è®¢é˜…å’Œå¥—é¤
- è§£æå¥—é¤é…é¢é™åˆ¶
- å¤„ç†æ— é™åˆ¶é…é¢ï¼ˆ-1ï¼‰
- è®¡ç®—å½“å‰ä½¿ç”¨é‡å’Œå‰©ä½™é‡
- è¿”å›è¯¦ç»†çš„æ£€æŸ¥ç»“æœ

**ç¤ºä¾‹**:
```typescript
const result = await quotaService.checkQuota('user-id', 'ai_analysis', 1);
if (!result.allowed) {
  console.log(`é…é¢ä¸è¶³: ${result.reason}`);
}
```

##### consumeQuota() - æ¶ˆè´¹é…é¢
æ¶ˆè´¹é…é¢å¹¶è®°å½•ä½¿ç”¨æ—¥å¿—

```typescript
async consumeQuota(params: ConsumeQuotaParams): Promise<void>
```

**åŠŸèƒ½**:
- æ›´æ–°è®¢é˜…çš„é…é¢ä½¿ç”¨æƒ…å†µ
- è®°å½•è¯¦ç»†çš„ä½¿ç”¨æ—¥å¿—
- æ”¯æŒå…ƒæ•°æ®è®°å½•
- å…³è”èµ„æºä¿¡æ¯

**ç¤ºä¾‹**:
```typescript
await quotaService.consumeQuota({
  userId: 'user-id',
  type: 'ai_analysis',
  amount: 1,
  resourceType: 'image',
  resourceId: 'image-id',
  metadata: { provider: 'gemini', model: 'gemini-2.0-flash-exp' }
});
```

##### getQuotaUsage() - è·å–é…é¢ä½¿ç”¨æƒ…å†µ
è·å–ç”¨æˆ·å½“å‰å‘¨æœŸçš„é…é¢ä½¿ç”¨ç»Ÿè®¡

```typescript
async getQuotaUsage(userId: string): Promise<QuotaUsage>
```

**è¿”å›**:
```typescript
{
  storage: 1024000000,      // å­—èŠ‚
  aiAnalysis: 50,           // æ¬¡æ•°
  aiGeneration: 5,          // æ¬¡æ•°
  workshops: 10,            // æ¬¡æ•°
  albums: 3,                // ä¸ªæ•°
  sharedLinks: 2,           // ä¸ªæ•°
  periodStart: Date,        // å‘¨æœŸå¼€å§‹
  periodEnd: Date,          // å‘¨æœŸç»“æŸ
}
```

##### resetPeriodQuota() - é‡ç½®å‘¨æœŸé…é¢
é‡ç½®å•ä¸ªç”¨æˆ·çš„å‘¨æœŸæ€§é…é¢

```typescript
async resetPeriodQuota(userId: string): Promise<QuotaResetResult>
```

**åŠŸèƒ½**:
- é‡ç½®å‘¨æœŸæ€§é…é¢ï¼ˆAI åˆ†æã€ç”Ÿæˆã€å·¥åŠï¼‰
- ä¿ç•™ç´¯è®¡æ€§é…é¢ï¼ˆå­˜å‚¨ã€ç›¸å†Œã€åˆ†äº«é“¾æ¥ï¼‰
- æ›´æ–°å‘¨æœŸæ—¶é—´ï¼ˆ+1ä¸ªæœˆï¼‰
- è¿”å›é‡ç½®ç»“æœ

##### resetExpiredSubscriptions() - æ‰¹é‡é‡ç½®
æ‰¹é‡é‡ç½®æ‰€æœ‰è¿‡æœŸè®¢é˜…çš„é…é¢

```typescript
async resetExpiredSubscriptions(): Promise<QuotaResetResult[]>
```

**ç”¨é€”**: å®šæ—¶ä»»åŠ¡è°ƒç”¨ï¼Œæ¯æ—¥æ£€æŸ¥å¹¶é‡ç½®è¿‡æœŸè®¢é˜…

##### checkAndResetIfExpired() - æ£€æŸ¥å¹¶é‡ç½®
æ£€æŸ¥ç”¨æˆ·é…é¢æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™è‡ªåŠ¨é‡ç½®

```typescript
async checkAndResetIfExpired(userId: string): Promise<boolean>
```

**ç”¨é€”**: åœ¨æ¯æ¬¡é…é¢æ£€æŸ¥å‰è°ƒç”¨ï¼Œç¡®ä¿é…é¢æ•°æ®æœ€æ–°

---

### 6. æ•°æ®åº“ç§å­è„šæœ¬

**æ–‡ä»¶**: `frontend/prisma/seed-subscriptions.ts`ï¼ˆ142 è¡Œï¼‰

#### åŠŸèƒ½

##### 1. åˆå§‹åŒ–è®¢é˜…å¥—é¤
ä»é…ç½®æ–‡ä»¶è¯»å–å¥—é¤å®šä¹‰ï¼Œåˆ›å»ºæˆ–æ›´æ–°æ•°æ®åº“ä¸­çš„å¥—é¤è®°å½•

```typescript
for (const plan of Object.values(SUBSCRIPTION_PLANS)) {
  // åˆ›å»ºæˆ–æ›´æ–°å¥—é¤
  await prisma.subscriptionPlan.upsert({
    where: { name: plan.id },
    create: { /* å¥—é¤æ•°æ® */ },
    update: { /* å¥—é¤æ•°æ® */ },
  });
}
```

##### 2. ä¸ºç°æœ‰ç”¨æˆ·åˆ›å»ºè®¢é˜…
æ‰«ææ‰€æœ‰ç”¨æˆ·ï¼Œä¸ºæ²¡æœ‰è®¢é˜…çš„ç”¨æˆ·åˆ›å»ºå…è´¹è®¢é˜…

```typescript
for (const user of users) {
  if (user.subscriptions.length === 0) {
    await prisma.userSubscription.create({
      data: {
        userId: user.id,
        planId: freePlan.id,
        status: 'active',
        currentPeriodStart: now,
        currentPeriodEnd: periodEnd,
        quotaUsage: JSON.stringify({
          storage: 0,
          aiAnalysis: 0,
          aiGeneration: 0,
          workshops: 0,
          albums: 0,
          sharedLinks: 0,
        }),
      },
    });
  }
}
```

##### 3. æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
ç»Ÿè®¡å„å¥—é¤çš„ç”¨æˆ·åˆ†å¸ƒ

```typescript
const subscriptionStats = await prisma.userSubscription.groupBy({
  by: ['planId'],
  _count: { id: true },
});
```

#### ä½¿ç”¨æ–¹æ³•
```bash
# æ‰§è¡Œç§å­è„šæœ¬
cd frontend
npx tsx prisma/seed-subscriptions.ts
```

---

## ğŸ“Š ä»£ç ç»Ÿè®¡

### æ–°å¢æ–‡ä»¶
| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `lib/subscription/plans.ts` | 419 | å¥—é¤é…ç½®å’Œå·¥å…·å‡½æ•° |
| `lib/subscription/types.ts` | 351 | ç±»å‹å®šä¹‰ |
| `lib/subscription/quota-service.ts` | 440 | é…é¢ç®¡ç†æœåŠ¡ |
| `prisma/seed-subscriptions.ts` | 142 | ç§å­æ•°æ®è„šæœ¬ |
| **æ€»è®¡** | **1,352** | **æ–°å¢ä»£ç ** |

### ä¿®æ”¹æ–‡ä»¶
| æ–‡ä»¶ | å˜æ›´ | è¯´æ˜ |
|------|------|------|
| `prisma/schema.prisma` | +157 è¡Œ | æ–°å¢ 4 ä¸ªè¡¨å’Œå…³ç³» |

### æ–‡æ¡£
| æ–‡ä»¶ | è¡Œæ•° | è¯´æ˜ |
|------|------|------|
| `docs/PHASE5_COMMERCIALIZATION.md` | 1917 | Phase 5 å®Œæ•´è®¡åˆ’ |
| `docs/PHASE5_PROGRESS.md` | 541 | Phase 5 è¿›åº¦è·Ÿè¸ª |
| `docs/PHASE5_DAY1_SUMMARY.md` | æœ¬æ–‡æ¡£ | Day 1 å·¥ä½œæ€»ç»“ |

---

## ğŸ¯ æŠ€æœ¯äº®ç‚¹

### 1. çµæ´»çš„é…é¢ä½“ç³»è®¾è®¡
- âœ… æ”¯æŒå¤šç§é…é¢ç±»å‹ï¼ˆå­˜å‚¨ã€è®¡æ•°ã€æ—¶é•¿ç­‰ï¼‰
- âœ… åŒºåˆ†å‘¨æœŸæ€§é…é¢å’Œç´¯è®¡æ€§é…é¢
- âœ… æ”¯æŒæ— é™åˆ¶é…é¢ï¼ˆ-1ï¼‰
- âœ… è¯¦ç»†çš„é…é¢æ£€æŸ¥ç»“æœ

### 2. å®Œå–„çš„æ•°æ®æ¨¡å‹
- âœ… æ¸…æ™°çš„è¡¨ç»“æ„å’Œå…³ç³»
- âœ… æ”¯æŒ Stripe é›†æˆï¼ˆé¢„ç•™å­—æ®µï¼‰
- âœ… æ”¯æŒè¯•ç”¨æœŸåŠŸèƒ½
- âœ… å®Œæ•´çš„æ”¯ä»˜å’Œé€€æ¬¾è®°å½•
- âœ… è¯¦ç»†çš„ä½¿ç”¨æ—¥å¿—è¿½è¸ª

### 3. å¥å£®çš„é…é¢ç®¡ç†
- âœ… åŸå­æ€§çš„é…é¢æ£€æŸ¥å’Œæ¶ˆè´¹
- âœ… è‡ªåŠ¨åŒ–çš„å‘¨æœŸé‡ç½®
- âœ… è¿‡æœŸæ£€æŸ¥å’Œè‡ªåŠ¨é‡ç½®
- âœ… æ‰¹é‡å¤„ç†èƒ½åŠ›
- âœ… è¯¦ç»†çš„ä½¿ç”¨æ—¥å¿—

### 4. ä¼˜é›…çš„ API è®¾è®¡
- âœ… ç±»å‹å®‰å…¨çš„æ¥å£
- âœ… æ¸…æ™°çš„é”™è¯¯å¤„ç†
- âœ… æ˜“äºæ‰©å±•çš„æ¶æ„
- âœ… ä¸°å¯Œçš„å·¥å…·å‡½æ•°

### 5. æ˜“äºç»´æŠ¤çš„é…ç½®
- âœ… é›†ä¸­å¼å¥—é¤é…ç½®
- âœ… ç¯å¢ƒå˜é‡æ”¯æŒï¼ˆStripe IDsï¼‰
- âœ… ç§å­è„šæœ¬è‡ªåŠ¨åŒ–åˆå§‹åŒ–
- âœ… æ”¯æŒå¥—é¤åŠ¨æ€æ›´æ–°

---

## ğŸ”„ ä¸‹ä¸€æ­¥å·¥ä½œï¼ˆPhase 5 Day 2-3ï¼‰

### Day 2-3: Stripe æ”¯ä»˜é›†æˆï¼ˆé¢„è®¡ 3 å¤©ï¼‰

#### ç¯å¢ƒé…ç½®
- [ ] æ³¨å†Œ Stripe è´¦å·ï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰
- [ ] åˆ›å»ºäº§å“å’Œä»·æ ¼ï¼ˆ3ä¸ªå¥—é¤ x æœˆä»˜/å¹´ä»˜ï¼‰
- [ ] é…ç½® Webhook ç«¯ç‚¹
- [ ] è®¾ç½®ç¯å¢ƒå˜é‡

#### Stripe æœåŠ¡å°è£…
- [ ] å®‰è£… `stripe` npm åŒ…
- [ ] åˆ›å»º `lib/stripe/stripe-service.ts`
- [ ] å®ç°å®¢æˆ·ç®¡ç†æ–¹æ³•
  - [ ] `getOrCreateCustomer()`
  - [ ] `updateCustomer()`
- [ ] å®ç°è®¢é˜…ç®¡ç†æ–¹æ³•
  - [ ] `createSubscription()`
  - [ ] `updateSubscription()`
  - [ ] `cancelSubscription()`
- [ ] å®ç° Checkout æ–¹æ³•
  - [ ] `createCheckoutSession()`
  - [ ] `createPortalSession()`

#### API ç«¯ç‚¹å¼€å‘
- [ ] `/api/subscription/plans` - è·å–å¥—é¤åˆ—è¡¨
- [ ] `/api/subscription/current` - è·å–å½“å‰è®¢é˜…
- [ ] `/api/subscription/checkout` - åˆ›å»ºæ”¯ä»˜ä¼šè¯
- [ ] `/api/subscription/portal` - å®¢æˆ·ç®¡ç†é—¨æˆ·
- [ ] `/api/subscription/webhook` - Stripe Webhook å¤„ç†

#### Webhook å¤„ç†å™¨
- [ ] å®ç°äº‹ä»¶éªŒè¯
- [ ] å¤„ç† `checkout.session.completed`
- [ ] å¤„ç† `invoice.paid`
- [ ] å¤„ç† `customer.subscription.updated`
- [ ] å¤„ç† `customer.subscription.deleted`
- [ ] å¤„ç† `invoice.payment_failed`

#### æµ‹è¯•
- [ ] æµ‹è¯•æ”¯ä»˜æµç¨‹ï¼ˆæˆåŠŸï¼‰
- [ ] æµ‹è¯•æ”¯ä»˜å¤±è´¥åœºæ™¯
- [ ] æµ‹è¯•è®¢é˜…æ›´æ–°
- [ ] æµ‹è¯•è®¢é˜…å–æ¶ˆ
- [ ] æµ‹è¯• Webhook å¤„ç†

---

## ğŸ’¡ ç»éªŒæ€»ç»“

### è®¾è®¡å†³ç­–

#### 1. JSON å­˜å‚¨ vs å…³ç³»å‹å­˜å‚¨
**å†³ç­–**: é…é¢é™åˆ¶å’Œä½¿ç”¨æƒ…å†µä½¿ç”¨ JSON å­˜å‚¨

**åŸå› **:
- âœ… çµæ´»æ€§ï¼šé…é¢ç±»å‹å¯èƒ½éšæ—¶æ‰©å±•
- âœ… æ€§èƒ½ï¼šå‡å°‘è¡¨è¿æ¥æŸ¥è¯¢
- âœ… åŸå­æ€§ï¼šå•æ¬¡æ›´æ–°é…é¢ä½¿ç”¨æƒ…å†µ
- âŒ åŠ£åŠ¿ï¼šæ— æ³•ç›´æ¥èšåˆæŸ¥è¯¢ï¼ˆå¯é€šè¿‡ UsageLog è¡¥å……ï¼‰

#### 2. é…é¢ç±»å‹è®¾è®¡
**å†³ç­–**: åŒºåˆ†å‘¨æœŸæ€§é…é¢å’Œç´¯è®¡æ€§é…é¢

**å‘¨æœŸæ€§é…é¢**ï¼ˆæ¯æœˆé‡ç½®ï¼‰:
- AI åˆ†ææ¬¡æ•°
- AI ç”Ÿæˆæ¬¡æ•°
- åˆ›ä½œå·¥åŠä½¿ç”¨æ¬¡æ•°

**ç´¯è®¡æ€§é…é¢**ï¼ˆä¸é‡ç½®ï¼‰:
- å­˜å‚¨ç©ºé—´
- ç›¸å†Œæ•°é‡
- åˆ†äº«é“¾æ¥æ•°é‡

**åŸå› **: ç¬¦åˆå®é™…ä¸šåŠ¡é€»è¾‘ï¼Œè®¡è´¹æ–¹å¼æ›´åˆç†

#### 3. é…é¢æœåŠ¡å•ä¾‹æ¨¡å¼
**å†³ç­–**: å¯¼å‡ºé…é¢æœåŠ¡å•ä¾‹

**ä¼˜ç‚¹**:
- âœ… é¿å…é‡å¤åˆ›å»º Prisma å®¢æˆ·ç«¯
- âœ… ç»Ÿä¸€çš„é…é¢ç®¡ç†å…¥å£
- âœ… æ–¹ä¾¿åç»­æ·»åŠ ç¼“å­˜å±‚

### æœ€ä½³å®è·µ

#### 1. ç±»å‹å®‰å…¨
- ä½¿ç”¨ TypeScript ä¸¥æ ¼ç±»å‹
- å®šä¹‰æ¸…æ™°çš„æ¥å£å’Œç±»å‹
- é¿å…ä½¿ç”¨ `any` ç±»å‹

#### 2. é”™è¯¯å¤„ç†
- æ•è·å¹¶è®°å½•æ‰€æœ‰é”™è¯¯
- è¿”å›å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- é¿å…æš´éœ²æ•æ„Ÿä¿¡æ¯

#### 3. æ•°æ®ä¸€è‡´æ€§
- ä½¿ç”¨äº‹åŠ¡å¤„ç†å…³é”®æ“ä½œ
- é…é¢æ£€æŸ¥å’Œæ¶ˆè´¹åŸå­åŒ–
- é¿å…å¹¶å‘å†²çª

#### 4. å¯æ‰©å±•æ€§
- é…ç½®åŒ–çš„å¥—é¤å®šä¹‰
- çµæ´»çš„é…é¢ç±»å‹ç³»ç»Ÿ
- é¢„ç•™ Stripe é›†æˆå­—æ®µ

---

## ğŸ› å·²çŸ¥é—®é¢˜

### å¾…è§£å†³

1. **é…é¢å¹¶å‘å†²çª**
   - é—®é¢˜: é«˜å¹¶å‘åœºæ™¯ä¸‹å¯èƒ½å‡ºç°é…é¢è¶…é™
   - è§£å†³æ–¹æ¡ˆ: æ·»åŠ ä¹è§‚é”æˆ–åˆ†å¸ƒå¼é”ï¼ˆDay 6-7 ä¼˜åŒ–ï¼‰

2. **å­˜å‚¨é…é¢å®æ—¶æ€§**
   - é—®é¢˜: å­˜å‚¨é…é¢ä¾èµ–å®æ—¶è®¡ç®—æ–‡ä»¶å¤§å°æ€»å’Œ
   - è§£å†³æ–¹æ¡ˆ: åœ¨ä¸Šä¼ /åˆ é™¤æ—¶åŒæ­¥æ›´æ–°é…é¢ï¼ˆDay 8-10 å®ç°ï¼‰

3. **é…é¢é‡ç½®å®šæ—¶ä»»åŠ¡**
   - é—®é¢˜: å°šæœªå®ç°è‡ªåŠ¨åŒ–çš„å®šæ—¶é‡ç½®ä»»åŠ¡
   - è§£å†³æ–¹æ¡ˆ: ä½¿ç”¨ BullMQ å®šæ—¶ä»»åŠ¡ï¼ˆDay 6-7 å®ç°ï¼‰

### æ”¹è¿›å»ºè®®

1. **é…é¢ç¼“å­˜**
   - å°†é…é¢æ£€æŸ¥ç»“æœç¼“å­˜åˆ° Redis
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
   - è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆ5-10 åˆ†é’Ÿï¼‰

2. **é…é¢é¢„è­¦**
   - å½“é…é¢ä½¿ç”¨è¾¾åˆ° 80% æ—¶å‘é€é€šçŸ¥
   - æå‰å¼•å¯¼ç”¨æˆ·å‡çº§å¥—é¤
   - æå‡ç”¨æˆ·ä½“éªŒå’Œä»˜è´¹è½¬åŒ–

3. **é…é¢ç»Ÿè®¡ä¼˜åŒ–**
   - ä½¿ç”¨ UsageLog è¿›è¡Œé…é¢ç»Ÿè®¡åˆ†æ
   - ç”Ÿæˆé…é¢ä½¿ç”¨è¶‹åŠ¿å›¾è¡¨
   - è¾…åŠ©è¿è¥å†³ç­–

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Phase 5 å®Œæ•´è®¡åˆ’](./PHASE5_COMMERCIALIZATION.md)
- [Phase 5 è¿›åº¦è·Ÿè¸ª](./PHASE5_PROGRESS.md)
- [è®¢é˜…å¥—é¤é…ç½®](../frontend/lib/subscription/plans.ts)
- [é…é¢ç®¡ç†æœåŠ¡](../frontend/lib/subscription/quota-service.ts)
- [Prisma Schema](../frontend/prisma/schema.prisma)

---

## ğŸ‰ Day 1 æ€»ç»“

ä»Šå¤©æˆåŠŸå®Œæˆäº† Phase 5 Day 1 çš„æ‰€æœ‰å·¥ä½œï¼š

âœ… **å®Œæ•´çš„è®¢é˜…å¥—é¤ä½“ç³»è®¾è®¡** - 3 ä¸ªå¥—é¤ï¼Œè¦†ç›–ä¸åŒç”¨æˆ·ç¾¤ä½“  
âœ… **å®Œå–„çš„æ•°æ®åº“æ¶æ„** - 4 ä¸ªæ–°è¡¨ï¼Œ157 è¡Œ Schema  
âœ… **å¼ºå¤§çš„é…é¢ç®¡ç†ç³»ç»Ÿ** - 440 è¡Œæ ¸å¿ƒæœåŠ¡ä»£ç   
âœ… **ç±»å‹å®‰å…¨çš„ API** - 351 è¡Œç±»å‹å®šä¹‰  
âœ… **è‡ªåŠ¨åŒ–çš„åˆå§‹åŒ–è„šæœ¬** - 142 è¡Œç§å­è„šæœ¬  

**æ–°å¢ä»£ç **: ~1,352 è¡Œ  
**ä¿®æ”¹æ–‡ä»¶**: 1 ä¸ªï¼ˆschema.prismaï¼‰  
**æ–°å¢æ–‡æ¡£**: 3 ä»½  
**Git æäº¤**: å‡†å¤‡æäº¤  
**é¢„è®¡å®Œæˆåº¦**: Phase 5 Day 1 - 100% âœ…

**è®¢é˜…ç³»ç»Ÿæ•°æ®æ¨¡å‹å’Œé…é¢ä½“ç³»å·²å®Œå…¨å°±ç»ªï¼** ä¸‹ä¸€æ­¥å°†é›†æˆ Stripe æ”¯ä»˜åŠŸèƒ½ã€‚

---

**æœ€åæ›´æ–°**: Phase 5 Day 1 å®Œæˆ  
**ä¸‹ä¸€æ­¥**: Day 2-3 Stripe æ”¯ä»˜é›†æˆ  
**ç‰ˆæœ¬**: v3.0.0-phase5-day1