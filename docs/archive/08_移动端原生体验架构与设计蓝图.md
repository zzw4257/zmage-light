# 7. 移动端原生体验：架构与设计蓝图

Zmage 的移动端战略核心是提供一个**性能卓越、体验无缝、深度集成系统特性**的原生应用程序。这不仅是 Web 端的简单移植，而是一次基于移动场景的彻底重构与优化，旨在让用户的媒体库真正地"活"在他们的口袋里。

## 7.1 技术选型与架构

*   **核心框架**: **React Native**
    *   **选型理由**:
        *   **技术栈统一**: 与 Web 端的 React 生态一脉相承，可复用大量非 UI 的业务逻辑、状态管理 (Zustand stores)、类型定义 (TypeScript) 和 API 调用代码，极大地缩短开发周期。
        *   **原生性能**: 能够编译为真正的原生 UI 组件，提供接近原生应用的性能和流畅度。
        *   **强大的生态**: 拥有庞大的第三方库生态，可以轻松集成原生功能。
*   **移动端架构**: **离线优先 (Offline-First)**
    *   **设计哲学**: 移动应用必须能在网络不稳定甚至完全离线的环境下可靠运行。所有核心浏览和管理操作都应首先在本地完成，然后通过一个智能同步引擎与服务器保持最终一致。
    *   **核心组件**:
        1.  **Zmage Sync Engine (同步引擎)**: 一个在后台运行的服务，负责双向同步本地数据库与服务器端的数据。
        2.  **本地数据库 (Local Database)**: 用于持久化存储所有媒体的元数据、标签、相册关系等。
        3.  **本地文件缓存 (Local File Cache)**: 用于缓存缩略图和（可选的）原始分辨率文件。

## 7.2 核心组件与实现

*   **本地数据库**: **WatermelonDB**
    *   **选型理由**:
        *   **专为 React Native 打造**: 提供响应式的、可观察的查询，当数据变化时，UI 会自动更新，完美契合 React 的声明式编程模型。
        *   **高性能**: 底层基于 SQLite，为大规模数据集（数万甚至数十万条记录）进行了优化。
        *   **同步友好**: 内置了强大的同步适配器原语，与 Zmage Sync Engine 的设计理念高度契合。
*   **Zmage Sync Engine (同步引擎)**
    *   **工作模式**:
        *   **增量同步**: 每次同步只拉取自上次同步时间点以来服务器端发生变化的数据 (Last Pulled At 机制)，并推送本地发生变化的数据。
        *   **冲突解决**: 采用"最后写入者获胜 (Last Write Wins)"的策略处理数据冲突，或为特定数据设计更复杂的合并逻辑。
        *   **后台执行**: 利用 `react-native-background-task` 等库，即使在应用退到后台时，也能在系统允许的条件下（如设备充电、连接Wi-Fi）定期执行同步。
*   **文件缓存**: **react-native-fs & react-native-fast-image**
    *   **职责**:
        *   `react-native-fs`: 管理本地文件系统，创建缓存目录，存储下载的媒体文件。
        *   `react-native-fast-image`: 一个高性能的图片组件，提供积极的磁盘和内存缓存策略，优先从本地缓存加载图片，极大提升滚动列表的流畅度。
    *   **缓存策略**:
        *   **缩略图**: 所有媒体的缩略图在首次加载时都会被下载并永久缓存在本地。
        *   **原始文件**:
            *   **按需缓存**: 用户在全屏查看或编辑一张图片时，其原始分辨率版本才会被下载并缓存。
            *   **智能预加载**: Sync Engine 会根据用户的浏览习惯，在后台预先下载用户可能即将查看的原始文件。
            *   **缓存清理**: 系统会定期清理长时间未被访问的原始文件缓存，以节省设备存储空间，但会保留所有缩略图。

## 7.3 UI/UX: 专为移动端打造的沉浸式体验

*   **导航与布局**:
    *   **现代化底部 Tab 导航**: 提供四个核心入口："**图库**"、"**为你推荐**"、"**相册**"、"**搜索**"，符合现代移动应用的设计范式。
    *   **原生导航栈**: 使用 `React Navigation` 实现基于原生导航组件的页面切换，保证过渡动画的流畅性。
    *   **自适应照片网格**: 照片网格会根据屏幕尺寸和方向自动调整列数，并提供"日/月/年"的快速缩放手势，类似 Apple Photos。
*   **手势与交互**:
    *   **全屏沉浸式浏览**:
        *   **手势**: 支持双指捏合缩放、单指双击缩放、左右滑动切换、向下滑动关闭。
        *   **信息面板**: 向上轻扫可拉出包含详细 EXIF、地图和标签信息的面板。
    *   **多选操作**:
        *   **长按触发**: 在照片网格中长按任意一张照片即可进入多选模式。
        *   **滑动选择**: 进入多选模式后，手指在网格上滑动即可快速选择连续范围的照片。
    *   **上下文菜单**: 长按照片、相册等元素会弹出原生风格的上下文菜单 (Context Menu)，提供常用操作的快捷入口。
*   **性能优化**:
    *   **虚拟化长列表**: 使用 **`FlashList`** (by Shopify) 作为所有长列表（如图库、相册内容）的渲染组件，它只渲染当前可见的item，确保即使在包含数万张照片的图库中，滚动依然如丝般顺滑。
    *   **占位符与渐进式加载**: 在图片加载时，首先显示一个低分辨率的模糊占位符 (BlurHash)，然后渐进式地加载更高清的版本，提升感知性能。
    *   **交互线程优化**: 使用 `react-native-reanimated` 和 `react-native-gesture-handler`，确保所有动画和手势处理都在原生 UI 线程上运行，避免了因 JS 线程阻塞造成的卡顿。

## 7.4 深度系统集成

*   **后台自动上传**:
    *   **触发条件**: 用户可在设置中开启此功能。当应用在后台、设备连接到 Wi-Fi 且正在充电时，Sync Engine 会自动扫描系统相册，并将新拍摄的照片和视频增量上传到 Zmage 服务器。
    *   **用户控制**: 提供精细的控制选项，如"仅上传特定相册"、"是否上传视频"、"是否使用蜂窝数据"等。
*   **原生分享菜单**:
    *   **接收分享**: Zmage 会注册为系统分享菜单的目标应用。用户可以在任何其他 App 中（如浏览器、社交媒体），将图片或视频通过系统分享菜单直接"分享"到 Zmage，触发导入流程。
    *   **对外分享**: Zmage 内的分享功能会调用原生分享面板，用户可以轻松地将照片分享到微信、Instagram 或任何其他已安装的应用。
*   **小组件 (Widgets) - iOS & Android**:
    *   (规划) 提供多种尺寸的桌面小组件，可以展示：
        *   **"那年今日"**: 自动展示历史上的今天拍摄的照片。
        *   **"精选回忆"**: 轮播由 AI 智能策展的"回忆"影集。
        *   **"最近项目"**: 快速访问最近查看或编辑的照片。
*   **通知 (Push Notifications)**:
    *   **任务完成**: 当后台上传、AI 分析或视频转码等长时间任务完成后，发送推送通知提醒用户。
    *   **协作提醒**: 在协作相册中，当有新照片被添加或收到新评论时，发送通知。
    *   **智能提醒**: AI 策展的"新回忆"生成时，发送通知邀请用户查看。
*   **Spotlight / Android App Search 集成**:
    *   (规划) 将 Zmage 图库中的元数据（如标题、标签、识别的文本）索引到系统级别的搜索中。用户在系统主屏幕下拉搜索时，可以直接搜到 Zmage 内部的照片，并一键跳转到应用内查看。