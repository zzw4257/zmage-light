# Zmage - B/S ä½“ç³»è½¯ä»¶è®¾è®¡è¯¾ç¨‹å¤§ä½œä¸šå®éªŒæŠ¥å‘Š - Bç‰ˆæœ¬

<left>
  <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè¯¾ç¨‹åç§°ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbsp B/S ä½“ç³»è½¯ä»¶è®¾è®¡&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒåç§°ï¼š<u>&nbsp&nbsp&nbsp Zmage B Lite&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå§“&nbsp&nbsp&nbsp&nbspåï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbsp å‘¨å­ä¸º&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦&nbsp&nbsp&nbsp&nbspé™¢ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbspè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯å­¦é™¢&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspç³»ï¼š</font><font face="æ¥·ä½“" size = 5><u>&nbsp&nbsp&nbspè®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯ç³»&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspä¸“&nbsp&nbsp&nbsp&nbspä¸šï¼š<u>&nbsp&nbsp&nbspä¿¡æ¯å®‰å…¨&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
      &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦&nbsp&nbsp&nbsp&nbspå·ï¼š<u>&nbsp&nbsp&nbsp3230106267&nbsp&nbsp&nbsp</u>
  </font><br/><br/>
    <font face="æ¥·ä½“" size = 5>
     &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspæŒ‡å¯¼æ•™å¸ˆï¼šèƒ¡æ™“å†›<u>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp</u>
  </font><br/><br/><br/>
    <center><font face="é»‘ä½“" size = 5>
    æŠ¥å‘Šæ—¥æœŸ: 2026å¹´1æœˆ5æ—¥
  </font>
</left>
<div STYLE="page-break-after: always;"></div>

<center>
    <font face="é»‘ä½“" size=5>
        <b>æµ™æ±Ÿå¤§å­¦å®éªŒæŠ¥å‘Š</b>
    </font><br/>
<br/><br/></center>
<left>  
    <font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspè¯¾ç¨‹åç§°ï¼š<u>&nbsp&nbsp&nbsp&nbsp B/S ä½“ç³»è½¯ä»¶è®¾è®¡ &nbsp&nbsp&nbsp</u>å®éªŒç±»å‹:<u>&nbsp&nbsp&nbsp&nbspç¼–ç¨‹å®éªŒ&nbsp&nbsp&nbsp</u>
        </font><br/><br/>
    <font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒé¡¹ç›®åç§°:<u>&nbsp&nbsp&nbsp&nbsp Zmage - 
 B&nbsp&nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå­¦ç”Ÿå§“å:<u>&nbsp&nbsp  å‘¨å­ä¸º  &nbsp</u>ä¸“ä¸š: <u>&nbsp&nbsp ä¿¡æ¯å®‰å…¨&nbsp&nbsp</u>å­¦å·: <u>&nbsp&nbsp 3230106267 &nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspåŒç»„å­¦ç”Ÿå§“å:<u>&nbsp&nbsp&nbsp&nbsp  æ—   &nbsp&nbsp&nbsp</u>æŒ‡å¯¼è€å¸ˆ: <u>&nbsp&nbsp&nbsp&nbspèƒ¡æ™“å†›&nbsp&nbsp&nbsp&nbsp</u>
        </font><br/><br/><font face="é»‘ä½“" size=4>
         &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspå®éªŒåœ°ç‚¹:<u>&nbsp&nbsp&nbsp çº¿ä¸Š/å¯å®¤ &nbsp&nbsp&nbsp</u>å®éªŒæ—¥æœŸ: <u>&nbsp&nbsp 2026å¹´1æœˆ6æ—¥&nbsp&nbsp</u>
    </font><br/></left>


---

## ç›®å½•

1. [è¶…è¶Šè¯¾ç¨‹æ ‡å‡†çš„åŠŸèƒ½äº®ç‚¹](#1-è¶…è¶Šè¯¾ç¨‹æ ‡å‡†çš„åŠŸèƒ½äº®ç‚¹)
2. [é¡¹ç›®æ¦‚è¿°](#2-é¡¹ç›®æ¦‚è¿°)
3. [éœ€æ±‚åˆ†æ](#3-éœ€æ±‚åˆ†æ)
4. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#4-ç³»ç»Ÿæ¶æ„è®¾è®¡)
5. [åŸºæœ¬åŠŸèƒ½å®ç°](#5-åŸºæœ¬åŠŸèƒ½å®ç°)
6. [å¢å¼ºåŠŸèƒ½å®ç°](#6-å¢å¼ºåŠŸèƒ½å®ç°)
7. [æŠ€æœ¯é€‰å‹ä¸å®ç°ç»†èŠ‚](#7-æŠ€æœ¯é€‰å‹ä¸å®ç°ç»†èŠ‚)
8. [æ•°æ®åº“è®¾è®¡](#8-æ•°æ®åº“è®¾è®¡)
9. [å‰ç«¯ç•Œé¢è®¾è®¡](#9-å‰ç«¯ç•Œé¢è®¾è®¡)
10. [API æ¥å£è®¾è®¡](#10-api-æ¥å£è®¾è®¡)
11. [AI åŠŸèƒ½å®ç°](#11-ai-åŠŸèƒ½å®ç°)
12. [éƒ¨ç½²ä¸è¿ç»´](#12-éƒ¨ç½²ä¸è¿ç»´)
13. [æµ‹è¯•æŠ¥å‘Š](#13-æµ‹è¯•æŠ¥å‘Š)
14. [ä½¿ç”¨æ‰‹å†Œ](#14-ä½¿ç”¨æ‰‹å†Œ)
15. [å¼€å‘ä½“ä¼šä¸æ€»ç»“](#15-å¼€å‘ä½“ä¼šä¸æ€»ç»“)
16. [å‚è€ƒæ–‡çŒ®](#16-å‚è€ƒæ–‡çŒ®)
17. [é™„å½•](#é™„å½•)(git log è§è¿™é‡Œ)

## âš ï¸é‡è¦è¯´æ˜ï¼ˆæäº¤æ—¶å¿…è¯»ï¼‰

### ğŸ“¦ ç¯å¢ƒé…ç½®æ–‡ä»¶è¯´æ˜

**æäº¤å†…å®¹**ï¼š
- âœ… æœ¬æŠ¥å‘Šæäº¤æ—¶ï¼Œ**å·²é™„å¸¦å®Œæ•´çš„ `.env` ç¯å¢ƒé…ç½®æ–‡ä»¶**(å…±ç”¨äºA,Bç‰ˆæœ¬å‘¢)
- âœ… è¯¥æ–‡ä»¶åŒ…å«ç³»ç»Ÿè¿è¡Œæ‰€éœ€çš„æ‰€æœ‰é…ç½®å‚æ•°å’Œ API å¯†é’¥
- âœ… **æ— éœ€æ‰‹åŠ¨é…ç½®**ï¼Œç›´æ¥ä½¿ç”¨å³å¯

**å¦‚ä½•è·å– `.env` æ–‡ä»¶**ï¼š

æäº¤çš„å‹ç¼©åŒ…ä¸­å·²åŒ…å« `.env` æ–‡ä»¶ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ç¡®è®¤ï¼š

```bash
# 1. è§£å‹æäº¤çš„å‹ç¼©åŒ…
unzip zmage-submission.zip
cd zmage

# 2. ç¡®è®¤ .env æ–‡ä»¶å·²å­˜åœ¨äºé¡¹ç›®æ ¹ç›®å½•
ls -la .env

# åº”è¯¥èƒ½çœ‹åˆ° .env æ–‡ä»¶
# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜é…ç½®å·²å°±ç»ªï¼Œå¯ä»¥ç›´æ¥å¯åŠ¨ç³»ç»Ÿ
# å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æäº¤åŒ…ä¸­æ˜¯å¦æœ‰è¯¥æ–‡ä»¶ï¼Œæˆ–è”ç³»æˆ‘è·å–
```

### ğŸ”‘ API å¯†é’¥ä½¿ç”¨è¯´æ˜

**é‡è¦æç¤º**ï¼š

1. **æœ‰æ•ˆæœŸé™åˆ¶** â°ï¼š
   - æ‰€æœ‰æä¾›çš„ API å¯†é’¥æœ‰æ•ˆæœŸè‡³ **2026å¹´1æœˆ20æ—¥**
   - è¯·åœ¨æœ‰æ•ˆæœŸå†…å®Œæˆæµ‹è¯•å’Œè¯„ä¼°
   - è¿‡æœŸåå°†æ— æ³•æ­£å¸¸ä½¿ç”¨ AI ç›¸å…³åŠŸèƒ½

2. **Gemini API å¯†é’¥** ğŸ’°ï¼š
   - å·²é…ç½® `GEMINI_API_KEY`ï¼Œæä¾› **5 ç¾å…ƒ**çš„ API è°ƒç”¨é¢åº¦
   - è¯¥é¢åº¦è¶³ä»¥å®Œæˆç³»ç»Ÿçš„å®Œæ•´åŠŸèƒ½æ¼”ç¤ºå’Œæµ‹è¯•
   - **è¯·é…Œæƒ…ä½¿ç”¨**ï¼Œé¿å…ä¸å¿…è¦çš„ API è°ƒç”¨
   - å»ºè®®ä¼˜å…ˆæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼ŒAI åŠŸèƒ½æµ‹è¯•æ—¶ä½¿ç”¨å°‘é‡å›¾ç‰‡å³å¯

3. **å…¶ä»– API å¯†é’¥** âš ï¸ï¼š
   - éƒ¨åˆ† API å¯†é’¥å› æŠ€æœ¯é™åˆ¶**æ— æ³•åˆ é™¤æˆ–è®¾ç½®ä½¿ç”¨é™é¢**
   - **è¯·ä»…ç”¨äºæœ¬è¯¾ç¨‹çš„æµ‹è¯•å’Œè¯„ä¼°ï¼Œä¸è¦ç”¨äºå…¶ä»–ç”¨é€”**
   - æµ‹è¯•å®Œæˆåå»ºè®®å¿½ç•¥æˆ–åˆ é™¤ç›¸å…³å¯†é’¥
   - **ä½¿ç”¨é£é™©éœ€è‡ªè¡Œæ‰¿æ‹…**

4. **ä½¿ç”¨å»ºè®®** ğŸ’¡ï¼š
   - ä¼˜å…ˆæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¸Šä¼ ã€æµè§ˆã€æœç´¢ã€ç¼–è¾‘ï¼‰
   - AI åŠŸèƒ½æµ‹è¯•æ—¶å»ºè®®ä½¿ç”¨ 3-5 å¼ å›¾ç‰‡éªŒè¯å³å¯
   - é¿å…å¤§é‡é‡å¤æµ‹è¯•ï¼Œå¯èƒ½å¯¼è‡´ API è°ƒç”¨è¶…é™
   - å»ºè®®ä½¿ç”¨ `test_media/` æ–‡ä»¶å¤¹ä¸­çš„æµ‹è¯•å›¾ç‰‡

### ğŸš€ å¿«é€Ÿå¯åŠ¨æŒ‡å—

**å¯åŠ¨æ­¥éª¤**ï¼š

```bash
# 1. ç¡®è®¤å·²è§£å‹é¡¹ç›®æ–‡ä»¶ï¼Œ.env æ–‡ä»¶å·²å­˜åœ¨
cd zmage
ls -la .env  # ç¡®è®¤æ–‡ä»¶å­˜åœ¨

# 2. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆè‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»ï¼‰
docker compose up -d

# 3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆç¡®è®¤æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼‰
docker compose logs -f

# 4. è®¿é—®ç³»ç»Ÿ
# å‰ç«¯ç•Œé¢ï¼šhttp://localhost:32333
# API æ–‡æ¡£ï¼šhttp://localhost:34257/docs
```

**é¦–æ¬¡ä½¿ç”¨**ï¼š
1. è®¿é—® http://localhost:32333
2. ç‚¹å‡»"æ³¨å†Œ"åˆ›å»ºè´¦å·ï¼ˆç”¨æˆ·å >= 6å­—ç¬¦ï¼Œå¯†ç  >= 6å­—ç¬¦ï¼‰
3. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•ï¼Œå¼€å§‹ä½“éªŒç³»ç»Ÿ

**æµ‹è¯•å»ºè®®**ï¼š
- ä½¿ç”¨ `test_media/` æ–‡ä»¶å¤¹ä¸­çš„æµ‹è¯•å›¾ç‰‡
- å…ˆæµ‹è¯•åŸºç¡€åŠŸèƒ½ï¼Œå†æµ‹è¯• AI åŠŸèƒ½
- AI åŠŸèƒ½æµ‹è¯•æ—¶å»ºè®®ä¸Šä¼  3-5 å¼ å›¾ç‰‡å³å¯

---

## 1. è¶…è¶Šè¯¾ç¨‹æ ‡å‡†çš„åŠŸèƒ½äº®ç‚¹

> æœ¬èŠ‚é‡ç‚¹è¯´æ˜æœ¬é¡¹ç›®åœ¨æ»¡è¶³è¯¾ç¨‹åŸºæœ¬è¦æ±‚çš„åŸºç¡€ä¸Šï¼Œå®ç°çš„è¶…è¶Šæ€§åŠŸèƒ½å’ŒæŠ€æœ¯äº®ç‚¹ã€‚

### 1.1 æ¶æ„å±‚é¢çš„è¶…è¶Š

#### 1.1.1 å¾®æœåŠ¡åŒ–æ¶æ„è®¾è®¡

Zmage é‡‡ç”¨**å‰åç«¯åˆ†ç¦» + ç‹¬ç«‹ Worker æœåŠ¡**çš„ç°ä»£åŒ–å¾®æœåŠ¡æ¶æ„ï¼Œç›¸æ¯”è¯¾ç¨‹è¦æ±‚çš„å•ä½“åº”ç”¨ï¼Œå®ç°äº†æ›´æ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œæ›´é«˜çš„å¯æ‰©å±•æ€§ã€‚

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A1[æµè§ˆå™¨ Web UI  Next.js 16]
        A2[ç§»åŠ¨ç«¯æµè§ˆå™¨  å“åº”å¼é€‚é…]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚"
        B1[FastAPI åç«¯  ç«¯å£ 34257]
        B2[Worker åå°ä»»åŠ¡  å¼‚æ­¥å¤„ç†]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚"
        C1[(PostgreSQL  ä¸šåŠ¡æ•°æ®)]
        C2[(Qdrant  å‘é‡æ£€ç´¢)]
        C3[(Redis  ç¼“å­˜+é˜Ÿåˆ—)]
        C4[(MinIO  å¯¹è±¡å­˜å‚¨)]
    end

    subgraph "å¤–éƒ¨æœåŠ¡"
        D1[Google Gemini  AI èƒ½åŠ›]
    end

    A1 -->|HTTP/WebSocket| B1
    A2 -->|HTTP| B1
    B1 -->|è¯»å†™| C1
    B1 -->|å‘é‡æ£€ç´¢| C2
    B1 -->|ç¼“å­˜| C3
    B1 -->|æ–‡ä»¶å­˜å‚¨| C4
    B2 -->|ä»»åŠ¡é˜Ÿåˆ—| C3
    B2 -->|AI è°ƒç”¨| D1
    B2 -->|æ‰¹é‡å¤„ç†| C1
    B2 -->|å‘é‡ç”Ÿæˆ| C2

    style B1 fill:#3b82f6
    style B2 fill:#10b981
    style C1 fill:#8b5cf6
    style C2 fill:#f59e0b
    style C3 fill:#ef4444
    style C4 fill:#06b6d4
```

**æ¶æ„ä¼˜åŠ¿**ï¼š

1. **èŒè´£æ¸…æ™°**ï¼šWeb æœåŠ¡ä¸“æ³¨ API å“åº”ï¼ŒWorker ä¸“æ³¨è€—æ—¶ä»»åŠ¡ï¼Œäº’ä¸å¹²æ‰°
2. **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥æ ¹æ®è´Ÿè½½ç‹¬ç«‹æ‰©å±• Web æˆ– Worker æœåŠ¡
3. **å®¹é”™æ€§**ï¼šWorker æœåŠ¡æ•…éšœä¸å½±å“ API æœåŠ¡ï¼Œä¿è¯åŸºæœ¬åŠŸèƒ½å¯ç”¨

#### 1.1.2 å¤šæ•°æ®åº“ååŒæ–¹æ¡ˆ

ä¸åŒäºè¯¾ç¨‹è¦æ±‚çš„å•ä¸€æ•°æ®åº“ï¼ˆMySQL æˆ– SQLiteï¼‰ï¼ŒZmage é‡‡ç”¨**å¤šæ•°æ®åº“ååŒ**æ–¹æ¡ˆï¼Œæ¯ä¸ªæ•°æ®åº“å‘æŒ¥å…¶ä¸“é•¿ï¼š

| æ•°æ®åº“ | ç”¨é€” | ä¼˜åŠ¿ |
|--------|------|------|
| PostgreSQL | ä¸šåŠ¡æ•°æ®ï¼ˆç”¨æˆ·ã€èµ„äº§ã€ç›¸å†Œã€æ ‡ç­¾ç­‰ï¼‰ | ACID ä¿è¯ã€å¤æ‚æŸ¥è¯¢ã€å…³ç³»å®Œæ•´æ€§ |
| Qdrant | å‘é‡æ£€ç´¢ï¼ˆè¯­ä¹‰æœç´¢ã€ç›¸ä¼¼æ¨èï¼‰ | é«˜æ€§èƒ½å‘é‡ç›¸ä¼¼åº¦è®¡ç®—ã€æ”¯æŒç™¾ä¸‡çº§å‘é‡ |
| Redis | ç¼“å­˜ + ä»»åŠ¡é˜Ÿåˆ— | ä½å»¶è¿Ÿç¼“å­˜ã€å¯é çš„æ¶ˆæ¯é˜Ÿåˆ— |
| MinIO | å¯¹è±¡å­˜å‚¨ï¼ˆåŸå§‹æ–‡ä»¶ã€ç¼©ç•¥å›¾ï¼‰ | S3 å…¼å®¹ã€åˆ†å¸ƒå¼å­˜å‚¨ã€é«˜å¯ç”¨ |

**æ•°æ®æµè½¬ç¤ºæ„**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·ä¸Šä¼ 
    participant API as FastAPI
    participant PG as PostgreSQL
    participant M as MinIO
    participant Q as Qdrant
    participant W as Worker
    participant G as Gemini AI

    U->>API: ä¸Šä¼ å›¾ç‰‡
    API->>M: å­˜å‚¨åŸå§‹æ–‡ä»¶
    API->>PG: åˆ›å»ºèµ„äº§è®°å½•(status=pending)
    API->>W: å‘é€å¤„ç†ä»»åŠ¡åˆ°é˜Ÿåˆ—
    API-->>U: è¿”å›ä¸Šä¼ æˆåŠŸ

    W->>M: ä¸‹è½½åŸå§‹æ–‡ä»¶
    W->>W: ç”Ÿæˆç¼©ç•¥å›¾
    W->>M: å­˜å‚¨ç¼©ç•¥å›¾
    W->>PG: æå–EXIFä¿¡æ¯
    W->>PG: æ›´æ–°èµ„äº§è®°å½•
    W->>G: è°ƒç”¨AIåˆ†æ
    G-->>W: è¿”å›æ ‡ç­¾/æè¿°
    W->>PG: ä¿å­˜AIåˆ†æç»“æœ
    W->>G: ç”Ÿæˆå‘é‡åµŒå…¥
    G-->>W: è¿”å›768ç»´å‘é‡
    W->>Q: å­˜å‚¨å‘é‡
    W->>PG: æ›´æ–°çŠ¶æ€ä¸ºready
```

#### 1.1.3 Docker Compose ä¸€é”®éƒ¨ç½²

æä¾›å®Œæ•´çš„å®¹å™¨åŒ–éƒ¨ç½²æ–¹æ¡ˆï¼Œç¡®ä¿åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½èƒ½ä¸€è‡´è¿è¡Œï¼š

```yaml
# docker-compose.yml æ ¸å¿ƒé…ç½®
services:
  img-lib-postgres:    # PostgreSQL æ•°æ®åº“
  img-lib-redis:       # Redis ç¼“å­˜
  img-lib-qdrant:      # Qdrant å‘é‡æ•°æ®åº“
  img-lib-minio:       # MinIO å¯¹è±¡å­˜å‚¨
  img-lib-api:         # FastAPI åç«¯æœåŠ¡
  img-lib-worker:      # Worker åå°ä»»åŠ¡æœåŠ¡
  img-lib-web:         # Next.js å‰ç«¯æœåŠ¡
```

**ä¸€é”®å¯åŠ¨å‘½ä»¤**ï¼š
```bash
docker compose up -d
```

å¯åŠ¨åå³å¯è®¿é—®ï¼š
- å‰ç«¯ç•Œé¢ï¼šhttp://localhost:32333
- API æ–‡æ¡£ï¼šhttp://localhost:34257/docs
- MinIO æ§åˆ¶å°ï¼šhttp://localhost:30901

### 1.2 åŠŸèƒ½å±‚é¢çš„è¶…è¶Š

#### 1.2.1 å¼ºå¤§çš„æ‰¹é‡æ“ä½œç³»ç»Ÿ

è¯¾ç¨‹è¦æ±‚ä»…éœ€æ”¯æŒ"åˆ é™¤åŠŸèƒ½"ï¼ŒZmage å®ç°äº†**ä¸“ä¸šçº§çš„æ‰¹é‡æ“ä½œä½“ç³»**ï¼ŒåŒ…æ‹¬æ‰¹é‡é€‰æ‹©ã€æ‰¹é‡ç®¡ç†å’Œæ‰¹é‡å¤„ç†ã€‚

**æ‰¹é‡é€‰æ‹©æœºåˆ¶**ï¼š

```typescript:apps/web/src/components/asset/asset-grid.tsx
// æ”¯æŒå¤šç§é€‰æ‹©æ–¹å¼
const handleAssetClick = (asset: Asset, index: number, e: React.MouseEvent) => {
  // 1. Shift + ç‚¹å‡»ï¼šèŒƒå›´é€‰æ‹©
  if (e.shiftKey && lastSelectedIndex !== null) {
    const start = Math.min(lastSelectedIndex, index);
    const end = Math.max(lastSelectedIndex, index);
    const rangeIds = assets.slice(start, end + 1).map(a => a.id);
    setSelectedAssets(Array.from(new Set([...selectedAssets, ...rangeIds])));
    return;
  }

  // 2. Ctrl/Cmd + Aï¼šå…¨é€‰
  if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
    const allIds = assets.map(a => a.id);
    setSelectedAssets(allIds);
    setBatchMode(true);
  }

  // 3. å¤šé€‰æ¨¡å¼ä¸‹çš„åˆ‡æ¢
  if (batchMode) {
    toggleAssetSelection(asset.id);
  }
};
```

**æ‰¹é‡æ“ä½œåŠŸèƒ½æ¸…å•**ï¼š

| æ“ä½œç±»å‹ | åŠŸèƒ½ | å®ç°æ–¹å¼ |
|---------|------|---------|
| æ‰¹é‡åˆ é™¤ | ä¸€æ¬¡æ€§åˆ é™¤å¤šå¼ å›¾ç‰‡ | è°ƒç”¨æ‰¹é‡åˆ é™¤ API |
| æ‰¹é‡æ·»åŠ åˆ°ç›¸å†Œ | å¿«é€Ÿåˆ›å»ºæˆ–æ·»åŠ åˆ°ç›¸å†Œ | å‰ç«¯é€‰æ‹© + API æ‰¹é‡å…³è” |
| æ‰¹é‡ä¸‹è½½ | æ‰“åŒ…ä¸º ZIP æ–‡ä»¶ | åç«¯ç”Ÿæˆ ZIP æµ |
| æ‰¹é‡æ ‡ç­¾ | ä¸ºå¤šå¼ å›¾ç‰‡æ·»åŠ æ ‡ç­¾ | æ‰¹é‡æ›´æ–°æ ‡ç­¾æ•°ç»„ |
| æ‰¹é‡ç§»åŠ¨åˆ°ä¿é™©åº“ | ä¿æŠ¤éšç§å›¾ç‰‡ | æ‰¹é‡æ›´æ–° `is_private` å­—æ®µ |
| æ‰¹é‡åˆ†äº« | æ‰¹é‡å¼€å¯/å…³é—­åˆ†äº« | æ‰¹é‡åˆ›å»º/åˆ é™¤åˆ†äº«é“¾æ¥ |

**æ‰¹é‡æ“ä½œ UI å±•ç¤º**ï¼š

```typescript:apps/web/src/components/asset/batch-actions.tsx
export function BatchActions({ onDelete, onShare }: BatchActionsProps) {
  const { selectedAssets, clearSelection } = useAppStore();
  
  // æ‰¹é‡ä¸‹è½½
  const handleDownload = async () => {
    const response = await downloadsApi.downloadBatch(selectedAssets);
    const blob = new Blob([response.data], { type: "application/zip" });
    // è§¦å‘æµè§ˆå™¨ä¸‹è½½
  };
  
  // æ‰¹é‡åˆ›å»ºç›¸å†Œ
  const handleCreateAlbum = async () => {
    await albumsApi.create({
      name: albumName,
      asset_ids: selectedAssets, // æ‰¹é‡å…³è”
    });
  };
  
  return (
    <AnimatePresence>
      {selectedAssets.length > 0 && (
        <motion.div
          initial={{ y: 100, opacity: 0 }}
          animate={{ y: 0, opacity: 1 }}
          className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50"
        >
          {/* æµ®åŠ¨æ“ä½œæ  */}
          <div className="bg-background/95 backdrop-blur-md rounded-2xl shadow-2xl">
            <span>å·²é€‰æ‹© {selectedAssets.length} é¡¹</span>
            {/* æ“ä½œæŒ‰é’®ç»„ */}
          </div>
        </motion.div>
      )}
    </AnimatePresence>
  );
}
```

**ç”¨æˆ·äº¤äº’æµç¨‹**ï¼š

```mermaid
stateDiagram-v2
    [*] --> æµè§ˆæ¨¡å¼
    æµè§ˆæ¨¡å¼ --> å¤šé€‰æ¨¡å¼: ç‚¹å‡»å¤šé€‰æŒ‰é’® / Ctrl+Shift+A
    å¤šé€‰æ¨¡å¼ --> é€‰æ‹©ä¸­: ç‚¹å‡»å›¾ç‰‡å¡ç‰‡
    é€‰æ‹©ä¸­ --> é€‰æ‹©ä¸­: Shift+ç‚¹å‡»(èŒƒå›´) / Ctrl+A(å…¨é€‰)
    é€‰æ‹©ä¸­ --> æ‰¹é‡æ“ä½œ: ç‚¹å‡»æ“ä½œæŒ‰é’®
    æ‰¹é‡æ“ä½œ --> å¤„ç†ä¸­: è°ƒç”¨API
    å¤„ç†ä¸­ --> å®Œæˆ: æ“ä½œæˆåŠŸ
    å®Œæˆ --> æµè§ˆæ¨¡å¼: æ¸…ç©ºé€‰æ‹© / ESC
    å¤šé€‰æ¨¡å¼ --> æµè§ˆæ¨¡å¼: ESC / å®ŒæˆæŒ‰é’®
```

#### 1.2.2 æ™ºèƒ½ç›¸å†Œç³»ç»Ÿ

è¯¾ç¨‹è¦æ±‚æ”¯æŒ"åˆ†ç±»æ ‡ç­¾"ï¼ŒZmage åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†**æ™ºèƒ½ç›¸å†Œç³»ç»Ÿ**ï¼Œæ”¯æŒæ‰‹åŠ¨ç›¸å†Œã€æ™ºèƒ½ç›¸å†Œå’Œ AI å»ºè®®ç›¸å†Œä¸‰ç§æ¨¡å¼ã€‚

**æ™ºèƒ½ç›¸å†Œè§„åˆ™å¼•æ“**ï¼š

```python:apps/api/src/models/album.py
class AlbumType(str, enum.Enum):
    MANUAL = "manual"      # æ‰‹åŠ¨ç›¸å†Œï¼šç”¨æˆ·æ‰‹åŠ¨æ·»åŠ 
    SMART = "smart"        # æ™ºèƒ½ç›¸å†Œï¼šåŸºäºè§„åˆ™åŠ¨æ€èšåˆ
    SUGGESTED = "suggested" # AI å»ºè®®ï¼šå¾…ç”¨æˆ·å®¡æ ¸

class Album(Base):
    smart_rules: Mapped[Optional[dict]] = mapped_column(JSON, nullable=True)
    # è§„åˆ™ç¤ºä¾‹ï¼š
    # {
    #   "time_range": {"start": "2024-01-01", "end": "2024-12-31"},
    #   "tags": ["æ—…è¡Œ", "é£æ™¯"],
    #   "location": {"latitude": 30.0, "longitude": 120.0, "radius_km": 50},
    #   "camera_model": "iPhone 15 Pro"
    # }
```

**æ™ºèƒ½ç›¸å†Œè¯„ä¼°ç®—æ³•**ï¼š

```python:apps/api/src/services/album.py
async def evaluate_smart_album(
    self, db: AsyncSession, album_id: int, user_id: int
) -> List[Asset]:
    """æ ¹æ®æ™ºèƒ½ç›¸å†Œè§„åˆ™åŠ¨æ€è¯„ä¼°åŒ¹é…çš„èµ„äº§"""
    album = await db.get(Album, album_id)
    if not album or album.album_type != AlbumType.SMART:
        return []
    
    rules = album.smart_rules or {}
    query = select(Asset).where(
        Asset.user_id == user_id,
        Asset.deleted_at.is_(None),
        Asset.status == AssetStatus.READY
    )
    
    # æ—¶é—´èŒƒå›´è¿‡æ»¤
    if "time_range" in rules:
        tr = rules["time_range"]
        if tr.get("start"):
            query = query.where(Asset.taken_at >= tr["start"])
        if tr.get("end"):
            query = query.where(Asset.taken_at <= tr["end"])
    
    # æ ‡ç­¾è¿‡æ»¤
    if "tags" in rules:
        for tag in rules["tags"]:
            query = query.where(Asset.tags.contains([tag]))
    
    # GPS ä½ç½®è¿‡æ»¤ï¼ˆåŠå¾„æœç´¢ï¼‰
    if "location" in rules:
        loc = rules["location"]
        # ä½¿ç”¨ PostGIS æˆ–è®¡ç®—è·ç¦»å…¬å¼
    
    result = await db.execute(query)
    return list(result.scalars().all())
```

**AI ç›¸å†Œå»ºè®®ç”Ÿæˆ**ï¼š

```python:apps/api/src/routers/tasks.py
async def generate_album_suggestions(db: AsyncSession, task: Task):
    """åå°ä»»åŠ¡ï¼šAI åˆ†æå¹¶ç”Ÿæˆç›¸å†Œå»ºè®®"""
    # 1. è·å–æœ€è¿‘æ´»è·ƒçš„èµ„äº§
    recent_assets = await get_recent_assets(db, days=30)
    
    # 2. è°ƒç”¨ Gemini AI åˆ†æ
    assets_info = [{
        "id": a.id,
        "tags": a.tags,
        "taken_at": str(a.taken_at),
        "location": a.location,
        "description": a.description
    } for a in recent_assets]
    
    # 3. AI ç”Ÿæˆå»ºè®®
    suggestions = await gemini_service.suggest_albums(assets_info, existing_albums)
    
    # 4. åˆ›å»ºå»ºè®®ç›¸å†Œï¼ˆstatus=pendingï¼‰
    for suggestion in suggestions:
        album = Album(
            name=suggestion["title"],
            description=suggestion["reason"],
            album_type=AlbumType.SUGGESTED,
            status=AlbumStatus.PENDING,
            smart_rules=suggestion["rules"],
            user_id=task.user_id
        )
        db.add(album)
    
    await db.commit()
```

**æ™ºèƒ½ç›¸å†Œå·¥ä½œæµç¨‹**ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·åˆ›å»ºæ™ºèƒ½ç›¸å†Œ] --> B[å®šä¹‰è§„åˆ™  æ—¶é—´/æ ‡ç­¾/åœ°ç‚¹/è®¾å¤‡]
    B --> C[ä¿å­˜è§„åˆ™åˆ°æ•°æ®åº“]
    C --> D[ç”¨æˆ·è®¿é—®ç›¸å†Œ]
    D --> E[åç«¯è¯„ä¼°è§„åˆ™]
    E --> F[åŠ¨æ€æŸ¥è¯¢åŒ¹é…èµ„äº§]
    F --> G[å®æ—¶è¿”å›ç»“æœ]
    
    H[åå°ä»»åŠ¡  æ¯6å°æ—¶] --> I[æ‰«ææœ€è¿‘èµ„äº§]
    I --> J[AIåˆ†æèµ„äº§ç‰¹å¾]
    J --> K[ç”Ÿæˆç›¸å†Œå»ºè®®]
    K --> L[åˆ›å»ºå»ºè®®ç›¸å†Œ  status=pending]
    L --> M[ç”¨æˆ·å®¡æ ¸]
    M -->|æ¥å—| N[è½¬æ¢ä¸ºæ‰‹åŠ¨/æ™ºèƒ½ç›¸å†Œ]
    M -->|å¿½ç•¥| O[åˆ é™¤å»ºè®®]
    
    style E fill:#3b82f6
    style J fill:#10b981
    style M fill:#f59e0b
```

#### 1.2.3 è¯­ä¹‰æœç´¢ä¸å‘é‡æ£€ç´¢

è¯¾ç¨‹è¦æ±‚çš„å¢å¼ºåŠŸèƒ½æ˜¯"AI åˆ†æå›¾ç‰‡æä¾›æ ‡ç­¾"ï¼ŒZmage åœ¨æ­¤åŸºç¡€ä¸Šå®ç°äº†**è¯­ä¹‰æœç´¢**å’Œ**è§†è§‰ç›¸ä¼¼æ€§æœç´¢**ã€‚

**å‘é‡æ£€ç´¢æ¶æ„**ï¼š

```mermaid
graph LR
    A[ç”¨æˆ·æŸ¥è¯¢] --> B{æŸ¥è¯¢ç±»å‹}
    B -->|å…³é”®è¯æœç´¢| C[PostgreSQLå…¨æ–‡æ£€ç´¢]
    B -->|è¯­ä¹‰æœç´¢| D[Geminiç”Ÿæˆå‘é‡]
    B -->|ä»¥å›¾æœå›¾| E[æå–å›¾ç‰‡å‘é‡]
    
    D --> F[Qdrantå‘é‡æ£€ç´¢]
    E --> F
    F --> G[HNSWç®—æ³•  è¿‘ä¼¼æœ€è¿‘é‚»]
    G --> H[è¿”å›ç›¸ä¼¼èµ„äº§]
    
    C --> I[ç»“æœåˆå¹¶]
    H --> I
    I --> J[é‡æ’åº]
    J --> K[è¿”å›æœ€ç»ˆç»“æœ]
    
    style F fill:#f59e0b
    style G fill:#10b981
```

**å‘é‡ç”Ÿæˆä¸å­˜å‚¨**ï¼š

```python:apps/api/src/services/vector.py
class VectorService:
    async def upsert_vector(
        self,
        asset_id: int,
        vector: List[float],  # 768ç»´å‘é‡
        payload: Dict[str, Any],
    ) -> str:
        """å°†èµ„äº§çš„å‘é‡åµŒå…¥å­˜å‚¨åˆ° Qdrant"""
        vector_id = str(uuid.uuid4())
        
        await self.client.upsert(
            collection_name=self.collection_name,
            points=[
                PointStruct(
                    id=vector_id,
                    vector=vector,
                    payload={
                        "asset_id": asset_id,
                        "title": payload.get("title"),
                        "tags": payload.get("tags"),
                        "description": payload.get("description"),
                    },
                )
            ],
        )
        return vector_id
    
    async def search_similar(
        self,
        vector: List[float],
        limit: int = 20,
        filter_conditions: Optional[Dict[str, Any]] = None,
    ) -> List[Dict[str, Any]]:
        """åœ¨å‘é‡ç©ºé—´ä¸­æœç´¢ç›¸ä¼¼èµ„äº§"""
        results = await self.client.search(
            collection_name=self.collection_name,
            query_vector=vector,
            limit=limit,
            query_filter=build_filter(filter_conditions),
            search_params=SearchParams(hnsw_ef=128),  # HNSW ç®—æ³•å‚æ•°
        )
        return [
            {
                "asset_id": hit.payload.get("asset_id"),
                "score": hit.score,  # ä½™å¼¦ç›¸ä¼¼åº¦ (0-1)
                "payload": hit.payload,
            }
            for hit in results
        ]
```

**è¯­ä¹‰æœç´¢å®ç°**ï¼š

```python:apps/api/src/services/asset.py
async def search_assets(
    self,
    db: AsyncSession,
    request: AssetSearchRequest,
    current_user_id: int,
) -> tuple:
    """æ··åˆæœç´¢ï¼šå…³é”®è¯ + å‘é‡æ£€ç´¢"""
    
    if request.ai_search and request.query:
        # === AI è¯­ä¹‰æœç´¢ ===
        # 1. å°†æŸ¥è¯¢æ–‡æœ¬è½¬æ¢ä¸ºå‘é‡
        query_vector = await gemini_service.embed_text(request.query)
        
        # 2. åœ¨ Qdrant ä¸­æœç´¢ç›¸ä¼¼å‘é‡
        vector_results = await vector_service.search_similar(
            vector=query_vector,
            limit=request.page_size * 2,  # å¤šå¬å›ä¸€äº›ç”¨äºé‡æ’
            filter_conditions={"user_id": current_user_id},
        )
        
        # 3. è·å–èµ„äº§IDåˆ—è¡¨
        asset_ids = [r["asset_id"] for r in vector_results]
        
        # 4. ä» PostgreSQL è·å–å®Œæ•´èµ„äº§ä¿¡æ¯
        if asset_ids:
            query = select(Asset).where(
                Asset.id.in_(asset_ids),
                Asset.user_id == current_user_id,
            )
            result = await db.execute(query)
            assets = result.scalars().all()
            
            # 5. æŒ‰ç›¸ä¼¼åº¦åˆ†æ•°æ’åº
            score_map = {r["asset_id"]: r["score"] for r in vector_results}
            assets.sort(key=lambda a: score_map.get(a.id, 0), reverse=True)
            
            return assets[:request.page_size], len(assets)
    
    else:
        # === ä¼ ç»Ÿå…³é”®è¯æœç´¢ ===
        search_term = f"%{request.query}%"
        query = select(Asset).where(
            or_(
                Asset.title.ilike(search_term),
                Asset.description.ilike(search_term),
                Asset.tags.any(request.query),
                Asset.ocr_text.ilike(search_term),
            )
        )
        # ... æ‰§è¡ŒæŸ¥è¯¢
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

1. **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**ï¼š"å»å¹´å¤å¤©åœ¨æµ·è¾¹æ‹çš„æ—¥è½ç…§ç‰‡"
   - ç³»ç»Ÿç†è§£ï¼šæ—¶é—´ï¼ˆå»å¹´å¤å¤©ï¼‰+ åœ°ç‚¹ï¼ˆæµ·è¾¹ï¼‰+ ä¸»é¢˜ï¼ˆæ—¥è½ï¼‰
   - å‘é‡æ£€ç´¢è¿”å›ç›¸ä¼¼åº¦ > 0.7 çš„å›¾ç‰‡

2. **ä»¥å›¾æœå›¾**ï¼šç”¨æˆ·ä¸Šä¼ ä¸€å¼ å›¾ç‰‡
   - æå–æŸ¥è¯¢å›¾ç‰‡çš„å‘é‡ï¼ˆåŸºäº Gemini å¤šæ¨¡æ€æ¨¡å‹ï¼‰
   - åœ¨ Qdrant ä¸­æœç´¢æœ€ç›¸ä¼¼çš„å›¾ç‰‡
   - è¿”å›ç›¸ä¼¼åº¦ > 0.8 çš„ç»“æœ

#### 1.2.4 MCP æ¥å£ï¼šå¯¹è¯å¼æ£€ç´¢

è¯¾ç¨‹è¦æ±‚æä¾›"MCP æ¥å£ï¼Œèƒ½é€šè¿‡å¤§æ¨¡å‹å¯¹è¯æ–¹å¼æ£€ç´¢ç½‘ç«™ä¸Šçš„å›¾ç‰‡"ï¼ŒZmage å®ç°äº†**å®Œæ•´çš„ MCP (Model Context Protocol) å…¼å®¹æ¥å£**ã€‚

**MCP å·¥å…·å®šä¹‰**ï¼š

```python:apps/api/src/routers/mcp.py
TOOLS = [
    MCPTool(
        name="search_assets",
        description="ä½¿ç”¨è‡ªç„¶è¯­è¨€æœç´¢å›¾ç‰‡å’Œè§†é¢‘ï¼Œæ”¯æŒæŒ‰æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€ä½ç½®å’Œè§†è§‰ç‰¹å¾æ£€ç´¢ã€‚",
        input_schema={
            "type": "object",
            "properties": {
                "query": {"type": "string", "description": "æœç´¢æŸ¥è¯¢è¯"},
                "limit": {"type": "integer", "description": "è¿”å›ç»“æœæ•°é‡", "default": 10},
            },
            "required": ["query"]
        }
    ),
    MCPTool(
        name="find_similar_assets",
        description="æ ¹æ®æŒ‡å®šèµ„äº§æŸ¥æ‰¾ç›¸ä¼¼çš„å›¾ç‰‡æˆ–è§†é¢‘ã€‚",
        input_schema={
            "type": "object",
            "properties": {
                "asset_id": {"type": "integer", "description": "å‚è€ƒèµ„äº§ ID"},
                "limit": {"type": "integer", "default": 10}
            },
            "required": ["asset_id"]
        }
    ),
    # ... å…± 30+ ä¸ªå·¥å…·
]
```

**MCP å·¥å…·è°ƒç”¨**ï¼š

```python:apps/api/src/routers/mcp.py
@router.post("/call", response_model=MCPCallResponse)
async def call_tool(
    request: MCPCallRequest,
    db: AsyncSession = Depends(get_db),
    current_user = Depends(get_current_user)
):
    """æ‰§è¡Œ MCP å·¥å…·è°ƒç”¨"""
    name = request.name
    args = request.arguments
    
    if name == "search_assets":
        # ä½¿ç”¨è¯­ä¹‰æœç´¢
        search_req = AssetSearchRequest(
            query=args.get("query"),
            ai_search=True,  # å¯ç”¨ AI æœç´¢
            page_size=args.get("limit", 10),
        )
        assets, total = await asset_service.search_assets(
            db, search_req, current_user_id=current_user.id
        )
        return MCPCallResponse(
            content=[
                {"type": "text", "text": f"æ‰¾åˆ° {total} ä¸ªåŒ¹é…é¡¹"},
                {"type": "json", "data": [asset_to_response(a) for a in assets]}
            ]
        )
```

**å¯¹è¯å¼æ£€ç´¢ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: "å¸®æˆ‘æ‰¾å‡ å¼ åŒ…å«çŒ«å’ªçš„ç…§ç‰‡ï¼Œæœ€å¥½æ˜¯å®¤å†…çš„"

å¤§æ¨¡å‹è°ƒç”¨å·¥å…·:
{
  "name": "search_assets",
  "arguments": {
    "query": "å®¤å†… çŒ«å’ª",
    "limit": 5
  }
}

ç³»ç»Ÿè¿”å›:
{
  "content": [
    {
      "type": "text",
      "text": "æ‰¾åˆ° 8 ä¸ªåŒ¹é…é¡¹"
    },
    {
      "type": "json",
      "data": [
        {
          "id": 123,
          "title": "å®¶ä¸­çš„æ©˜çŒ«",
          "description": "ä¸€åªæ©˜çŒ«åœ¨æ²™å‘ä¸Šä¼‘æ¯",
          "tags": ["çŒ«å’ª", "å®¤å†…", "å® ç‰©"],
          "url": "https://..."
        },
        ...
      ]
    }
  ]
}

å¤§æ¨¡å‹å›å¤ç”¨æˆ·:
"æˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº† 8 å¼ åŒ…å«çŒ«å’ªçš„å®¤å†…ç…§ç‰‡ã€‚ç¬¬ä¸€å¼ æ˜¯'å®¶ä¸­çš„æ©˜çŒ«'ï¼Œæè¿°ä¸º'ä¸€åªæ©˜çŒ«åœ¨æ²™å‘ä¸Šä¼‘æ¯'ã€‚éœ€è¦æˆ‘å¸®æ‚¨æŸ¥çœ‹è¯¦æƒ…æˆ–è¿›è¡Œå…¶ä»–æ“ä½œå—ï¼Ÿ"
```

#### 1.2.5 ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ

è¯¾ç¨‹è¦æ±‚"ç®€å•çš„ç¼–è¾‘åŠŸèƒ½"ï¼ŒZmage å®ç°äº†**å®Œæ•´çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ**ï¼Œæ”¯æŒç¼–è¾‘å†å²è¿½è¸ªå’Œç‰ˆæœ¬å›é€€ã€‚

**ç‰ˆæœ¬æ§åˆ¶æ•°æ®æ¨¡å‹**ï¼š

```python:apps/api/src/models/asset.py
class AssetVersion(Base):
    """èµ„äº§ç‰ˆæœ¬è¡¨"""
    id: Mapped[int] = mapped_column(Integer, primary_key=True)
    asset_id: Mapped[int] = mapped_column(Integer, ForeignKey("assets.id"))
    version_number: Mapped[int] = mapped_column(Integer)  # ç‰ˆæœ¬å·
    file_path: Mapped[str] = mapped_column(String(512))   # ç‰ˆæœ¬æ–‡ä»¶è·¯å¾„
    file_size: Mapped[int] = mapped_column(Integer)
    file_hash: Mapped[str] = mapped_column(String(64))
    parameters: Mapped[Optional[dict]] = mapped_column(JSON)  # ç¼–è¾‘å‚æ•°
    note: Mapped[Optional[str]] = mapped_column(Text)         # ç‰ˆæœ¬å¤‡æ³¨
    created_at: Mapped[datetime] = mapped_column(DateTime)
```

**ç‰ˆæœ¬æ§åˆ¶å·¥ä½œæµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant API as åç«¯API
    participant DB as æ•°æ®åº“
    participant S as å­˜å‚¨æœåŠ¡

    U->>F: ç¼–è¾‘å›¾ç‰‡(è£å‰ª+è°ƒè‰²)
    F->>API: POST /assets/{id}/edit
    API->>DB: æ£€æŸ¥æ˜¯å¦å­˜åœ¨V1
    alt é¦–æ¬¡ç¼–è¾‘
        API->>DB: åˆ›å»ºV1(åŸå›¾å½’æ¡£)
    end
    API->>S: ä¸‹è½½V1åŸå›¾
    API->>API: åº”ç”¨ç¼–è¾‘æ“ä½œ
    API->>S: ä¿å­˜æ–°ç‰ˆæœ¬æ–‡ä»¶
    API->>DB: åˆ›å»ºV2ç‰ˆæœ¬è®°å½•
    API->>DB: æ›´æ–°AssetæŒ‡å‘V2
    API-->>F: è¿”å›æ›´æ–°åçš„èµ„äº§
    F->>U: æ˜¾ç¤ºç¼–è¾‘ç»“æœ
    
    Note over U,F: ç”¨æˆ·æŸ¥çœ‹å†å²ç‰ˆæœ¬
    U->>F: æ‰“å¼€ç‰ˆæœ¬å†å²
    F->>API: GET /assets/{id}/versions
    API->>DB: æŸ¥è¯¢æ‰€æœ‰ç‰ˆæœ¬
    API-->>F: è¿”å›ç‰ˆæœ¬åˆ—è¡¨
    F->>U: æ˜¾ç¤ºç‰ˆæœ¬ç¼©ç•¥å›¾
    
    Note over U,F: ç”¨æˆ·æ¢å¤ç‰ˆæœ¬
    U->>F: é€‰æ‹©æ¢å¤V1
    F->>API: POST /assets/{id}/versions/1/restore
    API->>DB: æ›´æ–°AssetæŒ‡å‘V1
    API-->>F: è¿”å›æ¢å¤æˆåŠŸ
```

**ç‰ˆæœ¬æ¢å¤å®ç°**ï¼š

```python:apps/api/src/routers/assets.py
@router.post("/{asset_id}/versions/{version_id}/restore")
async def restore_version(
    asset_id: int,
    version_id: int,
    current_user: User = Depends(get_current_user),
    db: AsyncSession = Depends(get_db),
):
    """æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬"""
    asset = await db.get(Asset, asset_id)
    version = await db.get(AssetVersion, version_id)
    
    if not asset or asset.user_id != current_user.id:
        raise HTTPException(status_code=404, detail="èµ„äº§ä¸å­˜åœ¨")
    if not version or version.asset_id != asset_id:
        raise HTTPException(status_code=404, detail="ç‰ˆæœ¬ä¸å­˜åœ¨")
    
    # æ¢å¤æ–‡ä»¶è·¯å¾„å’Œå…ƒæ•°æ®
    asset.file_path = version.file_path
    asset.file_size = version.file_size
    asset.file_hash = version.file_hash
    
    await db.commit()
    return asset_to_response(asset)
```

**å‰ç«¯ç‰ˆæœ¬å†å² UI**ï¼š

```typescript:apps/web/src/components/asset/asset-editor.tsx
{activeTab === "history" && (
  <div className="space-y-3">
    {versions.map((version) => (
      <motion.div
        key={version.id}
        className="flex items-center gap-3 p-3 rounded-xl bg-white/5"
      >
        <img
          src={getStorageUrl(version.file_path)}
          className="w-20 h-20 object-cover rounded-lg"
        />
        <div className="flex-1">
          <div className="text-sm font-medium">
            ç‰ˆæœ¬ {version.version_number}
          </div>
          <div className="text-xs text-white/40">
            {version.note || "æ— å¤‡æ³¨"}
          </div>
          <div className="text-xs text-white/30">
            {formatDate(version.created_at)}
          </div>
        </div>
        <Button
          onClick={() => handleRestoreVersion(version.id)}
          variant="outline"
          size="sm"
        >
          æ¢å¤æ­¤ç‰ˆæœ¬
        </Button>
      </motion.div>
    ))}
  </div>
)}
```

### 1.3 æŠ€æœ¯å®ç°çš„è¶…è¶Š

#### 1.3.1 å…¨æ ˆ TypeScript ç±»å‹å®‰å…¨

å‰ç«¯ä½¿ç”¨ TypeScriptï¼Œåç«¯ Python é€šè¿‡ Pydantic å®ç° Schema éªŒè¯ï¼Œç¡®ä¿ç«¯åˆ°ç«¯ç±»å‹å®‰å…¨ã€‚

**å‰åç«¯ç±»å‹åŒæ­¥ç¤ºä¾‹**ï¼š

```typescript
// å‰ç«¯ç±»å‹å®šä¹‰ (apps/web/src/lib/api.ts)
export interface Asset {
  id: number;
  filename: string;
  title?: string;
  description?: string;
  tags: string[];
  url: string;
  thumbnail_url: string;
  // ...
}
```

```python
# åç«¯ Schema (apps/api/src/schemas/asset.py)
class AssetResponse(BaseModel):
    id: int
    filename: str
    title: Optional[str] = None
    description: Optional[str] = None
    tags: List[str] = []
    url: str
    thumbnail_url: str
    # ...
    
    model_config = ConfigDict(from_attributes=True)
```

#### 1.3.2 å¼‚æ­¥ä»»åŠ¡å¤„ç†ç³»ç»Ÿ

åŸºäº Redis + BullMQ çš„ä¸“ä¸šä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿï¼Œæ”¯æŒé‡è¯•ã€ä¼˜å…ˆçº§å’Œè¿›åº¦è¿½è¸ªã€‚

**ä»»åŠ¡å¤„ç†æµç¨‹**ï¼š

```python
# ä¸Šä¼ åè§¦å‘åå°å¤„ç†
background_tasks.add_task(process_asset_background, asset.id)

async def process_asset_background(asset_id: int):
    """åå°å¤„ç†èµ„äº§ï¼šç¼©ç•¥å›¾ã€EXIFã€AIåˆ†æã€å‘é‡åŒ–"""
    db = next(get_db())
    asset = await db.get(Asset, asset_id)
    
    # 1. ç”Ÿæˆç¼©ç•¥å›¾
    asset.processing_step = "thumbnail"
    await db.commit()
    
    # 2. æå– EXIF
    asset.processing_step = "metadata"
    # ...
    
    # 3. AI åˆ†æ
    asset.processing_step = "ai_analysis"
    ai_result = await gemini_service.analyze_image(image_data)
    
    # 4. å‘é‡åŒ–
    asset.processing_step = "vector"
    vector = await gemini_service.embed_content(ai_result["description"])
    await vector_service.upsert_vector(asset.id, vector, ai_result)
    
    asset.status = AssetStatus.READY
    asset.processing_step = "completed"
    await db.commit()
```

---

### 1.4 è¶…è¶Šæ€»ç»“

| ç»´åº¦ | è¯¾ç¨‹è¦æ±‚ | Zmage å®ç° | è¶…è¶Šç‚¹ |
|------|---------|-----------|--------|
| **æ¶æ„** | å•ä½“åº”ç”¨ | å¾®æœåŠ¡æ¶æ„ | å¯æ‰©å±•ã€å¯ç»´æŠ¤ |
| **æ•°æ®åº“** | MySQL/SQLite | PostgreSQL + Qdrant + Redis + MinIO | å¤šæ•°æ®åº“ååŒ |
| **æœç´¢** | å…³é”®è¯æœç´¢ | å…³é”®è¯ + è¯­ä¹‰ + è§†è§‰ç›¸ä¼¼ | å¤šæ¨¡æ€æ£€ç´¢ |
| **AI** | å›¾ç‰‡æ ‡ç­¾ç”Ÿæˆ | AIåˆ†æ + å‘é‡æ£€ç´¢ + MCPæ¥å£ + ç›¸å†Œå»ºè®® | å®Œæ•´AIèƒ½åŠ›ä½“ç³» |
| **ç¼–è¾‘** | ç®€å•è£å‰ªè°ƒè‰² | å®Œæ•´ç¼–è¾‘ + ç‰ˆæœ¬æ§åˆ¶ | ä¸“ä¸šçº§ç¼–è¾‘ç³»ç»Ÿ |
| **æ‰¹é‡** | åˆ é™¤åŠŸèƒ½ | æ‰¹é‡é€‰æ‹©/ç¼–è¾‘/ä¸‹è½½/æ ‡ç­¾/åˆ†äº« | å…¨é¢æ‰¹é‡æ“ä½œ |
| **éƒ¨ç½²** | ä»£ç æäº¤ | Docker Compose ä¸€é”®éƒ¨ç½² | å®¹å™¨åŒ–ç”Ÿäº§å°±ç»ª |

Zmage ä¸ä»…åœ¨åŠŸèƒ½ä¸Šå…¨é¢è¶…è¶Šè¯¾ç¨‹è¦æ±‚ï¼Œæ›´åœ¨æ¶æ„è®¾è®¡ã€æŠ€æœ¯é€‰å‹å’Œç”¨æˆ·ä½“éªŒä¸Šè¾¾åˆ°äº†ç”Ÿäº§çº§æ ‡å‡†ï¼Œæ˜¯ä¸€ä¸ªçœŸæ­£å¯ç”¨çš„ã€å…·å¤‡å•†ä¸šä»·å€¼çš„å›¾åƒèµ„äº§ç®¡ç†ç³»ç»Ÿã€‚

---

## 2. é¡¹ç›®æ¦‚è¿°

### 2.1 é¡¹ç›®èƒŒæ™¯

åœ¨æ•°å­—åŒ–æ—¶ä»£ï¼Œä¸ªäººå’Œå›¢é˜Ÿæ¯å¤©éƒ½åœ¨äº§ç”Ÿå¤§é‡çš„å›¾ç‰‡å’Œè§†é¢‘èµ„äº§ã€‚ä¼ ç»Ÿçš„æ–‡ä»¶ç³»ç»Ÿç®¡ç†æ–¹å¼å·²æ— æ³•æ»¡è¶³ç°ä»£éœ€æ±‚ï¼š

- **æ£€ç´¢å›°éš¾**ï¼šéš¾ä»¥ä»æˆåƒä¸Šä¸‡çš„æ–‡ä»¶ä¸­å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šå†…å®¹
- **ç»„ç»‡æ··ä¹±**ï¼šæ–‡ä»¶å¤¹ç»“æ„æ­»æ¿ï¼Œéš¾ä»¥çµæ´»ç»„ç»‡
- **ç¼ºä¹æ™ºèƒ½**ï¼šæ— æ³•è‡ªåŠ¨è¯†åˆ«å†…å®¹ï¼Œéœ€è¦æ‰‹åŠ¨æ ‡è®°
- **åˆ†äº«ä¸ä¾¿**ï¼šç¼ºå°‘ä¾¿æ·çš„åˆ†äº«å’Œåä½œæœºåˆ¶

Zmage æ­£æ˜¯åœ¨è¿™æ ·çš„èƒŒæ™¯ä¸‹è¯ç”Ÿçš„ï¼Œæ—¨åœ¨æ‰“é€ ä¸€ä¸ª**æ™ºèƒ½ã€é«˜æ•ˆã€éšç§ä¼˜å…ˆ**çš„æ•°å­—èµ„äº§ç®¡ç†ç³»ç»Ÿã€‚

### 2.2 é¡¹ç›®å®šä½

Zmage å®šä½ä¸º**æ–°ä¸€ä»£ä¸ªäººè§†è§‰èµ„äº§ç®¡ç†ç³»ç»Ÿ**ï¼Œæ ¸å¿ƒä»·å€¼åœ¨äºï¼š

```mermaid
graph TD
  R["Zmage Â· æ ¸å¿ƒä»·å€¼"]

  %% æ•°æ®ä¸»æƒ
  R --> A["æ•°æ®ä¸»æƒ"]
  A --> A1["æœ¬åœ°éƒ¨ç½²"]
  A --> A2["ç”¨æˆ·å®Œå…¨æ§åˆ¶"]
  A --> A3["éšç§ä¿æŠ¤"]

  %% æ™ºèƒ½è¾…åŠ©
  R --> B["æ™ºèƒ½è¾…åŠ©"]
  B --> B1["AI è‡ªåŠ¨æ ‡ç­¾"]
  B --> B2["è¯­ä¹‰æœç´¢"]
  B --> B3["æ™ºèƒ½ç›¸å†Œå»ºè®®"]

  %% ä½“éªŒæ²‰æµ¸
  R --> C["ä½“éªŒæ²‰æµ¸"]
  C --> C1["æ¶²æ€ç»ç’ƒ UI"]
  C --> C2["æµç•…äº¤äº’"]
  C --> C3["å¤šè®¾å¤‡é€‚é…"]

  %% ä¸“ä¸šåŠŸèƒ½
  R --> D["ä¸“ä¸šåŠŸèƒ½"]
  D --> D1["ç‰ˆæœ¬æ§åˆ¶"]
  D --> D2["æ‰¹é‡æ“ä½œ"]
  D --> D3["é«˜çº§åˆ†äº«"]
```

**æ ¸å¿ƒå®šä½**ï¼š

- **ç”¨æˆ·ä¾§**ï¼šä¸ªäººæ‘„å½±å¸ˆã€è®¾è®¡å¸ˆã€å†…å®¹åˆ›ä½œè€…çš„èµ„äº§ç®¡ç†å·¥å…·
- **æŠ€æœ¯ä¾§**ï¼šç°ä»£åŒ–çš„å…¨æ ˆ Web åº”ç”¨ï¼Œå±•ç¤º B/S æ¶æ„è®¾è®¡èƒ½åŠ›
- **è¯¾ç¨‹ä¾§**ï¼šå…¨é¢æ»¡è¶³è¯¾ç¨‹è¦æ±‚ï¼Œå¹¶åœ¨å¤šä¸ªç»´åº¦å®ç°è¶…è¶Š

### 2.3 æ ¸å¿ƒç‰¹æ€§æ¦‚è§ˆ

Zmage çš„æ ¸å¿ƒåŠŸèƒ½å›´ç»•"é‡‡é›†-ç»„ç»‡-æ£€ç´¢-åˆ›ä½œ-åˆ†äº«"çš„å…¨ç”Ÿå‘½å‘¨æœŸå±•å¼€ï¼š

```mermaid
graph LR
    A[é‡‡é›†] --> B[ç»„ç»‡]
    B --> C[æ£€ç´¢]
    C --> D[åˆ›ä½œ]
    D --> E[åˆ†äº«]
    
    A1[å¤šæºä¸Šä¼   æ‹–æ‹½/æ–‡ä»¶å¤¹/URL] --> A
    B1[æ™ºèƒ½ç›¸å†Œ  æ‰‹åŠ¨/è§„åˆ™/AIå»ºè®®] --> B
    C1[å…³é”®è¯/è¯­ä¹‰  ä»¥å›¾æœå›¾] --> C
    D1[ç¼–è¾‘å·¥å…·  ç‰ˆæœ¬æ§åˆ¶] --> D
    E1[åˆ†äº«é“¾æ¥  æƒé™æ§åˆ¶] --> E
    
    style A fill:#3b82f6
    style B fill:#10b981
    style C fill:#f59e0b
    style D fill:#8b5cf6
    style E fill:#ef4444
```

**åŠŸèƒ½çŸ©é˜µ**ï¼š

| åŠŸèƒ½æ¨¡å— | æ ¸å¿ƒèƒ½åŠ› | æŠ€æœ¯å®ç° |
|---------|---------|---------|
| **èµ„äº§é‡‡é›†** | æ‹–æ‹½ä¸Šä¼ ã€æ–‡ä»¶å¤¹å¯¼å…¥ã€URL å¯¼å…¥ã€é‡å¤æ£€æµ‹ | FastAPI æ–‡ä»¶å¤„ç†ã€MinIO å­˜å‚¨ |
| **æ™ºèƒ½ç»„ç»‡** | æ‰‹åŠ¨ç›¸å†Œã€æ™ºèƒ½ç›¸å†Œï¼ˆè§„åˆ™å¼•æ“ï¼‰ã€AI å»ºè®®ç›¸å†Œ | PostgreSQL JSON è§„åˆ™ã€Gemini AI |
| **å¤šç»´æ£€ç´¢** | å…³é”®è¯æœç´¢ã€è¯­ä¹‰æœç´¢ã€ä»¥å›¾æœå›¾ã€é«˜çº§ç­›é€‰ | PostgreSQL å…¨æ–‡æ£€ç´¢ã€Qdrant å‘é‡æ£€ç´¢ |
| **å›¾ç‰‡ç¼–è¾‘** | è£å‰ªã€è°ƒè‰²ã€æ—‹è½¬ã€æ»¤é•œã€ç‰ˆæœ¬å†å² | PIL/Sharp å›¾åƒå¤„ç†ã€ç‰ˆæœ¬æ§åˆ¶ |
| **åˆ†äº«åä½œ** | åˆ†äº«é“¾æ¥ã€å¯†ç ä¿æŠ¤ã€æƒé™æ§åˆ¶ã€è®¿é—®ç»Ÿè®¡ | é«˜ç†µåˆ†äº«ç ã€JWT éªŒè¯ |
| **å¯è§†åŒ–** | è¶³è¿¹åœ°å›¾ã€ç»Ÿè®¡é¢æ¿ã€å¤šè§†å›¾æµè§ˆ | Leaflet åœ°å›¾ã€Chart.js ç»Ÿè®¡ |

### 2.4 æŠ€æœ¯ç‰¹è‰²

**ç°ä»£åŒ–æŠ€æœ¯æ ˆ**ï¼š
- **å‰ç«¯**ï¼šNext.js 16 (App Router) + React 19 + TypeScript
- **åç«¯**ï¼šFastAPI + Python 3.11 + SQLAlchemy Async
- **æ•°æ®åº“**ï¼šPostgreSQL + Qdrant + Redis + MinIO
- **AI èƒ½åŠ›**ï¼šGoogle Gemini (å¤šæ¨¡æ€ç†è§£ã€å‘é‡åµŒå…¥)
- **éƒ¨ç½²**ï¼šDocker Compose ä¸€é”®éƒ¨ç½²

**è®¾è®¡ç†å¿µ**ï¼š
- **ç±»å‹å®‰å…¨**ï¼šå‰åç«¯å®Œæ•´ TypeScript/Pydantic ç±»å‹å®šä¹‰
- **å¼‚æ­¥ä¼˜å…ˆ**ï¼šå…¨é¢ä½¿ç”¨ async/awaitï¼Œæå‡å¹¶å‘æ€§èƒ½
- **å®¹å™¨åŒ–**ï¼šå®Œæ•´çš„ Docker å®¹å™¨åŒ–ï¼Œç¯å¢ƒä¸€è‡´æ€§ä¿è¯
- **AI åŸç”Ÿ**ï¼šæ·±åº¦é›†æˆ AI èƒ½åŠ›ï¼Œè€Œéç®€å•è°ƒç”¨

---

## 3. éœ€æ±‚åˆ†æ

### 3.1 è¯¾ç¨‹åŸºæœ¬éœ€æ±‚åˆ†æ

è¯¾ç¨‹è¦æ±‚å®ç° 11 é¡¹åŸºæœ¬åŠŸèƒ½å’Œ 2 é¡¹å¢å¼ºåŠŸèƒ½ã€‚Zmage ä¸ä»…å…¨éƒ¨å®ç°ï¼Œè¿˜åœ¨å¤šä¸ªç»´åº¦è¿›è¡Œäº†æ‰©å±•å’Œä¼˜åŒ–ã€‚

**éœ€æ±‚è¦†ç›–çŸ©é˜µ**ï¼š

```mermaid
graph TB
    subgraph "è¯¾ç¨‹åŸºæœ¬éœ€æ±‚"
        A1[ç”¨æˆ·æ³¨å†Œç™»å½•] --> A2[å¯†ç éªŒè¯  å”¯ä¸€æ€§æ ¡éªŒ]
        B1[å›¾ç‰‡ä¸Šä¼ ] --> B2[å¤šæ ¼å¼æ”¯æŒ  æ‰¹é‡ä¸Šä¼ ]
        C1[EXIFæå–] --> C2[è‡ªåŠ¨åˆ†ç±»  æ—¶é—´åœ°ç‚¹æ ‡ç­¾]
        D1[è‡ªå®šä¹‰æ ‡ç­¾] --> D2[æ ‡ç­¾ç®¡ç†  å¤šæ ‡ç­¾å…³è”]
        E1[ç¼©ç•¥å›¾ç”Ÿæˆ] --> E2[è‡ªåŠ¨ç”Ÿæˆ  æ€§èƒ½ä¼˜åŒ–]
        F1[æ•°æ®åº“å­˜å‚¨] --> F2[ç»“æ„åŒ–å­˜å‚¨  å…ƒæ•°æ®ç®¡ç†]
        G1[æŸ¥è¯¢åŠŸèƒ½] --> G2[å¤šæ¡ä»¶ç­›é€‰  é«˜çº§æœç´¢]
        H1[å±•ç¤ºç•Œé¢] --> H2[è½®æ’­æ˜¾ç¤º  å¤šè§†å›¾]
        I1[å›¾ç‰‡ç¼–è¾‘] --> I2[è£å‰ªè°ƒè‰²  åŸºç¡€ç¼–è¾‘]
        J1[åˆ é™¤åŠŸèƒ½] --> J2[è½¯åˆ é™¤  å›æ”¶ç«™]
        K1[ç§»åŠ¨ç«¯é€‚é…] --> K2[å“åº”å¼è®¾è®¡  è§¦æ‘¸ä¼˜åŒ–]
    end
    
    subgraph "è¯¾ç¨‹å¢å¼ºéœ€æ±‚"
        L1[AIå›¾ç‰‡åˆ†æ] --> L2[å¤šç±»å‹æ ‡ç­¾  åœºæ™¯è¯†åˆ«]
        M1[MCPæ¥å£] --> M2[å¯¹è¯å¼æ£€ç´¢  å·¥å…·é›†æˆ]
    end
    
    style A1 fill:#e0f2fe
    style B1 fill:#e0f2fe
    style C1 fill:#e0f2fe
    style L1 fill:#fef3c7
    style M1 fill:#fef3c7
```

#### 3.1.1 ç”¨æˆ·ç®¡ç†éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šå®ç°ç”¨æˆ·æ³¨å†Œã€ç™»å½•åŠŸèƒ½

**è¯¦ç»†è¦æ±‚**ï¼š
- ç”¨æˆ·åé•¿åº¦ >= 6 å­—èŠ‚
- å¯†ç é•¿åº¦ >= 6 å­—èŠ‚  
- Email æ ¼å¼éªŒè¯
- ç”¨æˆ·åå’Œ Email å”¯ä¸€æ€§æ ¡éªŒ

**å®ç°æ–¹æ¡ˆ**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant API as FastAPI
    participant DB as PostgreSQL
    participant AUTH as JWTè®¤è¯

    Note over U,AUTH: æ³¨å†Œæµç¨‹
    U->>F: å¡«å†™æ³¨å†Œä¿¡æ¯
    F->>F: å‰ç«¯è¡¨å•éªŒè¯
    F->>API: POST /auth/register
    API->>DB: æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±å”¯ä¸€æ€§
    alt å·²å­˜åœ¨
        API-->>F: è¿”å›é”™è¯¯
    else å¯ç”¨
        API->>API: å¯†ç å“ˆå¸Œ(pbkdf2_sha256)
        API->>DB: åˆ›å»ºç”¨æˆ·è®°å½•
        DB-->>API: è¿”å›ç”¨æˆ·ä¿¡æ¯
        API-->>F: æ³¨å†ŒæˆåŠŸ
    end

    Note over U,AUTH: ç™»å½•æµç¨‹
    U->>F: è¾“å…¥ç”¨æˆ·å/å¯†ç 
    F->>API: POST /auth/login
    API->>DB: æŸ¥è¯¢ç”¨æˆ·
    API->>API: éªŒè¯å¯†ç 
    alt éªŒè¯æˆåŠŸ
        API->>AUTH: ç”ŸæˆJWT Token
        AUTH-->>API: è¿”å›Token
        API-->>F: è¿”å›Token + ç”¨æˆ·ä¿¡æ¯
        F->>F: å­˜å‚¨Tokenåˆ°LocalStorage
    else éªŒè¯å¤±è´¥
        API-->>F: è¿”å›401é”™è¯¯
    end

    Note over U,AUTH: åç»­è¯·æ±‚
    F->>API: è¯·æ±‚ + Authorization Header
    API->>AUTH: éªŒè¯Token
    AUTH-->>API: è¿”å›ç”¨æˆ·ä¿¡æ¯
    API->>API: æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    API-->>F: è¿”å›ç»“æœ
```

**å®‰å…¨æ€§ä¿éšœ**ï¼š
- å¯†ç ä½¿ç”¨ `pbkdf2_sha256` åŠ ç›å“ˆå¸Œï¼Œç»ä¸å­˜å‚¨æ˜æ–‡
- JWT Token è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´ï¼ˆé»˜è®¤ 7 å¤©ï¼‰
- æ‰€æœ‰å—ä¿æŠ¤ API éƒ½è¿›è¡Œç”¨æˆ·èº«ä»½éªŒè¯
- æ”¯æŒç”¨æˆ·çŠ¶æ€æ£€æŸ¥ï¼ˆis_activeï¼‰ï¼Œå¯ç¦ç”¨è´¦æˆ·

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œå¹¶æ‰©å±•æ”¯æŒç¤¾äº¤ç™»å½•ï¼ˆé¢„ç•™æ¥å£ï¼‰

#### 3.1.2 å›¾ç‰‡ä¸Šä¼ éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šé€šè¿‡ PC æˆ–æ‰‹æœºæµè§ˆå™¨ä¸Šä¼ ç…§ç‰‡

**è¯¦ç»†è¦æ±‚**ï¼š
- æ”¯æŒå¤šç§å›¾ç‰‡æ ¼å¼ï¼ˆJPEGã€PNGã€GIFã€WebPã€HEICï¼‰
- æ”¯æŒæ–‡ä»¶/æ–‡ä»¶å¤¹æ‰¹é‡ä¸Šä¼ 
- ç§»åŠ¨ç«¯åŸç”Ÿç›¸å†Œè°ƒç”¨ï¼ˆWeb ç«¯é€šè¿‡æ–‡ä»¶é€‰æ‹©å™¨å®ç°ï¼‰

**ä¸Šä¼ æµç¨‹è®¾è®¡**ï¼š

```mermaid
flowchart TD
    A[ç”¨æˆ·é€‰æ‹©æ–‡ä»¶] --> B{ä¸Šä¼ æ–¹å¼}
    B -->|å•æ–‡ä»¶| C[æ‹–æ‹½/ç‚¹å‡»é€‰æ‹©]
    B -->|å¤šæ–‡ä»¶| D[æ‰¹é‡é€‰æ‹©]
    B -->|æ–‡ä»¶å¤¹| E[ä¿æŒå±‚çº§ç»“æ„]
    
    C --> F[å‰ç«¯éªŒè¯  æ ¼å¼/å¤§å°]
    D --> F
    E --> F
    
    F -->|é€šè¿‡| G[åˆ†ç‰‡ä¸Šä¼   è¿›åº¦è¿½è¸ª]
    F -->|å¤±è´¥| H[é”™è¯¯æç¤º]
    
    G --> I[åç«¯æ¥æ”¶]
    I --> J[è®¡ç®—æ–‡ä»¶å“ˆå¸Œ]
    J --> K{é‡å¤æ£€æµ‹}
    
    K -->|é‡å¤| L[è·³è¿‡ä¸Šä¼   è¿”å›ç°æœ‰èµ„äº§]
    K -->|æ–°æ–‡ä»¶| M[å­˜å‚¨åˆ°MinIO]
    
    M --> N[åˆ›å»ºèµ„äº§è®°å½•  status=pending]
    N --> O[è§¦å‘åå°ä»»åŠ¡]
    O --> P[å¼‚æ­¥å¤„ç†  ç¼©ç•¥å›¾/EXIF/AI]
    
    L --> Q[è¿”å›ç»“æœ]
    P --> Q
    
    style G fill:#3b82f6
    style J fill:#10b981
    style O fill:#f59e0b
```

**å…³é”®æŠ€æœ¯ç‚¹**ï¼š
- **é‡å¤æ£€æµ‹**ï¼šåŸºäº SHA256 æ–‡ä»¶å“ˆå¸Œï¼Œé¿å…é‡å¤å­˜å‚¨
- **å¼‚æ­¥å¤„ç†**ï¼šä¸Šä¼ åç«‹å³è¿”å›ï¼Œåå°ä»»åŠ¡å¤„ç†è€—æ—¶æ“ä½œ
- **è¿›åº¦è¿½è¸ª**ï¼šå‰ç«¯å®æ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
- **æ–‡ä»¶å¤¹ç»“æ„**ï¼šè‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¤¹ï¼Œä¿æŒåŸå§‹å±‚çº§

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒæ‹–æ‹½ä¸Šä¼ ã€æ‰¹é‡ä¸Šä¼ ã€æ–‡ä»¶å¤¹å¯¼å…¥

#### 3.1.3 EXIF ä¿¡æ¯æå–éœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šè‡ªåŠ¨æå–å›¾ç‰‡ EXIF ä¿¡æ¯å¹¶åˆ›å»ºåˆ†ç±»æ ‡ç­¾
- **è¯¦ç»†è¦æ±‚**ï¼š
  - æå–æ‹æ‘„æ—¶é—´ã€åœ°ç‚¹ï¼ˆGPSï¼‰
  - æå–ç›¸æœºå‹å·ã€é•œå¤´å‚æ•°
  - æå–åˆ†è¾¨ç‡ã€å…‰åœˆã€å¿«é—¨ç­‰æŠ€æœ¯å‚æ•°
  - åŸºäº EXIF è‡ªåŠ¨åˆ›å»ºæ—¶é—´ã€åœ°ç‚¹æ ‡ç­¾
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.4 è‡ªå®šä¹‰æ ‡ç­¾éœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šç”¨æˆ·å¯ä»¥æ‰‹åŠ¨æ·»åŠ åˆ†ç±»æ ‡ç­¾
- **è¯¦ç»†è¦æ±‚**ï¼š
  - æ”¯æŒå¤šæ ‡ç­¾å…³è”
  - æ ‡ç­¾ç®¡ç†ç•Œé¢
  - åŸºäºæ ‡ç­¾æ£€ç´¢
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.5 ç¼©ç•¥å›¾ç”Ÿæˆéœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šç”Ÿæˆç¼©ç•¥å›¾æ–¹ä¾¿æ˜¾ç¤º
- **è¯¦ç»†è¦æ±‚**ï¼š
  - è‡ªåŠ¨ç”Ÿæˆç»Ÿä¸€å°ºå¯¸ç¼©ç•¥å›¾
  - è§†é¢‘å°é¢å¸§æå–
  - ä¼˜åŒ–åŠ è½½æ€§èƒ½
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.6 æ•°æ®åº“å­˜å‚¨éœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šå›¾ç‰‡ä¿¡æ¯ä¿å­˜åœ¨æ•°æ®åº“ä¸­
- **è¯¦ç»†è¦æ±‚**ï¼š
  - ç»“æ„åŒ–å­˜å‚¨å…ƒæ•°æ®
  - æ”¯æŒå¤æ‚æŸ¥è¯¢
  - æ•°æ®ä¸€è‡´æ€§ä¿è¯
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.7 æŸ¥è¯¢åŠŸèƒ½éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šæä¾›æŸ¥è¯¢ç•Œé¢ï¼Œæ”¯æŒå¤šç§æ¡ä»¶æŸ¥æ‰¾

**æŸ¥è¯¢èƒ½åŠ›çŸ©é˜µ**ï¼š

```mermaid
graph TB
    A[æŸ¥è¯¢å…¥å£] --> B{æœç´¢æ¨¡å¼}
    
    B -->|å…³é”®è¯| C[å…¨æ–‡æ£€ç´¢]
    B -->|è¯­ä¹‰| D[å‘é‡æ£€ç´¢]
    B -->|è§†è§‰| E[ä»¥å›¾æœå›¾]
    
    C --> F[PostgreSQL  ILIKE/å…¨æ–‡ç´¢å¼•]
    D --> G[Qdrant  å‘é‡ç›¸ä¼¼åº¦]
    E --> G
    
    F --> H[ç»“æœåˆå¹¶]
    G --> H
    
    H --> I{æ’åºæ–¹å¼}
    I --> J[ç›¸å…³åº¦]
    I --> K[æ—¶é—´]
    I --> L[æ–‡ä»¶å]
    I --> M[æ–‡ä»¶å¤§å°]
    
    N[é«˜çº§ç­›é€‰] --> O[æ—¶é—´èŒƒå›´]
    N --> P[åª’ä½“ç±»å‹]
    N --> Q[ç›¸å†Œç­›é€‰]
    N --> R[æ ‡ç­¾ç­›é€‰]
    N --> S[EXIFå‚æ•°]
    
    O --> H
    P --> H
    Q --> H
    R --> H
    S --> H
    
    style D fill:#10b981
    style E fill:#10b981
    style G fill:#f59e0b
```

**ç­›é€‰å™¨è®¾è®¡**ï¼š

| ç­›é€‰ç»´åº¦ | æ”¯æŒæ¡ä»¶ | UI å‘ˆç° |
|---------|---------|---------|
| **æ—¶é—´èŒƒå›´** | ç²¾ç¡®æ—¥æœŸã€è‡ªç„¶è¯­è¨€ï¼ˆä»Šå¤©/æœ¬å‘¨/ä¸Šæœˆï¼‰ã€è‡ªå®šä¹‰èŒƒå›´ | æ—¥æœŸé€‰æ‹©å™¨ + å¿«æ·é€‰é¡¹ |
| **åª’ä½“ç±»å‹** | å›¾ç‰‡/è§†é¢‘/æ–‡æ¡£ | æ ‡ç­¾åˆ‡æ¢ |
| **ç›¸å†Œ** | å•é€‰/å¤šé€‰ç›¸å†Œ | ä¸‹æ‹‰å¤šé€‰ |
| **æ ‡ç­¾** | å¤šæ ‡ç­¾ç»„åˆï¼ˆAND/ORï¼‰ | æ ‡ç­¾äº‘ + å¤šé€‰ |
| **EXIF å‚æ•°** | ç›¸æœºå‹å·ã€å…‰åœˆèŒƒå›´ã€ISO èŒƒå›´ | æŠ˜å é¢æ¿ |

**æ’åºé€‰é¡¹**ï¼š
- **æ—¶é—´**ï¼šä¸Šä¼ æ—¶é—´ï¼ˆå‡/é™ï¼‰ã€æ‹æ‘„æ—¶é—´ï¼ˆå‡/é™ï¼‰
- **å…ƒæ•°æ®**ï¼šæ–‡ä»¶åï¼ˆA-Z/Z-Aï¼‰ã€æ–‡ä»¶å¤§å°
- **äº¤äº’**ï¼šè¯„åˆ†ã€æµè§ˆæ¬¡æ•°
- **ç›¸å…³åº¦**ï¼šæœç´¢ç›¸å…³åº¦åˆ†æ•°ï¼ˆAI æœç´¢æ—¶ï¼‰

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒå…³é”®è¯æœç´¢ã€è¯­ä¹‰æœç´¢ã€é«˜çº§ç­›é€‰å’Œå¤šç»´åº¦æ’åº

#### 3.1.8 å±•ç¤ºç•Œé¢éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šæä¾›å‹å¥½çš„å±•ç¤ºç•Œé¢ï¼Œå¦‚é€‰æ‹©ä¸€å®šçš„å›¾ç‰‡è¿›è¡Œè½®æ’­æ˜¾ç¤ºç­‰

**å¤šè§†å›¾æ¨¡å¼è®¾è®¡**ï¼š

```mermaid
stateDiagram-v2
    [*] --> ç½‘æ ¼è§†å›¾: é»˜è®¤
    
    ç½‘æ ¼è§†å›¾ --> åˆ—è¡¨è§†å›¾: åˆ‡æ¢è§†å›¾
    åˆ—è¡¨è§†å›¾ --> ç€‘å¸ƒæµè§†å›¾: åˆ‡æ¢è§†å›¾
    ç€‘å¸ƒæµè§†å›¾ --> ç½‘æ ¼è§†å›¾: åˆ‡æ¢è§†å›¾
    
    ç½‘æ ¼è§†å›¾ --> å…¨å±é¢„è§ˆ: ç‚¹å‡»å›¾ç‰‡
    åˆ—è¡¨è§†å›¾ --> å…¨å±é¢„è§ˆ: ç‚¹å‡»å›¾ç‰‡
    ç€‘å¸ƒæµè§†å›¾ --> å…¨å±é¢„è§ˆ: ç‚¹å‡»å›¾ç‰‡
    
    å…¨å±é¢„è§ˆ --> è½®æ’­æ¨¡å¼: è‡ªåŠ¨æ’­æ”¾
    å…¨å±é¢„è§ˆ --> ç½‘æ ¼è§†å›¾: å…³é—­
    
    è½®æ’­æ¨¡å¼ --> å…¨å±é¢„è§ˆ: æ‰‹åŠ¨æ¨¡å¼
```

**è§†å›¾ç‰¹æ€§å¯¹æ¯”**ï¼š

| è§†å›¾æ¨¡å¼ | é€‚ç”¨åœºæ™¯ | ç‰¹ç‚¹ |
|---------|---------|------|
| **ç½‘æ ¼è§†å›¾** | å¿«é€Ÿæµè§ˆã€æ‰¹é‡é€‰æ‹© | å›ºå®šå°ºå¯¸ç¼©ç•¥å›¾ã€å¡ç‰‡å¼å¸ƒå±€ã€hover æ•ˆæœ |
| **åˆ—è¡¨è§†å›¾** | æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ | å°ç¼©ç•¥å›¾ + å…ƒæ•°æ®åˆ—è¡¨ã€å¿«é€Ÿæ‰«æ |
| **ç€‘å¸ƒæµè§†å›¾** | è‰ºæœ¯å±•ç¤º | åŠ¨æ€é«˜åº¦ã€è§†è§‰ç¾æ„Ÿã€é€‚åˆå±•ç¤ºé«˜è´¨é‡å›¾ç‰‡ |
| **å…¨å±é¢„è§ˆ** | ç»†èŠ‚æŸ¥çœ‹ | æ”¯æŒç¼©æ”¾ã€é”®ç›˜å¯¼èˆªã€ä¿¡æ¯é¢æ¿ |
| **è½®æ’­æ¨¡å¼** | æ¼”ç¤ºå±•ç¤º | è‡ªåŠ¨æ’­æ”¾ã€è¿‡æ¸¡åŠ¨ç”»ã€å¯æš‚åœ |

**è½®æ’­åŠŸèƒ½å®ç°**ï¼š
- æ”¯æŒæ’­æ”¾/æš‚åœæ§åˆ¶
- å¯è®¾ç½®è‡ªåŠ¨æ’­æ”¾é—´éš”ï¼ˆ3s/5s/10sï¼‰
- æ”¯æŒé”®ç›˜å¿«æ·é”®ï¼ˆâ†â†’ åˆ‡æ¢ã€ç©ºæ ¼æš‚åœï¼‰
- æ˜¾ç¤ºè¿›åº¦æŒ‡ç¤ºå™¨

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒä¸‰ç§è§†å›¾æ¨¡å¼ã€å…¨å±é¢„è§ˆå’Œè½®æ’­åŠŸèƒ½

#### 3.1.9 å›¾ç‰‡ç¼–è¾‘éœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šæä¾›ç®€å•çš„ç¼–è¾‘åŠŸèƒ½
- **è¯¦ç»†è¦æ±‚**ï¼š
  - è£å‰ªåŠŸèƒ½
  - è‰²è°ƒè°ƒæ•´ï¼ˆäº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ç­‰ï¼‰
  - æ—‹è½¬ã€ç¿»è½¬
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.10 åˆ é™¤åŠŸèƒ½éœ€æ±‚
- **éœ€æ±‚æè¿°**ï¼šæ”¯æŒåˆ é™¤å›¾ç‰‡
- **è¯¦ç»†è¦æ±‚**ï¼š
  - å•ä¸ªåˆ é™¤
  - æ‰¹é‡åˆ é™¤
  - è½¯åˆ é™¤æœºåˆ¶ï¼ˆå›æ”¶ç«™ï¼‰
- **å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

#### 3.1.11 ç§»åŠ¨ç«¯é€‚é…éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šæ ·å¼é€‚é…æ‰‹æœºï¼Œå¼€å‘æ‰‹æœº App æˆ–èƒ½å¤Ÿåœ¨æ‰‹æœºæµè§ˆå™¨/å¾®ä¿¡ç­‰åº”ç”¨å†…ç½®çš„æµè§ˆå™¨ä¸­å‹å¥½æ˜¾ç¤º

**å“åº”å¼è®¾è®¡ç­–ç•¥**ï¼š

```mermaid
graph LR
    A[æ¡Œé¢ç«¯  >=1024px] --> A1[ä¸‰æ å¸ƒå±€ ä¾§è¾¹æ +ä¸»å†…å®¹+è¯¦æƒ…]
    B[å¹³æ¿ç«¯  768-1023px] --> B1[ä¸¤æ å¸ƒå±€ å¯æŠ˜å ä¾§è¾¹æ ]
    C[ç§»åŠ¨ç«¯  <768px] --> C1[å•æ å¸ƒå±€ åº•éƒ¨å¯¼èˆª]
    
    A1 --> D[åŠŸèƒ½å®Œæ•´]
    B1 --> D
    C1 --> E[æ ¸å¿ƒåŠŸèƒ½ä¼˜åŒ–]
    
    style A fill:#3b82f6
    style B fill:#10b981
    style C fill:#f59e0b
```

**ç§»åŠ¨ç«¯ä¼˜åŒ–è¦ç‚¹**ï¼š

| ä¼˜åŒ–é¡¹ | å®ç°æ–¹å¼ | æ•ˆæœ |
|-------|---------|------|
| **è§¦æ‘¸æ‰‹åŠ¿** | æ”¯æŒæ»‘åŠ¨åˆ‡æ¢ã€åŒæŒ‡ç¼©æ”¾ã€é•¿æŒ‰èœå• | åŸç”Ÿ App èˆ¬çš„äº¤äº’ä½“éªŒ |
| **å¸ƒå±€é€‚é…** | Tailwind å“åº”å¼æ–­ç‚¹ã€Flexbox å¸ƒå±€ | è‡ªé€‚åº”ä¸åŒå±å¹•å°ºå¯¸ |
| **æ€§èƒ½ä¼˜åŒ–** | å›¾ç‰‡æ‡’åŠ è½½ã€è™šæ‹Ÿæ»šåŠ¨ã€ç¼©ç•¥å›¾ä¼˜å…ˆ | æµç•…çš„æ»šåŠ¨ä½“éªŒ |
| **å¯¼èˆªè®¾è®¡** | åº•éƒ¨ Tab å¯¼èˆªã€æŠ½å±‰å¼ä¾§è¾¹æ  | ç¬¦åˆç§»åŠ¨ç«¯æ“ä½œä¹ æƒ¯ |

**æ–­ç‚¹è®¾è®¡**ï¼š
- `sm`: 640pxï¼ˆå°å±æ‰‹æœºï¼‰
- `md`: 768pxï¼ˆå¤§å±æ‰‹æœº/å¹³æ¿ï¼‰
- `lg`: 1024pxï¼ˆæ¡Œé¢ï¼‰
- `xl`: 1280pxï¼ˆå¤§æ¡Œé¢ï¼‰

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ˆå“åº”å¼ Webï¼‰ï¼Œå®Œç¾é€‚é…æ‰‹æœºæµè§ˆå™¨

### 3.2 è¯¾ç¨‹å¢å¼ºéœ€æ±‚åˆ†æ

#### 3.2.1 AI å›¾ç‰‡åˆ†æéœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šè°ƒç”¨ AI æ¨¡å‹åˆ†æå›¾ç‰‡ï¼Œæä¾›å¤šç±»å‹çš„æ ‡ç­¾ï¼Œå¦‚é£æ™¯ã€äººç‰©ã€åŠ¨ç‰©ç­‰

**AI åˆ†æèƒ½åŠ›**ï¼š

```mermaid
graph TD
  R["AI å›¾ç‰‡åˆ†æ"]

  %% å†…å®¹è¯†åˆ«
  R --> A["å†…å®¹è¯†åˆ«"]
  A --> A1["åœºæ™¯ç±»å‹"]
  A1 --> A11["å®¤å†… / æˆ·å¤– / è‡ªç„¶ / åŸå¸‚"]
  A --> A2["ä¸»ä½“è¯†åˆ«"]
  A2 --> A21["äººç‰© / åŠ¨ç‰© / ç‰©ä½“"]
  A --> A3["æ´»åŠ¨è¯†åˆ«"]
  A3 --> A31["è¿åŠ¨ / ä¼‘é—² / å·¥ä½œ"]

  %% æ ‡ç­¾ç”Ÿæˆ
  R --> B["æ ‡ç­¾ç”Ÿæˆ"]
  B --> B1["ç‰©ä½“æ ‡ç­¾"]
  B --> B2["åœºæ™¯æ ‡ç­¾"]
  B --> B3["æƒ…æ„Ÿæ ‡ç­¾"]
  B --> B4["é£æ ¼æ ‡ç­¾"]

  %% æ–‡æœ¬æå–
  R --> C["æ–‡æœ¬æå–"]
  C --> C1["OCR è¯†åˆ«"]
  C --> C2["å›¾ç‰‡ä¸­çš„æ–‡å­—"]
  C --> C3["å¤šè¯­è¨€æ”¯æŒ"]

  %% å…ƒæ•°æ®å¢å¼º
  R --> D["å…ƒæ•°æ®å¢å¼º"]
  D --> D1["æ ‡é¢˜ç”Ÿæˆ"]
  D --> D2["ä¸€å¥è¯æè¿°"]
  D --> D3["è¯¦ç»†æè¿°"]
  D --> D4["è‰²å½©åˆ†æ"]
```

**åˆ†ææµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å›¾ç‰‡ä¸Šä¼ å®Œæˆ] --> B[Workeræ¥æ”¶ä»»åŠ¡]
    B --> C[ä¸‹è½½åŸå§‹å›¾ç‰‡]
    C --> D[è°ƒç”¨Gemini API]
    
    D --> E[å¤šæ¨¡æ€ç†è§£]
    E --> F[ç”Ÿæˆç»“æ„åŒ–JSON]
    
    F --> G[è§£æç»“æœ]
    G --> H[æå–æ ‡ç­¾]
    G --> I[ç”Ÿæˆæè¿°]
    G --> J[OCRæ–‡æœ¬]
    G --> K[è‰²å½©åˆ†æ]
    
    H --> L[ä¿å­˜åˆ°æ•°æ®åº“]
    I --> L
    J --> L
    K --> L
    
    L --> M[ç”Ÿæˆå‘é‡åµŒå…¥]
    M --> N[å­˜å‚¨åˆ°Qdrant]
    
    N --> O[æ›´æ–°èµ„äº§çŠ¶æ€  status=ready]
    
    style D fill:#10b981
    style E fill:#10b981
    style M fill:#f59e0b
```

**ç”Ÿæˆå†…å®¹ç¤ºä¾‹**ï¼š
```json
{
  "title": "å¤•é˜³ä¸‹çš„æµ·è¾¹åŸå¸‚",
  "description": "ä¸€å¼ æ‹æ‘„äºå‚æ™šæ—¶åˆ†çš„ç…§ç‰‡ï¼Œå±•ç°äº†æµ·æ»¨åŸå¸‚çš„ç¾ä¸½æ™¯è‰²ï¼Œå¤©ç©ºå‘ˆç°æ¸©æš–çš„æ©™çº¢è‰²è°ƒï¼Œå»ºç­‘åœ¨å¤•é˜³çš„æ˜ ç…§ä¸‹æ˜¾å¾—æ ¼å¤–è¿·äººã€‚",
  "tags": ["æµ·è¾¹", "åŸå¸‚", "å¤•é˜³", "å»ºç­‘", "é£æ™¯", "æ¸©æš–", "ç¾ä¸½"],
  "ocr_text": "WELCOME TO HAIKOU",
  "objects": ["å»ºç­‘", "æµ·æ°´", "å¤©ç©º", "äº‘æœµ"],
  "scene": "æˆ·å¤–",
  "colors": ["æ©™è‰²", "çº¢è‰²", "è“è‰²", "ç™½è‰²"]
}
```

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ŒåŸºäº Google Gemini 2.5 Flash å®ç°

#### 3.2.2 MCP æ¥å£éœ€æ±‚

**éœ€æ±‚æè¿°**ï¼šæä¾› MCP æ¥å£ï¼Œèƒ½é€šè¿‡å¤§æ¨¡å‹å¯¹è¯æ–¹å¼æ£€ç´¢ç½‘ç«™ä¸Šçš„å›¾ç‰‡

**MCP å·¥å…·ä½“ç³»**ï¼š

```mermaid
graph TB
    A[MCPæ¥å£] --> B[èµ„äº§ç®¡ç†å·¥å…·]
    A --> C[ç›¸å†Œç®¡ç†å·¥å…·]
    A --> D[æœç´¢å·¥å…·]
    A --> E[åˆ†äº«å·¥å…·]
    A --> F[ç³»ç»Ÿå·¥å…·]
    
    B --> B1[search_assets  è¯­ä¹‰æœç´¢]
    B --> B2[list_assets  åˆ—è¡¨èµ„äº§]
    B --> B3[find_similar  ç›¸ä¼¼æœç´¢]
    
    D --> D1[å…³é”®è¯æœç´¢]
    D --> D2[è¯­ä¹‰æœç´¢]
    D --> D3[ä»¥å›¾æœå›¾]
    
    style A fill:#8b5cf6
    style B1 fill:#10b981
    style D2 fill:#10b981
```

**å¯¹è¯å¼æ£€ç´¢ç¤ºä¾‹**ï¼š

```
ç”¨æˆ·: "å¸®æˆ‘æ‰¾ä¸€äº›å»å¹´å¤å¤©æ‹çš„é£æ™¯ç…§ç‰‡"

å¤§æ¨¡å‹: [è°ƒç”¨ search_assets å·¥å…·]
{
  "name": "search_assets",
  "arguments": {
    "query": "å»å¹´å¤å¤© é£æ™¯",
    "limit": 10
  }
}

ç³»ç»Ÿè¿”å›: æ‰¾åˆ° 15 ä¸ªåŒ¹é…é¡¹

å¤§æ¨¡å‹å›å¤: "æˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº† 15 å¼ å»å¹´å¤å¤©æ‹æ‘„çš„é£æ™¯ç…§ç‰‡ã€‚
å…¶ä¸­åŒ…æ‹¬æµ·è¾¹æ—¥è½ã€å±±é—´äº‘é›¾ã€åŸå¸‚å¤œæ™¯ç­‰å¤šç§åœºæ™¯ã€‚
éœ€è¦æˆ‘å¸®æ‚¨æŒ‰åœ°ç‚¹æˆ–é£æ ¼è¿›ä¸€æ­¥ç­›é€‰å—ï¼Ÿ"
```

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæä¾› 30+ ä¸ª MCP å·¥å…·ï¼Œæ”¯æŒå®Œæ•´çš„å¯¹è¯å¼äº¤äº’

### 3.3 éåŠŸèƒ½éœ€æ±‚

- **æ€§èƒ½éœ€æ±‚**ï¼šæ”¯æŒå¤§è§„æ¨¡åª’ä½“åº“ï¼ˆæ•°ä¸‡å¼ å›¾ç‰‡ï¼‰
- **å®‰å…¨éœ€æ±‚**ï¼šç”¨æˆ·æ•°æ®éš”ç¦»ã€å¯†ç åŠ å¯†ã€JWT è®¤è¯
- **å¯ç”¨æ€§éœ€æ±‚**ï¼šç•Œé¢å‹å¥½ã€æ“ä½œç›´è§‚ã€é”™è¯¯æç¤ºæ¸…æ™°
- **å¯æ‰©å±•æ€§éœ€æ±‚**ï¼šæ¨¡å—åŒ–è®¾è®¡ã€æ˜“äºæ‰©å±•æ–°åŠŸèƒ½

---

## 4. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 4.1 æ€»ä½“æ¶æ„

Zmage é‡‡ç”¨**å‰åç«¯åˆ†ç¦» + å¾®æœåŠ¡**çš„ç°ä»£åŒ–æ¶æ„ï¼Œé€šè¿‡æ¸…æ™°çš„åˆ†å±‚è®¾è®¡å®ç°é«˜å†…èšã€ä½è€¦åˆã€‚

**ç³»ç»Ÿæ•´ä½“æ¶æ„**ï¼š

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚ (Client Layer)"
        C1[æµè§ˆå™¨  Next.js Web App]
        C2[ç§»åŠ¨æµè§ˆå™¨  å“åº”å¼é€‚é…]
    end

    subgraph "åº”ç”¨æœåŠ¡å±‚ (Application Layer)"
        A1[FastAPI åç«¯  API Gateway]
        A2[Worker æœåŠ¡  åå°ä»»åŠ¡å¤„ç†]
    end

    subgraph "ä¸šåŠ¡é€»è¾‘å±‚ (Business Layer)"
        B1[è®¤è¯æˆæƒ  JWT + OAuth2]
        B2[èµ„äº§ç®¡ç†  CRUDæ“ä½œ]
        B3[AIæœåŠ¡  Geminié›†æˆ]
        B4[å‘é‡æœåŠ¡  Qdrantå®¢æˆ·ç«¯]
    end

    subgraph "æ•°æ®å­˜å‚¨å±‚ (Data Layer)"
        D1[(PostgreSQL  å…³ç³»æ•°æ®)]
        D2[(Qdrant  å‘é‡æ•°æ®)]
        D3[(Redis  ç¼“å­˜+é˜Ÿåˆ—)]
        D4[(MinIO  å¯¹è±¡å­˜å‚¨)]
    end

    subgraph "å¤–éƒ¨æœåŠ¡ (External Services)"
        E1[Google Gemini  AIèƒ½åŠ›]
        E2[åœ°ç†ç¼–ç æœåŠ¡  åœ°å€è§£æ]
    end

    C1 -->|HTTP/WebSocket| A1
    C2 -->|HTTP| A1
    
    A1 --> B1
    A1 --> B2
    A1 --> B3
    A1 --> B4
    
    A2 --> B2
    A2 --> B3
    A2 --> B4
    
    B2 --> D1
    B4 --> D2
    A1 --> D3
    A2 --> D3
    B2 --> D4
    
    B3 --> E1
    B2 --> E2

    style A1 fill:#3b82f6
    style A2 fill:#10b981
    style D1 fill:#8b5cf6
    style D2 fill:#f59e0b
    style D3 fill:#ef4444
    style D4 fill:#06b6d4
```

**æ¶æ„å±‚æ¬¡è¯´æ˜**ï¼š

| å±‚æ¬¡ | ç»„ä»¶ | èŒè´£ | æŠ€æœ¯é€‰å‹ |
|-----|------|------|---------|
| **å®¢æˆ·ç«¯å±‚** | Web App | UI æ¸²æŸ“ã€ç”¨æˆ·äº¤äº’ã€çŠ¶æ€ç®¡ç† | Next.js 16 + React 19 + TypeScript |
| **åº”ç”¨æœåŠ¡å±‚** | API Gateway | è·¯ç”±åˆ†å‘ã€è¯·æ±‚éªŒè¯ã€å“åº”æ ¼å¼åŒ– | FastAPI + Pydantic |
| **åº”ç”¨æœåŠ¡å±‚** | Worker Service | å¼‚æ­¥ä»»åŠ¡å¤„ç†ã€å®šæ—¶ä»»åŠ¡ | Python + APScheduler |
| **ä¸šåŠ¡é€»è¾‘å±‚** | è®¤è¯æˆæƒ | ç”¨æˆ·è®¤è¯ã€æƒé™æ§åˆ¶ | NextAuth.js æ€æƒ³ + JWT |
| **ä¸šåŠ¡é€»è¾‘å±‚** | èµ„äº§ç®¡ç† | CRUDã€ä¸šåŠ¡è§„åˆ™ | SQLAlchemy ORM |
| **ä¸šåŠ¡é€»è¾‘å±‚** | AI æœåŠ¡ | AI èƒ½åŠ›å°è£… | Google Gemini SDK |
| **ä¸šåŠ¡é€»è¾‘å±‚** | å‘é‡æœåŠ¡ | å‘é‡æ£€ç´¢å°è£… | Qdrant Client |
| **æ•°æ®å­˜å‚¨å±‚** | PostgreSQL | ä¸šåŠ¡æ•°æ®æŒä¹…åŒ– | PostgreSQL 15 |
| **æ•°æ®å­˜å‚¨å±‚** | Qdrant | å‘é‡æ•°æ®å­˜å‚¨ | Qdrant |
| **æ•°æ®å­˜å‚¨å±‚** | Redis | ç¼“å­˜ã€ä»»åŠ¡é˜Ÿåˆ— | Redis 7 |
| **æ•°æ®å­˜å‚¨å±‚** | MinIO | æ–‡ä»¶å¯¹è±¡å­˜å‚¨ | MinIO (S3å…¼å®¹) |

#### 4.1.1 å‰ç«¯æ¶æ„ï¼ˆNext.jsï¼‰

**æ¶æ„æ¨¡å¼**ï¼šNext.js App Router + React Server Components + Client Components

```mermaid
graph LR
    A[Next.js App Router] --> B[Server Components  æ•°æ®è·å–]
    A --> C[Client Components  äº¤äº’é€»è¾‘]
    
    B --> D[RSCæ¸²æŸ“  æœåŠ¡ç«¯]
    C --> E[å®¢æˆ·ç«¯äº¤äº’  æµè§ˆå™¨]
    
    D --> F[HTMLæµå¼ä¼ è¾“]
    E --> G[Hydration]
    
    F --> H[æœ€ç»ˆé¡µé¢]
    G --> H
    
    I[Zustand Store] --> C
    J[TanStack Query] --> C
    K[API Client] --> C
    
    style B fill:#3b82f6
    style C fill:#10b981
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- **Server Components**ï¼šåœ¨æœåŠ¡ç«¯è·å–æ•°æ®ï¼Œå‡å°‘å®¢æˆ·ç«¯è´Ÿæ‹…
- **Client Components**ï¼šå¤„ç†ç”¨æˆ·äº¤äº’ã€çŠ¶æ€ç®¡ç†ã€åŠ¨ç”»æ•ˆæœ
- **çŠ¶æ€ç®¡ç†**ï¼šZustand è½»é‡çº§å…¨å±€çŠ¶æ€ + TanStack Query æœåŠ¡ç«¯çŠ¶æ€
- **UI ç»„ä»¶**ï¼šshadcn/ui ç»„ä»¶åº“ï¼ŒåŸºäº Radix UIï¼Œå®Œå…¨å¯æ§

#### 4.1.2 åç«¯æ¶æ„ï¼ˆFastAPIï¼‰

**åˆ†å±‚æ¶æ„**ï¼š

```mermaid
graph TD
    A[HTTPè¯·æ±‚] --> B[è·¯ç”±å±‚  Routers]
    B --> C[ä¸­é—´ä»¶å±‚  Middleware]
    C --> D[è®¤è¯å±‚  Auth]
    D --> E[ä¸šåŠ¡é€»è¾‘å±‚  Services]
    E --> F[æ•°æ®è®¿é—®å±‚  Models/ORM]
    F --> G[æ•°æ®åº“  PostgreSQL]
    
    E --> H[å¤–éƒ¨æœåŠ¡è°ƒç”¨]
    H --> I[Gemini API]
    H --> J[Qdrant]
    H --> K[MinIO]
    
    style B fill:#3b82f6
    style E fill:#10b981
    style F fill:#8b5cf6
```

**èŒè´£åˆ’åˆ†**ï¼š
- **è·¯ç”±å±‚**ï¼šå®šä¹‰ API ç«¯ç‚¹ï¼Œå‚æ•°éªŒè¯ï¼Œå“åº”æ ¼å¼åŒ–
- **ä¸­é—´ä»¶å±‚**ï¼šCORSã€è¯·æ±‚æ—¥å¿—ã€é”™è¯¯å¤„ç†ã€é€Ÿç‡é™åˆ¶
- **è®¤è¯å±‚**ï¼šJWT éªŒè¯ã€ç”¨æˆ·æƒé™æ£€æŸ¥
- **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šæ ¸å¿ƒä¸šåŠ¡è§„åˆ™ã€äº‹åŠ¡ç®¡ç†
- **æ•°æ®è®¿é—®å±‚**ï¼šæ•°æ®åº“æ“ä½œå°è£…ï¼ŒORM æ˜ å°„

#### 4.1.3 æ•°æ®å­˜å‚¨å±‚

**å¤šæ•°æ®åº“ååŒæ¶æ„**ï¼š

```mermaid
graph TB
    A[åº”ç”¨å±‚] --> B{æ•°æ®ç±»å‹}
    
    B -->|å…³ç³»æ•°æ®| C[PostgreSQL]
    B -->|å‘é‡æ•°æ®| D[Qdrant]
    B -->|ç¼“å­˜æ•°æ®| E[Redis]
    B -->|æ–‡ä»¶æ•°æ®| F[MinIO]
    
    C --> C1[ç”¨æˆ·/èµ„äº§/ç›¸å†Œ  ç»“æ„åŒ–æ•°æ®]
    D --> D1[å‘é‡åµŒå…¥  768ç»´å‘é‡]
    E --> E1[Session/ç¼“å­˜  ä»»åŠ¡é˜Ÿåˆ—]
    F --> F1[åŸå§‹æ–‡ä»¶  ç¼©ç•¥å›¾]
    
    style C fill:#8b5cf6
    style D fill:#f59e0b
    style E fill:#ef4444
    style F fill:#06b6d4
```

**æ•°æ®æµè½¬**ï¼š
- **å†™å…¥è·¯å¾„**ï¼šä¸Šä¼  â†’ PostgreSQLï¼ˆå…ƒæ•°æ®ï¼‰â†’ MinIOï¼ˆæ–‡ä»¶ï¼‰â†’ Worker â†’ Qdrantï¼ˆå‘é‡ï¼‰
- **è¯»å–è·¯å¾„**ï¼šæŸ¥è¯¢ â†’ Redisï¼ˆç¼“å­˜ï¼‰â†’ PostgreSQL/Qdrant â†’ è¿”å›ç»“æœ

#### 4.1.4 ä»»åŠ¡å¤„ç†å±‚

**å¼‚æ­¥ä»»åŠ¡å¤„ç†æ¶æ„**ï¼š

```mermaid
sequenceDiagram
    participant API as FastAPI
    participant Redis as Redis Queue
    participant Worker as Worker Service
    participant DB as PostgreSQL
    participant AI as Gemini API

    API->>Redis: å…¥é˜Ÿä»»åŠ¡  èµ„äº§å¤„ç†
    Redis-->>API: è¿”å›ä»»åŠ¡ID
    
    Worker->>Redis: ç›‘å¬é˜Ÿåˆ—
    Redis-->>Worker: åˆ†å‘ä»»åŠ¡
    
    Worker->>DB: è·å–èµ„äº§ä¿¡æ¯
    Worker->>Worker: ç”Ÿæˆç¼©ç•¥å›¾
    
    Worker->>AI: è°ƒç”¨AIåˆ†æ
    AI-->>Worker: è¿”å›æ ‡ç­¾/æè¿°
    
    Worker->>AI: ç”Ÿæˆå‘é‡åµŒå…¥
    AI-->>Worker: è¿”å›768ç»´å‘é‡
    
    Worker->>DB: æ›´æ–°èµ„äº§çŠ¶æ€
    Worker->>DB: ä¿å­˜AIç»“æœ
    
    Worker->>Redis: æ ‡è®°ä»»åŠ¡å®Œæˆ
```

**ä»»åŠ¡ç±»å‹**ï¼š
- **èµ„äº§å¤„ç†**ï¼šç¼©ç•¥å›¾ç”Ÿæˆã€EXIF æå–ã€AI åˆ†æã€å‘é‡åŒ–
- **å®šæ—¶ä»»åŠ¡**ï¼šç›¸å†Œå»ºè®®ç”Ÿæˆã€æ•°æ®æ¸…ç†ã€ç»Ÿè®¡è®¡ç®—
- **æ‰¹é‡æ“ä½œ**ï¼šæ‰¹é‡æ ‡ç­¾ã€æ‰¹é‡ä¸‹è½½ã€æ‰¹é‡åˆ†äº«

### 4.2 æŠ€æœ¯æ ˆé€‰å‹

#### 4.2.1 å‰ç«¯æŠ€æœ¯æ ˆ

**é€‰å‹å†³ç­–æ ‘**ï¼š

```mermaid
graph TD
    A[å‰ç«¯æ¡†æ¶é€‰æ‹©] --> B{éœ€è¦SSR?}
    B -->|æ˜¯| C[Next.js vs Remix]
    B -->|å¦| D[Create React App]
    
    C --> E[é€‰æ‹©Next.js  åŸå› : App Router  ç”Ÿæ€æˆç†Ÿ]
    
    E --> F[çŠ¶æ€ç®¡ç†]
    F --> G{Zustand  è½»é‡çº§  æ— æ ·æ¿ä»£ç }
    
    E --> H[æ•°æ®è·å–]
    H --> I{TanStack Query  æœåŠ¡ç«¯çŠ¶æ€  ç¼“å­˜ç®¡ç†}
    
    E --> J[UIç»„ä»¶]
    J --> K{shadcn/ui  å®Œå…¨å¯æ§  Tailwind CSS}
    
    style E fill:#3b82f6
    style G fill:#10b981
    style I fill:#10b981
    style K fill:#f59e0b
```

**æŠ€æœ¯æ ˆè¯¦æƒ…**ï¼š

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **Next.js** | 16 | å…¨æ ˆ React æ¡†æ¶ | App Routerã€Server Componentsã€SSR/SSG |
| **TypeScript** | 5.x | ç±»å‹å®‰å…¨ | å‡å°‘è¿è¡Œæ—¶é”™è¯¯ï¼Œæå‡å¼€å‘ä½“éªŒ |
| **Tailwind CSS** | 3.x | åŸå­åŒ– CSS | å¿«é€Ÿå¼€å‘ã€ä¸€è‡´çš„è®¾è®¡ç³»ç»Ÿ |
| **shadcn/ui** | latest | UI ç»„ä»¶åº“ | å®Œå…¨å¯æ§ã€åŸºäº Radix UIã€å¯è®¿é—®æ€§ |
| **Zustand** | 4.x | çŠ¶æ€ç®¡ç† | è½»é‡ã€æ— æ ·æ¿ä»£ç ã€TypeScript å‹å¥½ |
| **TanStack Query** | 5.x | æ•°æ®è·å– | ç¼“å­˜ã€é‡è¯•ã€ä¹è§‚æ›´æ–° |
| **Framer Motion** | 10.x | åŠ¨ç”»åº“ | å£°æ˜å¼åŠ¨ç”»ã€æ€§èƒ½ä¼˜ç§€ |

#### 4.2.2 åç«¯æŠ€æœ¯æ ˆ

**é€‰å‹å¯¹æ¯”**ï¼š

```mermaid
graph LR
    A[åç«¯æ¡†æ¶] --> B{FastAPI  vs Flask vs Django}
    
    B --> C[FastAPIä¼˜åŠ¿]
    C --> C1[è‡ªåŠ¨APIæ–‡æ¡£  OpenAPI/Swagger]
    C --> C2[å¼‚æ­¥æ”¯æŒ  é«˜æ€§èƒ½]
    C --> C3[ç±»å‹éªŒè¯  Pydantic]
    C --> C4[ç°ä»£Python  ç±»å‹æç¤º]
    
    D[ORMé€‰æ‹©] --> E{SQLAlchemy  Async}
    E --> E1[æˆç†Ÿç¨³å®š]
    E --> E2[å¼‚æ­¥æ”¯æŒ]
    E --> E3[çµæ´»æŸ¥è¯¢]
    
    style C fill:#10b981
    style E fill:#10b981
```

**æŠ€æœ¯æ ˆè¯¦æƒ…**ï¼š

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” | é€‰å‹ç†ç”± |
|------|------|------|---------|
| **FastAPI** | 0.104+ | Web æ¡†æ¶ | é«˜æ€§èƒ½ã€è‡ªåŠ¨æ–‡æ¡£ã€ç±»å‹éªŒè¯ |
| **Python** | 3.11+ | ç¼–ç¨‹è¯­è¨€ | å¼‚æ­¥æ”¯æŒã€ç±»å‹æç¤ºã€AI ç”Ÿæ€ |
| **SQLAlchemy** | 2.0+ | ORM | å¼‚æ­¥æ”¯æŒã€æˆç†Ÿç¨³å®šã€çµæ´» |
| **PostgreSQL** | 15 | å…³ç³»æ•°æ®åº“ | ACIDã€JSON æ”¯æŒã€å…¨æ–‡æ£€ç´¢ |
| **Redis** | 7 | ç¼“å­˜/é˜Ÿåˆ— | é«˜æ€§èƒ½ã€ä»»åŠ¡é˜Ÿåˆ—ã€Session |
| **Qdrant** | latest | å‘é‡æ•°æ®åº“ | é«˜æ€§èƒ½ã€æ˜“éƒ¨ç½²ã€æ”¯æŒè¿‡æ»¤ |
| **MinIO** | latest | å¯¹è±¡å­˜å‚¨ | S3 å…¼å®¹ã€å¯è‡ªæ‰˜ç®¡ã€é«˜å¯ç”¨ |

#### 4.2.3 AI æœåŠ¡é€‰å‹

**Gemini API ä½¿ç”¨ç­–ç•¥**ï¼š

```mermaid
graph TB
    A[AIèƒ½åŠ›éœ€æ±‚] --> B[å›¾ç‰‡ç†è§£]
    A --> C[æ–‡æœ¬ç”Ÿæˆ]
    A --> D[å‘é‡åµŒå…¥]
    
    B --> E[gemini-3-flash-preview  å¤šæ¨¡æ€ç†è§£]
    C --> E
    D --> F[gemini-embedding-001  768ç»´å‘é‡]
    
    E --> G[è‡ªåŠ¨æ ‡ç­¾]
    E --> H[å›¾ç‰‡æè¿°]
    E --> I[OCRè¯†åˆ«]
    
    F --> J[è¯­ä¹‰æœç´¢]
    F --> K[ç›¸ä¼¼æ¨è]
    
    style E fill:#10b981
    style F fill:#f59e0b
```

**æ¨¡å‹ä½¿ç”¨åœºæ™¯**ï¼š

| æ¨¡å‹ | ç”¨é€” | è°ƒç”¨é¢‘ç‡ | æˆæœ¬ |
|------|------|---------|------|
| `gemini-3-flash-preview` | å›¾ç‰‡åˆ†æã€MCP å¯¹è¯ | æ¯æ¬¡ä¸Šä¼ ã€æœç´¢ | æŒ‰é‡è®¡è´¹ |
| `gemini-embedding-001` | å‘é‡åµŒå…¥ | æ¯æ¬¡ä¸Šä¼ ã€æœç´¢ | ç›¸å¯¹ä¾¿å®œ |
| `gemini-2.5-flash-image` | å›¾ç‰‡ç”Ÿæˆï¼ˆè§„åˆ’ï¼‰ | ä½é¢‘ | æŒ‰é‡è®¡è´¹ |

#### 4.2.4 å¼€å‘ä¸éƒ¨ç½²

**å¼€å‘å·¥å…·é“¾**ï¼š

- **ç‰ˆæœ¬æ§åˆ¶**ï¼šGit + GitHub/GitLab
- **åŒ…ç®¡ç†**ï¼špnpmï¼ˆå‰ç«¯ï¼Œæ›´å¿«çš„å®‰è£…é€Ÿåº¦ï¼‰+ pipï¼ˆåç«¯ï¼‰
- **ä»£ç è´¨é‡**ï¼šESLintï¼ˆå‰ç«¯ï¼‰+ Black/Flake8ï¼ˆåç«¯ï¼‰
- **ç±»å‹æ£€æŸ¥**ï¼šTypeScriptï¼ˆå‰ç«¯ï¼‰+ mypyï¼ˆåç«¯ï¼Œå¯é€‰ï¼‰

**éƒ¨ç½²æ¶æ„**ï¼š

```mermaid
graph TB
    A[Docker Compose] --> B[æœåŠ¡ç¼–æ’]
    
    B --> C[Web Service  Next.js]
    B --> D[API Service  FastAPI]
    B --> E[Worker Service  Python]
    
    B --> F[PostgreSQL  æ•°æ®å·æŒä¹…åŒ–]
    B --> G[Redis  å†…å­˜æ•°æ®]
    B --> H[Qdrant  å‘é‡æ•°æ®å·]
    B --> I[MinIO  æ–‡ä»¶å­˜å‚¨å·]
    
    C --> J[ç«¯å£: 32333]
    D --> K[ç«¯å£: 34257]
    
    style A fill:#3b82f6
    style B fill:#10b981
```

### 4.3 ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

**æ¨¡å—èŒè´£åˆ’åˆ†**ï¼š

```mermaid
graph TB
    subgraph "å‰ç«¯æ¨¡å— (apps/web)"
        F1[é¡µé¢è·¯ç”±  appç›®å½•]
        F2[UIç»„ä»¶  components]
        F3[çŠ¶æ€ç®¡ç†  store]
        F4[APIå®¢æˆ·ç«¯  lib/api]
        F5[å·¥å…·å‡½æ•°  lib/utils]
    end
    
    subgraph "åç«¯æ¨¡å— (apps/api)"
        B1[è·¯ç”±å±‚  routers]
        B2[ä¸šåŠ¡é€»è¾‘  services]
        B3[æ•°æ®æ¨¡å‹  models]
        B4[æ•°æ®éªŒè¯  schemas]
        B5[å·¥å…·ç±»  utils]
    end
    
    subgraph "Workeræ¨¡å— (apps/worker)"
        W1[ä»»åŠ¡å¤„ç†å™¨  tasks]
        W2[å®šæ—¶ä»»åŠ¡  schedulers]
        W3[AIæœåŠ¡  gemini]
    end
    
    F1 --> F2
    F2 --> F3
    F3 --> F4
    F4 --> B1
    
    B1 --> B2
    B2 --> B3
    B2 --> B4
    
    W1 --> B2
    W1 --> W3
    
    style F1 fill:#3b82f6
    style B1 fill:#10b981
    style W1 fill:#f59e0b
```

**æ¨¡å—é—´ä¾èµ–å…³ç³»**ï¼š

- **å‰ç«¯ â†’ åç«¯**ï¼šé€šè¿‡ REST API é€šä¿¡
- **Worker â†’ åç«¯**ï¼šå…±äº«æ•°æ®åº“å’Œä¸šåŠ¡é€»è¾‘æœåŠ¡
- **æ‰€æœ‰æ¨¡å— â†’ æ•°æ®åº“**ï¼šé€šè¿‡ ORM è®¿é—®
- **æ‰€æœ‰æ¨¡å— â†’ å¤–éƒ¨æœåŠ¡**ï¼šé€šè¿‡ HTTP å®¢æˆ·ç«¯è®¿é—®

### 4.3 ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

[å¾…å±•å¼€ï¼šè¯¦ç»†è¯´æ˜å„æ¨¡å—èŒè´£]

---

## 5. åŸºæœ¬åŠŸèƒ½å®ç°

> æœ¬èŠ‚è¯¦ç»†è¯´æ˜è¯¾ç¨‹è¦æ±‚çš„ 11 é¡¹åŸºæœ¬åŠŸèƒ½çš„å®ç°ç»†èŠ‚ï¼Œé‡ç‚¹é˜è¿°å®ç°åŸç†ã€è®¾è®¡æ€è·¯å’Œæœ€ç»ˆå‘ˆç°çš„åŠŸèƒ½

### 5.1 ç”¨æˆ·æ³¨å†Œä¸ç™»å½•åŠŸèƒ½

#### 5.1.1 åŠŸèƒ½å®ç°æ¦‚è¿°

ç”¨æˆ·ç®¡ç†æ˜¯ç³»ç»Ÿçš„åŸºç¡€åŠŸèƒ½ï¼ŒZmage å®ç°äº†å®Œæ•´çš„æ³¨å†Œã€ç™»å½•ã€è®¤è¯ä½“ç³»ï¼Œå¹¶åœ¨å®‰å…¨æ€§æ–¹é¢åšäº†å……åˆ†ä¿éšœã€‚

**åŠŸèƒ½æµç¨‹å›¾**ï¼š

```mermaid
stateDiagram-v2
    [*] --> æœªç™»å½•
    æœªç™»å½• --> æ³¨å†Œ: ç‚¹å‡»æ³¨å†Œ
    æœªç™»å½• --> ç™»å½•: å·²æœ‰è´¦å·
    
    æ³¨å†Œ --> éªŒè¯ä¿¡æ¯: å¡«å†™è¡¨å•
    éªŒè¯ä¿¡æ¯ --> æ£€æŸ¥å”¯ä¸€æ€§: å‰ç«¯éªŒè¯é€šè¿‡
    æ£€æŸ¥å”¯ä¸€æ€§ --> åˆ›å»ºç”¨æˆ·: ç”¨æˆ·å/é‚®ç®±å¯ç”¨
    æ£€æŸ¥å”¯ä¸€æ€§ --> æ³¨å†Œå¤±è´¥: å·²å­˜åœ¨
    
    åˆ›å»ºç”¨æˆ· --> å“ˆå¸Œå¯†ç 
    å“ˆå¸Œå¯†ç  --> ä¿å­˜æ•°æ®åº“
    ä¿å­˜æ•°æ®åº“ --> æ³¨å†ŒæˆåŠŸ
    æ³¨å†ŒæˆåŠŸ --> ç™»å½•çŠ¶æ€
    
    ç™»å½• --> éªŒè¯å‡­è¯: è¾“å…¥ç”¨æˆ·åå¯†ç 
    éªŒè¯å‡­è¯ --> ç”ŸæˆToken: éªŒè¯æˆåŠŸ
    éªŒè¯å‡­è¯ --> ç™»å½•å¤±è´¥: ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯
    
    ç”ŸæˆToken --> ç™»å½•çŠ¶æ€
    ç™»å½•çŠ¶æ€ --> è®¿é—®å—ä¿æŠ¤èµ„æº
    è®¿é—®å—ä¿æŠ¤èµ„æº --> éªŒè¯Token: æ¯æ¬¡è¯·æ±‚
    éªŒè¯Token --> æˆæƒé€šè¿‡: Tokenæœ‰æ•ˆ
    éªŒè¯Token --> é‡æ–°ç™»å½•: Tokenæ— æ•ˆ/è¿‡æœŸ
    
    æˆæƒé€šè¿‡ --> è®¿é—®å—ä¿æŠ¤èµ„æº
```

#### 5.1.2 æ ¸å¿ƒå®ç°è¦ç‚¹

**å¯†ç å®‰å…¨**ï¼š
- ä½¿ç”¨ `pbkdf2_sha256` ç®—æ³•è¿›è¡Œå¯†ç å“ˆå¸Œ
- è‡ªåŠ¨åŠ ç›ï¼Œæ¯ä¸ªå¯†ç éƒ½æœ‰å”¯ä¸€çš„ç›å€¼
- ç»ä¸å­˜å‚¨æ˜æ–‡å¯†ç 

**Token æœºåˆ¶**ï¼š
- JWT (JSON Web Token) æ— çŠ¶æ€è®¤è¯
- Token åŒ…å«ç”¨æˆ·æ ‡è¯†å’Œè¿‡æœŸæ—¶é—´
- å‰ç«¯å­˜å‚¨åœ¨ LocalStorageï¼Œæ¯æ¬¡è¯·æ±‚æºå¸¦åœ¨ Header

**å”¯ä¸€æ€§æ ¡éªŒ**ï¼š
- æ•°æ®åº“å±‚é¢ï¼šç”¨æˆ·åã€é‚®ç®±å­—æ®µè®¾ç½® `UNIQUE` çº¦æŸ
- åº”ç”¨å±‚é¢ï¼šæ³¨å†Œå‰ä¸»åŠ¨æ£€æŸ¥ï¼Œæå‰è¿”å›å‹å¥½é”™è¯¯ä¿¡æ¯

#### 5.1.3 ç”¨æˆ·äº¤äº’è®¾è®¡

**æ³¨å†Œè¡¨å•**ï¼š
- å®æ—¶éªŒè¯ï¼šè¾“å…¥æ—¶å³æ—¶æ£€æŸ¥æ ¼å¼
- å”¯ä¸€æ€§æç¤ºï¼šå¤±ç„¦æ—¶æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å¯ç”¨
- å¯†ç å¼ºåº¦æŒ‡ç¤ºï¼šæ˜¾ç¤ºå¯†ç å¼ºåº¦ï¼ˆå¼±/ä¸­/å¼ºï¼‰

**ç™»å½•è¡¨å•**ï¼š
- æ”¯æŒç”¨æˆ·åæˆ–é‚®ç®±ç™»å½•
- è®°ä½æˆ‘åŠŸèƒ½ï¼šå»¶é•¿ Token æœ‰æ•ˆæœŸ
- é”™è¯¯æç¤ºï¼šæ˜ç¡®çš„é”™è¯¯ä¿¡æ¯ï¼Œä¸æ³„éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ»¡è¶³è¯¾ç¨‹è¦æ±‚çš„æ‰€æœ‰éªŒè¯è§„åˆ™

### 5.2 å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½

#### 5.2.1 åŠŸèƒ½å®ç°æ¦‚è¿°

å›¾ç‰‡ä¸Šä¼ æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒå…¥å£åŠŸèƒ½ï¼ŒZmage å®ç°äº†å¤šç§ä¸Šä¼ æ–¹å¼ï¼Œå¹¶æ”¯æŒè‡ªåŠ¨å¤„ç†å’Œåˆ†æã€‚

**ä¸Šä¼ æ–¹å¼æ”¯æŒ**ï¼š

```mermaid
graph TD
  R["ä¸Šä¼ æ–¹å¼"]

  %% æ‹–æ‹½ä¸Šä¼ 
  R --> A["æ‹–æ‹½ä¸Šä¼ "]
  A --> A1["æ‹–æ‹½åˆ°é¡µé¢åŒºåŸŸ"]
  A --> A2["æ‹–æ‹½åˆ°æŒ‡å®šæ–‡ä»¶å¤¹"]

  %% ç‚¹å‡»ä¸Šä¼ 
  R --> B["ç‚¹å‡»ä¸Šä¼ "]
  B --> B1["æ–‡ä»¶é€‰æ‹©å™¨"]
  B --> B2["å¤šæ–‡ä»¶é€‰æ‹©"]

  %% æ–‡ä»¶å¤¹ä¸Šä¼ 
  R --> C["æ–‡ä»¶å¤¹ä¸Šä¼ "]
  C --> C1["ä¿æŒå±‚çº§ç»“æ„"]
  C --> C2["è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶å¤¹"]

  %% URL å¯¼å…¥
  R --> D["URL å¯¼å…¥"]
  D --> D1["ç½‘ç»œå›¾ç‰‡"]
  D --> D2["å¼‚æ­¥ä¸‹è½½"]
  D --> D3["åå°å¤„ç†"]
```

#### 5.2.2 ä¸Šä¼ æµç¨‹è¯¦è§£

**å®Œæ•´ä¸Šä¼ æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant API as FastAPI
    participant DB as PostgreSQL
    participant S as MinIO
    participant W as Worker

    U->>F: é€‰æ‹©æ–‡ä»¶/æ‹–æ‹½
    F->>F: å‰ç«¯éªŒè¯  æ ¼å¼/å¤§å°
    F->>API: POST /assets/upload  multipart/form-data
    
    API->>API: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
    API->>DB: æ£€æŸ¥æ˜¯å¦é‡å¤
    alt æ–‡ä»¶å·²å­˜åœ¨
        DB-->>API: è¿”å›ç°æœ‰èµ„äº§
        API-->>F: è·³è¿‡ä¸Šä¼ 
    else æ–°æ–‡ä»¶
        API->>S: ä¸Šä¼ åŸå§‹æ–‡ä»¶
        S-->>API: è¿”å›æ–‡ä»¶è·¯å¾„
        API->>DB: åˆ›å»ºèµ„äº§è®°å½•  status=pending
        DB-->>API: è¿”å›èµ„äº§ID
        API->>W: è§¦å‘åå°ä»»åŠ¡
        API-->>F: è¿”å›ä¸Šä¼ æˆåŠŸ
    end
    
    Note over F,W: å¼‚æ­¥å¤„ç†
    W->>S: ä¸‹è½½åŸå§‹æ–‡ä»¶
    W->>W: ç”Ÿæˆç¼©ç•¥å›¾
    W->>S: ä¸Šä¼ ç¼©ç•¥å›¾
    W->>W: æå–EXIF
    W->>W: è°ƒç”¨AIåˆ†æ
    W->>DB: æ›´æ–°èµ„äº§ä¿¡æ¯  status=ready
    
    F->>F: åˆ·æ–°èµ„äº§åˆ—è¡¨
```

**å…³é”®æŠ€æœ¯å®ç°**ï¼š

1. **é‡å¤æ£€æµ‹**ï¼šåŸºäº SHA256 æ–‡ä»¶å“ˆå¸Œï¼Œç›¸åŒæ–‡ä»¶åªå­˜å‚¨ä¸€ä»½
2. **å¼‚æ­¥å¤„ç†**ï¼šä¸Šä¼ ç«‹å³è¿”å›ï¼Œåå° Worker å¤„ç†è€—æ—¶æ“ä½œ
3. **è¿›åº¦è¿½è¸ª**ï¼šå‰ç«¯å®æ—¶æ˜¾ç¤ºä¸Šä¼ è¿›åº¦æ¡
4. **é”™è¯¯å¤„ç†**ï¼šç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•ï¼Œæ ¼å¼é”™è¯¯å‹å¥½æç¤º

#### 5.2.3 ç”¨æˆ·ä½“éªŒä¼˜åŒ–

- **æ‹–æ‹½æç¤º**ï¼šæ‹–æ‹½æ—¶æ˜¾ç¤ºé«˜äº®è¾¹æ¡†å’Œæç¤ºæ–‡å­—
- **æ‰¹é‡ä¸Šä¼ **ï¼šæ”¯æŒåŒæ—¶ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼Œæ˜¾ç¤ºæ¯ä¸ªæ–‡ä»¶çš„çŠ¶æ€
- **æ–‡ä»¶å¤¹ç»“æ„**ï¼šä¸Šä¼ æ–‡ä»¶å¤¹æ—¶è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿæ–‡ä»¶å¤¹å±‚çº§
- **ä¸Šä¼ é˜Ÿåˆ—**ï¼šå¤§æ–‡ä»¶æ’é˜Ÿä¸Šä¼ ï¼Œé¿å…å¹¶å‘è¿‡å¤š

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒæ‰€æœ‰ä¸»æµå›¾ç‰‡æ ¼å¼å’Œè§†é¢‘æ ¼å¼

### 5.3 EXIF ä¿¡æ¯æå–ä¸è‡ªåŠ¨åˆ†ç±»

#### 5.3.1 åŠŸèƒ½æè¿°
[å¾…å±•å¼€]

#### 5.3.2 EXIF ä¿¡æ¯æå–å®ç°

**æå–æµç¨‹**ï¼š

```mermaid
flowchart TD
    A[å›¾ç‰‡ä¸Šä¼ ] --> B[Workerä»»åŠ¡è§¦å‘]
    B --> C[è¯»å–å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®]
    C --> D[exifråº“è§£æ]
    
    D --> E{EXIFå­—æ®µ}
    E -->|DateTimeOriginal| F[è§£ææ‹æ‘„æ—¶é—´  æ ¼å¼: YYYY:MM:DD HH:MM:SS]
    E -->|GPSåæ ‡| G[è½¬æ¢ç»çº¬åº¦  åº¦åˆ†ç§’->åè¿›åˆ¶åº¦]
    E -->|Image Model| H[æå–ç›¸æœºå‹å·]
    E -->|å…¶ä»–å‚æ•°| I[æå–ISO/å…‰åœˆ/å¿«é—¨/ç„¦è·]
    
    F --> J[ä¿å­˜åˆ°taken_atå­—æ®µ]
    G --> K[ä¿å­˜åˆ°latitude/longitude  åå‘åœ°ç†ç¼–ç ->location]
    H --> L[ä¿å­˜åˆ°camera_modelå­—æ®µ]
    I --> M[ä¿å­˜åˆ°exif_data JSONå­—æ®µ]
    
    J --> N[è‡ªåŠ¨ç”Ÿæˆæ—¶é—´æ ‡ç­¾]
    K --> O[è‡ªåŠ¨ç”Ÿæˆåœ°ç‚¹æ ‡ç­¾]
    H --> P[è‡ªåŠ¨ç”Ÿæˆè®¾å¤‡æ ‡ç­¾]
    
    style D fill:#10b981
    style G fill:#f59e0b
```

**å®é™…æå–çš„ EXIF å­—æ®µ**ï¼š

æ ¹æ®ä»£ç å®ç° (`apps/api/src/services/asset.py`)ï¼Œç³»ç»Ÿæå–ä»¥ä¸‹ä¿¡æ¯ï¼š

| EXIF æ ‡ç­¾ | æå–å­—æ®µ | ç”¨é€” |
|----------|---------|------|
| `EXIF DateTimeOriginal` | `taken_at` | æ‹æ‘„æ—¶é—´ï¼Œç”¨äºæ—¶é—´çº¿æ’åº |
| `GPS GPSLatitude` / `GPS GPSLongitude` | `latitude` / `longitude` | GPS åæ ‡ï¼Œç”¨äºåœ°å›¾å±•ç¤º |
| `Image Model` | `camera_model` | ç›¸æœºå‹å·ï¼Œç”¨äºè®¾å¤‡ç­›é€‰ |
| `Image Make` | `exif_data.make` | ç›¸æœºå“ç‰Œ |
| `EXIF ISOSpeedRatings` | `exif_data.iso` | ISO æ„Ÿå…‰åº¦ |
| `EXIF FocalLength` | `exif_data.focal_length` | ç„¦è· |
| `EXIF ExposureTime` | `exif_data.exposure_time` | å¿«é—¨é€Ÿåº¦ |

**GPS åæ ‡è½¬æ¢ç®—æ³•**ï¼š

```python
# ä»åº¦åˆ†ç§’æ ¼å¼è½¬æ¢ä¸ºåè¿›åˆ¶åº¦
lat_deg = float(lat[0]) + float(lat[1]) / 60 + float(lat[2]) / 3600
lon_deg = float(lon[0]) + float(lon[1]) / 60 + float(lon[2]) / 3600

# å¤„ç†å—çº¬/è¥¿ç»
if lat_ref == "S":
    lat_deg = -lat_deg
if lon_ref == "W":
    lon_deg = -lon_deg
```

#### 5.3.3 è‡ªåŠ¨æ ‡ç­¾åˆ›å»ºæœºåˆ¶

**è‡ªåŠ¨æ ‡ç­¾ç”Ÿæˆè§„åˆ™**ï¼ˆåŸºäºå®é™…ä»£ç ï¼‰ï¼š

```mermaid
graph LR
    A[EXIFæ•°æ®] --> B{æ ‡ç­¾ç±»å‹}
    
    B -->|æ—¶é—´æ ‡ç­¾| C[taken_atå­˜åœ¨?]
    C -->|æ˜¯| D["ç”ŸæˆYYYYå¹´  MMæœˆæ ‡ç­¾"]
    
    B -->|è®¾å¤‡æ ‡ç­¾| E[camera_modelå­˜åœ¨?]
    E -->|æ˜¯| F[ç”Ÿæˆç›¸æœºå‹å·æ ‡ç­¾]
    
    B -->|å°ºå¯¸æ ‡ç­¾| G[width/heightå­˜åœ¨?]
    G -->|æ˜¯| H[ç”Ÿæˆå®½xé«˜æ ‡ç­¾  å¦‚1920x1080]
    
    B -->|ä½ç½®æ ‡ç­¾| I[locationå­˜åœ¨?]
    I -->|æ˜¯| J[ç”Ÿæˆæœ‰åœ°ç†ä¿¡æ¯æ ‡ç­¾]
    
    D --> K[åˆå¹¶åˆ°tagsæ•°ç»„]
    F --> K
    H --> K
    J --> K
    
    style D fill:#3b82f6
    style F fill:#10b981
    style H fill:#f59e0b
```

**æ ‡ç­¾ç”Ÿæˆä»£ç é€»è¾‘**ï¼š

ç³»ç»Ÿåœ¨åˆ›å»ºèµ„äº§æ—¶è‡ªåŠ¨ç”Ÿæˆ EXIF æ ‡ç­¾ï¼š
- æ—¶é—´æ ‡ç­¾ï¼šåŸºäº `taken_at` ç”Ÿæˆå¹´ã€æœˆæ ‡ç­¾
- è®¾å¤‡æ ‡ç­¾ï¼šç›´æ¥ä½¿ç”¨ `camera_model` ä½œä¸ºæ ‡ç­¾
- å°ºå¯¸æ ‡ç­¾ï¼šæ ¼å¼ä¸º `{width}x{height}`
- ä½ç½®æ ‡ç­¾ï¼šä»…æ ‡è®°"æœ‰åœ°ç†ä¿¡æ¯"ï¼Œå…·ä½“åœ°ç‚¹éœ€é€šè¿‡åå‘åœ°ç†ç¼–ç è·å–

#### 5.3.4 åœ°ç†ä½ç½®å¤„ç†

**åœ°å›¾åŠŸèƒ½æ”¯æŒ**ï¼š

ç³»ç»Ÿæä¾›ä¸“é—¨çš„ API ç«¯ç‚¹è·å–æœ‰ä½ç½®ä¿¡æ¯çš„èµ„äº§ï¼š

```python
@router.get("/map")
async def list_map_assets(...):
    """è·å–æ‰€æœ‰å…·æœ‰ç»çº¬åº¦ä¿¡æ¯çš„èµ„äº§ï¼Œç”¨äºåœ°å›¾å±•ç¤º"""
    query = select(Asset).where(
        Asset.latitude.isnot(None),
        Asset.longitude.isnot(None),
        Asset.status == AssetStatus.READY,
    )
```

**åœ°å›¾æ ‡è®°å®ç°**ï¼š
- ä½¿ç”¨ Leaflet åœ°å›¾åº“
- æ¯ä¸ªæœ‰ GPS ä¿¡æ¯çš„èµ„äº§åœ¨åœ°å›¾ä¸Šæ˜¾ç¤ºä¸ºæ ‡è®°ç‚¹
- æ ‡è®°æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œå®Œæ•´æ”¯æŒ EXIF æå–ã€è‡ªåŠ¨æ ‡ç­¾å’Œåœ°å›¾å±•ç¤º

### 5.4 è‡ªå®šä¹‰æ ‡ç­¾ç³»ç»Ÿ

#### 5.4.1 åŠŸèƒ½æè¿°
[å¾…å±•å¼€]

#### 5.4.2 å®ç°æ–¹æ¡ˆ
- **æ ‡ç­¾åˆ›å»º**ï¼šç”¨æˆ·æ‰‹åŠ¨æ·»åŠ æ ‡ç­¾
- **æ ‡ç­¾å…³è”**ï¼šå›¾ç‰‡ä¸æ ‡ç­¾å¤šå¯¹å¤šå…³ç³»
- **æ ‡ç­¾ç®¡ç†**ï¼šæ ‡ç­¾åˆ—è¡¨ã€ç¼–è¾‘ã€åˆ é™¤
- **æ ‡ç­¾æœç´¢**ï¼šåŸºäºæ ‡ç­¾ç­›é€‰å›¾ç‰‡

### 5.5 ç¼©ç•¥å›¾ç”Ÿæˆ

#### 5.5.1 åŠŸèƒ½å®ç°æ¦‚è¿°

ç¼©ç•¥å›¾æ˜¯æå‡æµè§ˆæ€§èƒ½çš„å…³é”®ï¼ŒZmage å®ç°äº†è‡ªåŠ¨ç¼©ç•¥å›¾ç”Ÿæˆï¼Œæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘ä¸¤ç§ç±»å‹ã€‚

**ç¼©ç•¥å›¾ç”Ÿæˆæµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant W as Worker
    participant S as StorageService
    participant P as PIL/Pillow
    participant M as MinIO

    W->>W: æ¥æ”¶èµ„äº§å¤„ç†ä»»åŠ¡
    W->>M: ä¸‹è½½åŸå§‹æ–‡ä»¶
    
    alt å›¾ç‰‡ç±»å‹
        W->>S: generate_thumbnail()
        S->>P: Image.open()
        P->>P: convert RGBA->RGB  å¦‚éœ€è¦
        P->>P: thumbnail(400x400)  LANCZOSé‡é‡‡æ ·
        P->>P: save JPEG  quality=85
        P-->>S: è¿”å›ç¼©ç•¥å›¾å­—èŠ‚
        S->>M: ä¸Šä¼ ç¼©ç•¥å›¾  thumbnails/{filename}.jpg
    else è§†é¢‘ç±»å‹
        W->>S: generate_video_thumbnail()
        S->>S: OpenCVè¯»å–è§†é¢‘  æå–ç¬¬1ç§’å¸§
        S->>P: Image.fromarray()
        P->>P: thumbnail(400x400)
        P->>P: save JPEG
        P-->>S: è¿”å›å°é¢å¸§å­—èŠ‚
        S->>M: ä¸Šä¼ å°é¢  thumbnails/{filename}.jpg
    end
    
    W->>W: æ›´æ–°asset.thumbnail_path
    W->>W: ä¿å­˜åˆ°æ•°æ®åº“
```

#### 5.5.2 ç¼©ç•¥å›¾ç”Ÿæˆå‚æ•°

**å®é™…å®ç°å‚æ•°**ï¼ˆåŸºäº `storage.py`ï¼‰ï¼š

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|---|------|
| **æœ€å¤§å°ºå¯¸** | 400x400 åƒç´  | ä¿æŒå®½é«˜æ¯”ï¼Œé™åˆ¶æœ€å¤§è¾¹ |
| **æ ¼å¼** | JPEG | ç»Ÿä¸€æ ¼å¼ï¼Œå…¼å®¹æ€§å¥½ |
| **è´¨é‡** | 85% | å¹³è¡¡æ–‡ä»¶å¤§å°å’Œè§†è§‰æ•ˆæœ |
| **é‡é‡‡æ ·ç®—æ³•** | LANCZOS | é«˜è´¨é‡ç¼©æ”¾ç®—æ³• |
| **é¢œè‰²ç©ºé—´** | RGB | è‡ªåŠ¨è½¬æ¢ RGBA/P æ¨¡å¼ |

**è§†é¢‘å°é¢æå–ç­–ç•¥**ï¼š
- ä¼˜å…ˆæå–ç¬¬ 1 ç§’çš„å¸§ï¼ˆé¿å…é»‘å±å¼€å¤´ï¼‰
- å¦‚æœç¬¬ 1 ç§’å¤±è´¥ï¼Œå°è¯•ç¬¬ 0 ç§’
- ä½¿ç”¨ OpenCV è¯»å–è§†é¢‘å¸§ï¼Œè½¬æ¢ä¸º PIL Image

#### 5.5.3 å­˜å‚¨ä¸è®¿é—®

**å­˜å‚¨è·¯å¾„è§„èŒƒ**ï¼š
- å›¾ç‰‡ç¼©ç•¥å›¾ï¼š`thumbnails/{asset_id}_{timestamp}.jpg`
- è§†é¢‘å°é¢ï¼šåŒå›¾ç‰‡è·¯å¾„è§„èŒƒ
- ç¼–è¾‘ç‰ˆæœ¬ç¼©ç•¥å›¾ï¼šç¼–è¾‘åè‡ªåŠ¨é‡æ–°ç”Ÿæˆ

**è®¿é—®æ–¹å¼**ï¼š
- é€šè¿‡ API ä»£ç†ï¼š`/api/storage/{thumbnail_path}`
- å‰ç«¯ç›´æ¥ä½¿ç”¨ `thumbnail_url` å­—æ®µ
- æ”¯æŒ CDN åŠ é€Ÿï¼ˆè§„åˆ’ä¸­ï¼‰

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- ç¼©ç•¥å›¾å¼‚æ­¥ç”Ÿæˆï¼Œä¸å½±å“ä¸Šä¼ å“åº”æ—¶é—´
- ç”Ÿæˆå¤±è´¥æ—¶ä½¿ç”¨åŸå§‹å›¾ç‰‡ä½œä¸ºå ä½
- å‰ç«¯æ”¯æŒæ‡’åŠ è½½ï¼ŒæŒ‰éœ€åŠ è½½ç¼©ç•¥å›¾

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒå›¾ç‰‡å’Œè§†é¢‘çš„è‡ªåŠ¨ç¼©ç•¥å›¾ç”Ÿæˆ

### 5.6 æ•°æ®åº“å­˜å‚¨è®¾è®¡

#### 5.6.1 æ ¸å¿ƒæ•°æ®æ¨¡å‹

**ER å…³ç³»å›¾**ï¼š

```mermaid
erDiagram
    User ||--o{ Asset : owns
    User ||--o{ Album : creates
    User ||--o{ Folder : owns
    User ||--o{ Share : creates
    
    Asset }o--o{ Tag : has
    Asset }o--o{ Album : belongs_to
    Asset ||--o| Folder : in
    Asset ||--o{ AssetVersion : has
    
    Album }o--o{ Asset : contains
    Album ||--o| Asset : cover
    
    Share ||--o| Asset : shares
    Share ||--o| Collection : shares
    
    Asset ||--o| Asset : similar_to
    
    User {
        int id PK
        string username UK
        string email UK
        string hashed_password
        bool is_active
    }
    
    Asset {
        int id PK
        int user_id FK
        string filename
        string file_path
        string thumbnail_path
        json exif_data
        array tags
        float latitude
        float longitude
        enum status
    }
    
    Album {
        int id PK
        int user_id FK
        string name
        enum album_type
        json smart_rules
    }
```

#### 5.6.2 å­˜å‚¨ç­–ç•¥è®¾è®¡

**åˆ†å±‚å­˜å‚¨æ¶æ„**ï¼š

```mermaid
graph TB
    A[ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶] --> B[MinIOå¯¹è±¡å­˜å‚¨]
    
    B --> C[åŸå§‹æ–‡ä»¶  assets/YYYYMMDD_hash_filename]
    B --> D[ç¼©ç•¥å›¾  thumbnails/asset_id.jpg]
    B --> E[ç¼–è¾‘ç‰ˆæœ¬  versions/version_id.jpg]
    
    A --> F[PostgreSQLæ•°æ®åº“]
    F --> G[å…ƒæ•°æ®è¡¨  èµ„äº§ä¿¡æ¯/EXIF/æ ‡ç­¾]
    F --> H[å…³ç³»è¡¨  ç”¨æˆ·/ç›¸å†Œ/æ ‡ç­¾å…³è”]
    
    A --> I[Qdrantå‘é‡åº“]
    I --> J[å‘é‡åµŒå…¥  768ç»´å‘é‡]
    I --> K[å…ƒæ•°æ®  æ ‡é¢˜/æè¿°/æ ‡ç­¾]
    
    style B fill:#06b6d4
    style F fill:#8b5cf6
    style I fill:#f59e0b
```

**å­˜å‚¨è·¯å¾„è§„èŒƒ**ï¼š
- **åŸå§‹æ–‡ä»¶**ï¼š`assets/{timestamp}_{hash}_{original_filename}`
- **ç¼©ç•¥å›¾**ï¼š`thumbnails/{asset_id}.jpg`
- **ç¼–è¾‘ç‰ˆæœ¬**ï¼š`versions/{asset_id}_v{version}_{timestamp}.jpg`

#### 5.6.3 æ•°æ®ä¸€è‡´æ€§ä¿éšœ

**ä¸€è‡´æ€§ç­–ç•¥**ï¼š

| åœºæ™¯ | ç­–ç•¥ | å®ç°æ–¹å¼ |
|------|------|---------|
| **å¤–é”®å…³è”** | æ•°æ®åº“çº¦æŸ | PostgreSQL FOREIGN KEY |
| **çº§è”åˆ é™¤** | ON DELETE CASCADE | åˆ é™¤ç”¨æˆ·æ—¶çº§è”åˆ é™¤æ‰€æœ‰èµ„äº§ |
| **è½¯åˆ é™¤** | deleted_at å­—æ®µ | æ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤ |
| **äº‹åŠ¡å¤„ç†** | æ•°æ®åº“äº‹åŠ¡ | SQLAlchemy äº‹åŠ¡ç®¡ç† |
| **æ•°æ®è¿ç§»** | ç‰ˆæœ¬æ§åˆ¶ | Alembic è¿ç§»å·¥å…· |

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ•°æ®ç»“æ„è®¾è®¡åˆç†ï¼Œæ”¯æŒæ‰©å±•

### 5.7 æŸ¥è¯¢åŠŸèƒ½å®ç°

#### 5.7.1 åŸºç¡€æŸ¥è¯¢
- **å…³é”®è¯æœç´¢**ï¼šå…¨æ–‡æ£€ç´¢ï¼ˆæ–‡ä»¶åã€æè¿°ã€æ ‡ç­¾ã€OCR æ–‡æœ¬ï¼‰
- **é«˜çº§ç­›é€‰**ï¼š
  - æ—¶é—´èŒƒå›´
  - åª’ä½“ç±»å‹
  - ç›¸å†Œç­›é€‰
  - æ ‡ç­¾ç­›é€‰
  - EXIF å‚æ•°ç­›é€‰

#### 5.7.2 æ’åºåŠŸèƒ½
- ä¸Šä¼ æ—¶é—´
- æ‹æ‘„æ—¶é—´
- æ–‡ä»¶å
- æ–‡ä»¶å¤§å°
- è¯„åˆ†
- ç›¸å…³åº¦

#### 5.7.3 åˆ†é¡µæœºåˆ¶
- æ”¯æŒè‡ªå®šä¹‰æ¯é¡µæ•°é‡
- é¡µç è·³è½¬
- æ€»æ•°ç»Ÿè®¡

#### 5.7.4 æ ¸å¿ƒä»£ç 
### 5.8 å±•ç¤ºç•Œé¢å®ç°

#### 5.8.1 å¤šè§†å›¾æ¨¡å¼
- **ç½‘æ ¼è§†å›¾**ï¼šå¡ç‰‡å¼å±•ç¤ºï¼Œé€‚åˆæµè§ˆ
- **åˆ—è¡¨è§†å›¾**ï¼šè¯¦ç»†ä¿¡æ¯åˆ—è¡¨
- **ç€‘å¸ƒæµè§†å›¾**ï¼šåŠ¨æ€é«˜åº¦å¸ƒå±€

#### 5.8.2 å…¨å±é¢„è§ˆ
- å›¾ç‰‡/è§†é¢‘å…¨å±æŸ¥çœ‹
- é”®ç›˜å¯¼èˆªï¼ˆå·¦å³åˆ‡æ¢ï¼‰
- ç¼©æ”¾åŠŸèƒ½
- ä¿¡æ¯é¢æ¿

#### 5.8.3 è½®æ’­åŠŸèƒ½
- è‡ªåŠ¨æ’­æ”¾
- æ‰‹åŠ¨åˆ‡æ¢
- ç¼©ç•¥å›¾å¯¼èˆª

### 5.9 å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½

#### 5.9.1 åŠŸèƒ½å®ç°æ¦‚è¿°

Zmage æä¾›äº†å®Œæ•´çš„å›¾ç‰‡ç¼–è¾‘åŠŸèƒ½ï¼Œæ”¯æŒåŸºç¡€è°ƒæ•´å’Œé«˜çº§ç¼–è¾‘ï¼Œå¹¶å®ç°äº†ä¸“ä¸šçš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿã€‚

**ç¼–è¾‘åŠŸèƒ½çŸ©é˜µ**ï¼š

```mermaid
graph TD
  R["å›¾ç‰‡ç¼–è¾‘"]

  %% åŸºç¡€è°ƒæ•´
  R --> A["åŸºç¡€è°ƒæ•´"]
  A --> A1["è£å‰ª"]
  A1 --> A11["è‡ªç”±è£å‰ª"]
  A1 --> A12["å›ºå®šæ¯”ä¾‹"]
  A1 --> A13["1:1 / 16:9 / 4:5"]

  A --> A2["æ—‹è½¬"]
  A2 --> A21["90 åº¦æ—‹è½¬"]
  A2 --> A22["ä»»æ„è§’åº¦"]
  A2 --> A23["å¾®è°ƒï¼ˆ-45Â° ~ 45Â°ï¼‰"]

  A --> A3["ç¿»è½¬"]
  A3 --> A31["æ°´å¹³ç¿»è½¬"]
  A3 --> A32["å‚ç›´ç¿»è½¬"]

  %% è‰²è°ƒè°ƒæ•´
  R --> B["è‰²è°ƒè°ƒæ•´"]
  B --> B1["äº®åº¦"]
  B --> B2["å¯¹æ¯”åº¦"]
  B --> B3["é¥±å’Œåº¦"]
  B --> B4["é”åº¦"]

  %% é«˜çº§åŠŸèƒ½
  R --> C["é«˜çº§åŠŸèƒ½"]
  C --> C1["æ»¤é•œ"]
  C1 --> C11["é»‘ç™½ / èƒ¶ç‰‡ / é²œè‰³"]
  C1 --> C12["è‡ªå®šä¹‰æ»¤é•œ"]

  C --> C2["ç‰ˆæœ¬æ§åˆ¶"]
  C2 --> C21["ç¼–è¾‘å†å²"]
  C2 --> C22["ç‰ˆæœ¬å›é€€"]
  C2 --> C23["å¦å­˜ä¸ºæ–°ç‰ˆæœ¬"]
```

#### 5.9.2 ç¼–è¾‘æµç¨‹è®¾è®¡

**ç¼–è¾‘æ“ä½œæµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯ç¼–è¾‘å™¨
    participant API as åç«¯API
    participant E as å›¾ç‰‡å¤„ç†æœåŠ¡
    participant S as å­˜å‚¨æœåŠ¡
    participant DB as æ•°æ®åº“

    U->>F: æ‰“å¼€ç¼–è¾‘å™¨
    F->>API: GET /assets/{id}
    API-->>F: è¿”å›å›¾ç‰‡URL
    
    U->>F: åº”ç”¨ç¼–è¾‘æ“ä½œ  è£å‰ª/è°ƒè‰²/æ—‹è½¬
    F->>F: å®æ—¶é¢„è§ˆæ•ˆæœ
    
    U->>F: ç‚¹å‡»ä¿å­˜
    F->>API: POST /assets/{id}/edit  ç¼–è¾‘å‚æ•°
    
    API->>DB: æ£€æŸ¥ç‰ˆæœ¬å†å²
    alt é¦–æ¬¡ç¼–è¾‘
        API->>DB: åˆ›å»ºV1(åŸå›¾å½’æ¡£)
    end
    
    API->>S: ä¸‹è½½V1åŸå›¾
    API->>E: åº”ç”¨ç¼–è¾‘æ“ä½œ
    E->>E: è£å‰ª/è°ƒè‰²/æ—‹è½¬
    E-->>API: è¿”å›å¤„ç†åçš„å›¾ç‰‡
    
    API->>S: ä¿å­˜æ–°ç‰ˆæœ¬
    API->>DB: åˆ›å»ºç‰ˆæœ¬è®°å½•
    API->>DB: æ›´æ–°AssetæŒ‡å‘æ–°ç‰ˆæœ¬
    API->>S: é‡æ–°ç”Ÿæˆç¼©ç•¥å›¾
    
    API-->>F: è¿”å›æ›´æ–°åçš„èµ„äº§
    F->>U: æ˜¾ç¤ºç¼–è¾‘ç»“æœ
```

#### 5.9.3 ç¼–è¾‘åŠŸèƒ½è¯¦è§£

**è£å‰ªåŠŸèƒ½**ï¼š
- **è‡ªç”±è£å‰ª**ï¼šç”¨æˆ·å¯æ‹–åŠ¨è°ƒæ•´è£å‰ªæ¡†å¤§å°å’Œä½ç½®
- **å›ºå®šæ¯”ä¾‹**ï¼šæ”¯æŒ 1:1ã€16:9ã€4:5ã€3:2 ç­‰å¸¸ç”¨æ¯”ä¾‹
- **å¯è§†åŒ–å·¥å…·**ï¼šä½¿ç”¨ `react-easy-crop` æä¾›ç›´è§‚çš„è£å‰ªç•Œé¢

**è‰²è°ƒè°ƒæ•´**ï¼š
- **äº®åº¦**ï¼šèŒƒå›´ 0-200%ï¼Œé»˜è®¤ 100%
- **å¯¹æ¯”åº¦**ï¼šèŒƒå›´ 0-200%ï¼Œé»˜è®¤ 100%
- **é¥±å’Œåº¦**ï¼šèŒƒå›´ 0-200%ï¼Œé»˜è®¤ 100%
- **é”åº¦**ï¼šèŒƒå›´ -100% åˆ° +100%ï¼Œé»˜è®¤ 0%

**ç‰ˆæœ¬æ§åˆ¶**ï¼š
- æ¯æ¬¡ç¼–è¾‘è‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬
- ä¿ç•™æ‰€æœ‰å†å²ç‰ˆæœ¬ï¼Œå¯éšæ—¶å›é€€
- ç‰ˆæœ¬è®°å½•åŒ…å«ç¼–è¾‘å‚æ•°ï¼Œæ”¯æŒæŸ¥çœ‹ç¼–è¾‘å†å²

#### 5.9.4 ç”¨æˆ·ä½“éªŒ

- **å®æ—¶é¢„è§ˆ**ï¼šç¼–è¾‘æ“ä½œç«‹å³çœ‹åˆ°æ•ˆæœï¼Œæ— éœ€ç­‰å¾…
- **æ’¤é”€é‡åš**ï¼šæ”¯æŒæ“ä½œå†å²æ’¤é”€/é‡åšï¼ˆå‰ç«¯ï¼‰
- **åŸå›¾å¯¹æ¯”**ï¼šå¯éšæ—¶æŸ¥çœ‹åŸå›¾å¯¹æ¯”æ•ˆæœ
- **æ‰¹é‡åº”ç”¨**ï¼šå¯å°†ç¼–è¾‘å‚æ•°ä¿å­˜ä¸ºé¢„è®¾ï¼Œæ‰¹é‡åº”ç”¨

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ»¡è¶³è¯¾ç¨‹è¦æ±‚ï¼Œå¹¶æ‰©å±•ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½

### 5.10 åˆ é™¤åŠŸèƒ½

#### 5.10.1 è½¯åˆ é™¤æœºåˆ¶è®¾è®¡

Zmage é‡‡ç”¨**è½¯åˆ é™¤**æœºåˆ¶ï¼Œåˆ é™¤æ“ä½œä¸ä¼šç«‹å³ç‰©ç†åˆ é™¤æ–‡ä»¶ï¼Œè€Œæ˜¯æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œè¿›å…¥å›æ”¶ç«™ï¼Œæ”¯æŒæ¢å¤ã€‚

**åˆ é™¤æµç¨‹è®¾è®¡**ï¼š

```mermaid
stateDiagram-v2
    [*] --> æ­£å¸¸çŠ¶æ€
    æ­£å¸¸çŠ¶æ€ --> å›æ”¶ç«™: åˆ é™¤æ“ä½œ  è®¾ç½®deleted_at
    å›æ”¶ç«™ --> æ­£å¸¸çŠ¶æ€: æ¢å¤æ“ä½œ  æ¸…ç©ºdeleted_at
    å›æ”¶ç«™ --> æ°¸ä¹…åˆ é™¤: å½»åº•åˆ é™¤  ç‰©ç†åˆ é™¤æ–‡ä»¶
    
    æ°¸ä¹…åˆ é™¤ --> [*]
    
    note right of å›æ”¶ç«™
        è½¯åˆ é™¤æ ‡è®°
        deleted_at != NULL
        æ–‡ä»¶ä»å­˜åœ¨
        å¯æ¢å¤
    end note
    
    note right of æ°¸ä¹…åˆ é™¤
        ç‰©ç†åˆ é™¤
        åˆ é™¤æ•°æ®åº“è®°å½•
        åˆ é™¤å­˜å‚¨æ–‡ä»¶
        ä¸å¯æ¢å¤
    end note
```

**åˆ é™¤ç­–ç•¥**ï¼š

| æ“ä½œç±»å‹ | è¡Œä¸º | å¯æ¢å¤ | æ–‡ä»¶åˆ é™¤ |
|---------|------|--------|---------|
| **åˆ é™¤** | è®¾ç½® `deleted_at` | âœ… æ˜¯ | âŒ å¦ |
| **æ¢å¤** | æ¸…ç©º `deleted_at` | - | - |
| **å½»åº•åˆ é™¤** | åˆ é™¤è®°å½• + æ–‡ä»¶ | âŒ å¦ | âœ… æ˜¯ |

#### 5.10.2 å›æ”¶ç«™åŠŸèƒ½

**å›æ”¶ç«™ç‰¹æ€§**ï¼š
- **è‡ªåŠ¨ç­›é€‰**ï¼šæ‰€æœ‰æŸ¥è¯¢è‡ªåŠ¨æ’é™¤ `deleted_at != NULL` çš„è®°å½•
- **ç‹¬ç«‹å…¥å£**ï¼šæä¾›å›æ”¶ç«™é¡µé¢ï¼ŒæŸ¥çœ‹å·²åˆ é™¤èµ„äº§
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡æ¢å¤ã€æ‰¹é‡å½»åº•åˆ é™¤
- **è‡ªåŠ¨æ¸…ç†**ï¼šå¯è®¾ç½®å›æ”¶ç«™ä¿ç•™æœŸé™ï¼ˆè§„åˆ’ä¸­ï¼‰

#### 5.10.3 æ‰¹é‡åˆ é™¤å®ç°

**æ‰¹é‡åˆ é™¤æµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant API as åç«¯
    participant DB as æ•°æ®åº“

    U->>F: å¤šé€‰èµ„äº§
    U->>F: ç‚¹å‡»æ‰¹é‡åˆ é™¤
    F->>F: æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    
    alt ç”¨æˆ·ç¡®è®¤
        F->>API: POST /assets/batch/delete  asset_ids[]
        API->>DB: æ‰¹é‡æ›´æ–°deleted_at
        DB-->>API: æ›´æ–°æˆåŠŸæ•°é‡
        API-->>F: è¿”å›åˆ é™¤ç»“æœ
        F->>F: åˆ·æ–°åˆ—è¡¨
        F->>U: æ˜¾ç¤ºæˆåŠŸæç¤º
    else ç”¨æˆ·å–æ¶ˆ
        F->>F: å…³é—­å¯¹è¯æ¡†
    end
```

**å®‰å…¨æ€§ä¿éšœ**ï¼š
- **äºŒæ¬¡ç¡®è®¤**ï¼šæ‰¹é‡åˆ é™¤éœ€è¦ç¡®è®¤å¯¹è¯æ¡†
- **æƒé™æ£€æŸ¥**ï¼šåªèƒ½åˆ é™¤è‡ªå·±çš„èµ„äº§
- **äº‹åŠ¡å¤„ç†**ï¼šæ‰¹é‡æ“ä½œä½¿ç”¨äº‹åŠ¡ï¼Œä¿è¯ä¸€è‡´æ€§

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ”¯æŒå•ä¸ªåˆ é™¤ã€æ‰¹é‡åˆ é™¤å’Œå›æ”¶ç«™åŠŸèƒ½

### 5.11 ç§»åŠ¨ç«¯é€‚é…

#### 5.11.1 å“åº”å¼è®¾è®¡
- æ–­ç‚¹è®¾è®¡ï¼ˆsm, md, lg, xlï¼‰
- å¼¹æ€§å¸ƒå±€
- è§¦æ‘¸ä¼˜åŒ–

#### 5.11.2 ç§»åŠ¨ç«¯ç‰¹æ€§
- è§¦æ‘¸æ‰‹åŠ¿ï¼ˆæ»‘åŠ¨ã€ç¼©æ”¾ã€é•¿æŒ‰ï¼‰
- ç§»åŠ¨ç«¯å¯¼èˆª
- åŸç”Ÿç›¸å†Œè°ƒç”¨ï¼ˆè§„åˆ’ä¸­ï¼‰

#### 5.11.3 æ€§èƒ½ä¼˜åŒ–
- å›¾ç‰‡æ‡’åŠ è½½
- è™šæ‹Ÿæ»šåŠ¨
- ç§»åŠ¨ç«¯å‹ç¼©

---

## 6. å¢å¼ºåŠŸèƒ½å®ç°

### 6.1 AI å›¾ç‰‡åˆ†æåŠŸèƒ½

#### 6.1.1 åŠŸèƒ½å®ç°æ¦‚è¿°

AI å›¾ç‰‡åˆ†ææ˜¯ Zmage çš„æ ¸å¿ƒå¢å¼ºåŠŸèƒ½ï¼Œä½¿ç”¨ Google Gemini 2.5 Flash æ¨¡å‹å¯¹å›¾ç‰‡è¿›è¡Œæ·±åº¦ç†è§£ã€‚

**AI åˆ†ææµç¨‹**ï¼š

```mermaid
sequenceDiagram
    participant W as Worker
    participant G as GeminiService
    participant AI as Gemini API
    participant DB as Database
    participant V as VectorService

    W->>W: èµ„äº§å¤„ç†ä»»åŠ¡
    W->>W: ä¸‹è½½åŸå§‹å›¾ç‰‡
    
    W->>G: analyze_image(image_data)
    G->>AI: POST /generateContent  model: gemini-2.5-flash  å¤šæ¨¡æ€è¾“å…¥
    AI-->>G: JSONå“åº”  {title, description, tags, ...}
    
    G->>G: è§£æJSON  ç§»é™¤markdownæ ‡è®°
    G-->>W: è¿”å›ç»“æ„åŒ–ç»“æœ
    
    W->>DB: æ›´æ–°èµ„äº§è®°å½•  title/description/tags/ocr_text
    W->>DB: ä¿å­˜objects/scene/colors
    
    W->>G: generate_embedding(description)
    G->>AI: POST /embedContent  model: gemini-embedding-001  768ç»´å‘é‡
    AI-->>G: å‘é‡æ•°æ®
    
    G->>G: å½’ä¸€åŒ–å‘é‡  L2å½’ä¸€åŒ–
    G-->>W: è¿”å›768ç»´å‘é‡
    
    W->>V: upsert_vector(asset_id, vector)
    V->>V: å­˜å‚¨åˆ°Qdrant
    
    W->>DB: æ›´æ–°vector_id
    W->>DB: è®¾ç½®status=ready
```

#### 6.1.2 åˆ†æå†…å®¹è¯¦è§£

**å®é™…ç”Ÿæˆçš„å­—æ®µ**ï¼ˆåŸºäº `gemini.py` å®ç°ï¼‰ï¼š

```mermaid
graph TD
  R["AI åˆ†æç»“æœ"]

  %% åŸºç¡€ä¿¡æ¯
  R --> A["åŸºç¡€ä¿¡æ¯"]
  A --> A1["æ ‡é¢˜"]
  A1 --> A11["ä¸€å¥è¯æè¿°æ€§æ ‡é¢˜"]
  A1 --> A12["ç®€æ´æ˜äº†"]
  A --> A2["æè¿°"]
  A2 --> A21["2â€“3 å¥è¯è¯¦ç»†æè¿°"]
  A2 --> A22["åŒ…å«åœºæ™¯ / ä¸»ä½“ / æ°›å›´"]

  %% æ ‡ç­¾ç³»ç»Ÿ
  R --> B["æ ‡ç­¾ç³»ç»Ÿ"]
  B --> B1["ç‰©ä½“æ ‡ç­¾"]
  B1 --> B11["è¯†åˆ«çš„ä¸»è¦ç‰©ä½“"]
  B --> B2["åœºæ™¯æ ‡ç­¾"]
  B2 --> B21["å®¤å†… / æˆ·å¤– / è‡ªç„¶ / åŸå¸‚"]
  B --> B3["æƒ…æ„Ÿæ ‡ç­¾"]
  B3 --> B31["æ¸©æš– / å†·å³» / æ¬¢å¿«"]
  B --> B4["é£æ ¼æ ‡ç­¾"]
  B4 --> B41["ç°ä»£ / å¤å¤ / è‰ºæœ¯"]

  %% OCR æ–‡æœ¬
  R --> C["OCR æ–‡æœ¬"]
  C --> C1["å›¾ç‰‡ä¸­çš„æ–‡å­—"]
  C --> C2["å¤šè¯­è¨€æ”¯æŒ"]

  %% ç»“æ„åŒ–æ•°æ®
  R --> D["ç»“æ„åŒ–æ•°æ®"]
  D --> D1["objects æ•°ç»„"]
  D1 --> D11["è¯†åˆ«åˆ°çš„ç‰©ä½“åˆ—è¡¨"]
  D --> D2["scene å­—ç¬¦ä¸²"]
  D2 --> D21["åœºæ™¯ç±»å‹"]
  D --> D3["colors æ•°ç»„"]
  D3 --> D31["ä¸»è¦é¢œè‰²åˆ—è¡¨"]

```

**Prompt è®¾è®¡**ï¼š

ç³»ç»Ÿä½¿ç”¨çš„ Prompt è¦æ±‚ Gemini è¿”å›ç»“æ„åŒ– JSONï¼š
- è¦æ±‚æ ‡ç­¾å…·ä½“ã€å¯æœç´¢
- æè¿°è¯¦ç»†ä½†ä¸å†—é•¿
- OCR å®Œæ•´æå–æ–‡å­—
- åªè¿”å› JSONï¼Œä¸åŒ…å«å…¶ä»–å†…å®¹

#### 6.1.3 å‘é‡åµŒå…¥ç”Ÿæˆ

**å‘é‡åŒ–æµç¨‹**ï¼š

```mermaid
flowchart LR
    A[AIåˆ†ææè¿°] --> B[generate_embedding]
    B --> C[Gemini Embedding API]
    C --> D[768ç»´å‘é‡]
    D --> E[L2å½’ä¸€åŒ–]
    E --> F[å­˜å‚¨åˆ°Qdrant]
    
    F --> G[æ”¯æŒè¯­ä¹‰æœç´¢]
    F --> H[æ”¯æŒç›¸ä¼¼æ¨è]
    
    style C fill:#10b981
    style E fill:#f59e0b
```

**å‘é‡å‚æ•°**ï¼ˆåŸºäºå®é™…ä»£ç ï¼‰ï¼š
- **æ¨¡å‹**ï¼š`gemini-embedding-001`
- **ç»´åº¦**ï¼š768 ç»´ï¼ˆé…ç½® `output_dimensionality=768`ï¼‰
- **ä»»åŠ¡ç±»å‹**ï¼š
  - æ–‡æ¡£åµŒå…¥ï¼š`RETRIEVAL_DOCUMENT`
  - æŸ¥è¯¢åµŒå…¥ï¼š`RETRIEVAL_QUERY`
- **å½’ä¸€åŒ–**ï¼šé 3072 ç»´éœ€è¦æ‰‹åŠ¨ L2 å½’ä¸€åŒ–

#### 6.1.4 é”™è¯¯å¤„ç†ä¸é™çº§

**å®¹é”™æœºåˆ¶**ï¼š

| åœºæ™¯ | å¤„ç†æ–¹å¼ | é™çº§ç­–ç•¥ |
|------|---------|---------|
| API Key æœªé…ç½® | è¿”å›é»˜è®¤å€¼ | æ ‡é¢˜="å›¾ç‰‡èµ„äº§"ï¼Œæ ‡ç­¾=["æœªåˆ†æ"] |
| API è°ƒç”¨å¤±è´¥ | æ•è·å¼‚å¸¸ | è¿”å›ç©ºç»“æœï¼Œä¸å½±å“ä¸Šä¼  |
| JSON è§£æå¤±è´¥ | å°è¯•æ¸…ç† markdown | ç§»é™¤ ```json æ ‡è®°åé‡è¯• |
| å‘é‡ç”Ÿæˆå¤±è´¥ | è¿”å›é›¶å‘é‡ | ä¸å½±å“å…¶ä»–åŠŸèƒ½ï¼Œåç»­å¯é‡æ–°ç”Ÿæˆ |

#### 6.1.5 AI åˆ†æç¤ºä¾‹

**å®é™…åˆ†æç»“æœç¤ºä¾‹**ï¼š

```json
{
  "title": "å¤•é˜³ä¸‹çš„æµ·è¾¹åŸå¸‚",
  "description": "ä¸€å¼ æ‹æ‘„äºå‚æ™šæ—¶åˆ†çš„ç…§ç‰‡ï¼Œå±•ç°äº†æµ·æ»¨åŸå¸‚çš„ç¾ä¸½æ™¯è‰²ã€‚å¤©ç©ºå‘ˆç°æ¸©æš–çš„æ©™çº¢è‰²è°ƒï¼Œå»ºç­‘åœ¨å¤•é˜³çš„æ˜ ç…§ä¸‹æ˜¾å¾—æ ¼å¤–è¿·äººï¼Œè¿œå¤„çš„æµ·é¢æ³¢å…‰ç²¼ç²¼ã€‚",
  "tags": ["æµ·è¾¹", "åŸå¸‚", "å¤•é˜³", "å»ºç­‘", "é£æ™¯", "æ¸©æš–", "ç¾ä¸½", "å‚æ™š"],
  "ocr_text": "WELCOME TO HAIKOU",
  "objects": ["å»ºç­‘", "æµ·æ°´", "å¤©ç©º", "äº‘æœµ"],
  "scene": "æˆ·å¤–",
  "colors": ["æ©™è‰²", "çº¢è‰²", "è“è‰²", "ç™½è‰²"]
}
```

è¿™äº›ç»“æœä¼šï¼š
1. ä¿å­˜åˆ°æ•°æ®åº“çš„å¯¹åº”å­—æ®µ
2. æ ‡ç­¾åˆå¹¶åˆ° `tags` æ•°ç»„ï¼ˆä¸ EXIF æ ‡ç­¾åˆå¹¶ï¼‰
3. æè¿°æ–‡æœ¬ç”¨äºç”Ÿæˆå‘é‡åµŒå…¥
4. æ”¯æŒåç»­çš„è¯­ä¹‰æœç´¢å’Œç›¸ä¼¼æ¨è

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼ŒåŸºäº Google Gemini 2.5 Flash å®ç°å®Œæ•´çš„ AI åˆ†æèƒ½åŠ›

### 6.2 MCP æ¥å£ä¸å¯¹è¯å¼æ£€ç´¢

#### 6.2.1 åŠŸèƒ½å®ç°æ¦‚è¿°

MCP (Model Context Protocol) æ¥å£å®ç°äº†å¤§æ¨¡å‹ä¸ç³»ç»Ÿçš„æ·±åº¦é›†æˆï¼Œæ”¯æŒå¯¹è¯å¼æ£€ç´¢å’Œç®¡ç†æ“ä½œã€‚

**MCP æ¶æ„**ï¼š

```mermaid
graph TB
    A[ç”¨æˆ·å¯¹è¯] --> B[Gemini Chat API]
    B --> C[å·¥å…·è°ƒç”¨æ£€æµ‹]
    
    C -->|éœ€è¦å·¥å…·| D[æ‰§è¡ŒMCPå·¥å…·]
    C -->|ç›´æ¥å›ç­”| E[è¿”å›æ–‡æœ¬å›å¤]
    
    D --> F[èµ„äº§ç®¡ç†å·¥å…·]
    D --> G[ç›¸å†Œç®¡ç†å·¥å…·]
    D --> H[æœç´¢å·¥å…·]
    D --> I[åˆ†äº«å·¥å…·]
    D --> J[ç³»ç»Ÿå·¥å…·]
    
    F --> K[æ›´æ–°æ•°æ®åº“]
    G --> K
    H --> L[å‘é‡æ£€ç´¢/å…³é”®è¯æœç´¢]
    I --> K
    J --> M[ç³»ç»Ÿä¿¡æ¯]
    
    K --> N[è¿”å›å·¥å…·ç»“æœ]
    L --> N
    M --> N
    
    N --> B[ç»§ç»­å¯¹è¯]
    B --> O[æœ€ç»ˆå›å¤]
    
    style B fill:#10b981
    style D fill:#3b82f6
    style L fill:#f59e0b
```

#### 6.2.2 MCP å·¥å…·ä½“ç³»

**å·¥å…·åˆ†ç±»**ï¼ˆåŸºäº `mcp.py` å®ç°ï¼‰ï¼š

```mermaid
graph TD
  R["MCP å·¥å…·ï¼ˆ30+ ä¸ªï¼‰"]

  %% èµ„äº§ç®¡ç†
  R --> A["èµ„äº§ç®¡ç†"]
  A --> A1["search_assetsï½œè¯­ä¹‰æœç´¢"]
  A --> A2["list_assetsï½œåˆ—è¡¨æŸ¥è¯¢"]
  A --> A3["get_asset_detailsï½œè¯¦æƒ…è·å–"]
  A --> A4["update_assetï½œå…ƒæ•°æ®æ›´æ–°"]
  A --> A5["delete_assetï½œåˆ é™¤ / æ¢å¤"]
  A --> A6["find_similar_assetsï½œç›¸ä¼¼æ¨è"]

  %% ç›¸å†Œç®¡ç†
  R --> B["ç›¸å†Œç®¡ç†"]
  B --> B1["list_albumsï½œç›¸å†Œåˆ—è¡¨"]
  B --> B2["create_albumï½œåˆ›å»ºç›¸å†Œ"]
  B --> B3["add_to_albumï½œæ·»åŠ èµ„äº§"]
  B --> B4["remove_from_albumï½œç§»é™¤èµ„äº§"]
  B --> B5["delete_albumï½œåˆ é™¤ç›¸å†Œ"]

  %% é›†åˆç®¡ç†
  R --> C["é›†åˆç®¡ç†"]
  C --> C1["list_collectionsï½œé›†åˆåˆ—è¡¨"]
  C --> C2["create_collectionï½œåˆ›å»ºé›†åˆ"]
  C --> C3["add_to_collectionï½œæ·»åŠ èµ„äº§"]

  %% æ–‡ä»¶å¤¹ç®¡ç†
  R --> D["æ–‡ä»¶å¤¹ç®¡ç†"]
  D --> D1["list_foldersï½œæ–‡ä»¶å¤¹æ ‘"]
  D --> D2["create_folderï½œåˆ›å»ºæ–‡ä»¶å¤¹"]

  %% å›æ”¶ç«™
  R --> E["å›æ”¶ç«™"]
  E --> E1["list_trashï½œå›æ”¶ç«™åˆ—è¡¨"]
  E --> E2["restore_assetï½œæ¢å¤èµ„äº§"]
  E --> E3["empty_trashï½œæ¸…ç©ºå›æ”¶ç«™"]

  %% åˆ†äº«
  R --> F["åˆ†äº«"]
  F --> F1["create_shareï½œåˆ›å»ºåˆ†äº«"]
  F --> F2["list_sharesï½œåˆ†äº«åˆ—è¡¨"]

  %% ç³»ç»Ÿ
  R --> G["ç³»ç»Ÿ"]
  G --> G1["get_system_statsï½œç³»ç»Ÿç»Ÿè®¡"]
  G --> G2["get_task_statusï½œä»»åŠ¡çŠ¶æ€"]

```

#### 6.2.3 å¯¹è¯å¼æ£€ç´¢å®ç°

**å·¥å…·è°ƒç”¨æµç¨‹**ï¼ˆåŸºäº `gemini.py` çš„ `chat_with_tools` æ–¹æ³•ï¼‰ï¼š

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant API as FastAPI
    participant G as GeminiService
    participant AI as Gemini API
    participant MCP as MCPå·¥å…·
    participant DB as æ•°æ®åº“

    U->>F: è¾“å…¥æŸ¥è¯¢  "æ‰¾ä¸€äº›æµ·è¾¹çš„ç…§ç‰‡"
    F->>API: POST /ai/chat  messages[]
    
    API->>G: chat_with_tools()
    G->>AI: å‘é€æ¶ˆæ¯  é…ç½®å·¥å…·åˆ—è¡¨
    
    AI-->>G: è¿”å›å·¥å…·è°ƒç”¨è¯·æ±‚  function_call: search_assets
    
    G->>MCP: æ‰§è¡Œå·¥å…·  search_assets(query="æµ·è¾¹")
    MCP->>DB: å‘é‡æœç´¢/å…³é”®è¯æœç´¢
    DB-->>MCP: è¿”å›èµ„äº§åˆ—è¡¨
    MCP-->>G: è¿”å›å·¥å…·ç»“æœ
    
    G->>AI: å‘é€å·¥å…·ç»“æœ
    AI-->>G: ç”Ÿæˆæœ€ç»ˆå›å¤
    
    G-->>API: è¿”å›å›å¤+å·¥å…·ç»“æœ
    API-->>F: è¿”å›å¯¹è¯å“åº”
    
    F->>U: æ˜¾ç¤ºAIå›å¤+æœç´¢ç»“æœ
```

**å·¥å…·è°ƒç”¨å¾ªç¯**ï¼š
- æ¨¡å‹å¯ä»¥å¤šæ¬¡è°ƒç”¨å·¥å…·
- æ¯æ¬¡å·¥å…·ç»“æœä¼šå‘é€å›æ¨¡å‹
- æ¨¡å‹æ ¹æ®å·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›å¤
- å‰ç«¯å¯ä»¥å±•ç¤ºå·¥å…·è°ƒç”¨è¿‡ç¨‹

#### 6.2.4 å®é™…å¯¹è¯ç¤ºä¾‹

**ç¤ºä¾‹å¯¹è¯æµç¨‹**ï¼š

```
ç”¨æˆ·: "å¸®æˆ‘æ‰¾ä¸€äº›å»å¹´å¤å¤©æ‹çš„é£æ™¯ç…§ç‰‡"

[AIè°ƒç”¨å·¥å…·]
{
  "name": "search_assets",
  "arguments": {
    "query": "å»å¹´å¤å¤© é£æ™¯",
    "limit": 10
  }
}

[å·¥å…·è¿”å›]
æ‰¾åˆ° 15 ä¸ªåŒ¹é…é¡¹

[AIå›å¤]
æˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº† 15 å¼ å»å¹´å¤å¤©æ‹æ‘„çš„é£æ™¯ç…§ç‰‡ã€‚å…¶ä¸­åŒ…æ‹¬æµ·è¾¹æ—¥è½ã€å±±é—´äº‘é›¾ã€åŸå¸‚å¤œæ™¯ç­‰å¤šç§åœºæ™¯ã€‚éœ€è¦æˆ‘å¸®æ‚¨æŒ‰åœ°ç‚¹æˆ–é£æ ¼è¿›ä¸€æ­¥ç­›é€‰å—ï¼Ÿ

---

ç”¨æˆ·: "åˆ›å»ºä¸€ä¸ªç›¸å†Œï¼ŒæŠŠè¿™äº›ç…§ç‰‡éƒ½åŠ è¿›å»ï¼Œåå­—å«'å¤æ—¥å›å¿†'"

[AIè°ƒç”¨å·¥å…·]
{
  "name": "create_album",
  "arguments": {
    "name": "å¤æ—¥å›å¿†",
    "asset_ids": [1, 2, 3, ...]
  }
}

[å·¥å…·è¿”å›]
ç›¸å†Œ 'å¤æ—¥å›å¿†' åˆ›å»ºæˆåŠŸ

[AIå›å¤]
å¥½çš„ï¼Œæˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†åä¸º"å¤æ—¥å›å¿†"çš„ç›¸å†Œï¼Œå¹¶æ·»åŠ äº†è¿™15å¼ ç…§ç‰‡ã€‚æ‚¨å¯ä»¥éšæ—¶æŸ¥çœ‹å’Œç®¡ç†è¿™ä¸ªç›¸å†Œã€‚
```

#### 6.2.5 ç³»ç»ŸæŒ‡ä»¤é…ç½®

**Gemini ç³»ç»ŸæŒ‡ä»¤**ï¼ˆåŸºäºå®é™…ä»£ç ï¼‰ï¼š
```
"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å›¾ç‰‡ç®¡ç†åŠ©æ‰‹ã€‚ä½ å¯ä»¥é€šè¿‡å·¥å…·æœç´¢å›¾ç‰‡ã€æ›´æ–°å…ƒæ•°æ®ã€ç®¡ç†ç›¸å†Œç­‰ã€‚
è¯·ä¼˜å…ˆä½¿ç”¨å·¥å…·æ¥è·å–å‡†ç¡®ä¿¡æ¯ï¼Œå¹¶åœ¨æ“ä½œåç»™ç”¨æˆ·æ˜ç¡®çš„åé¦ˆã€‚"
```

è¿™ç¡®ä¿ AI ç†è§£è‡ªå·±çš„è§’è‰²ï¼Œå¹¶ä¼˜å…ˆä½¿ç”¨å·¥å…·è·å–å‡†ç¡®ä¿¡æ¯ã€‚

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæä¾›å®Œæ•´çš„ MCP å·¥å…·é›†æˆå’Œå¯¹è¯å¼äº¤äº’èƒ½åŠ›

---

## 7. æŠ€æœ¯é€‰å‹ä¸å®ç°ç»†èŠ‚

### 7.1 å‰ç«¯æŠ€æœ¯å®ç°

#### 7.1.1 Next.js App Router
[å¾…å±•å¼€ï¼šè·¯ç”±è®¾è®¡ã€Server Components ä½¿ç”¨]

#### 7.1.2 çŠ¶æ€ç®¡ç†ï¼ˆZustandï¼‰
[å¾…å±•å¼€ï¼šå…¨å±€çŠ¶æ€è®¾è®¡]

#### 7.1.3 UI ç»„ä»¶åº“ï¼ˆshadcn/uiï¼‰
[å¾…å±•å¼€ï¼šç»„ä»¶ä½¿ç”¨æƒ…å†µ]

#### 7.1.4 æ•°æ®è·å–ï¼ˆTanStack Queryï¼‰
[å¾…å±•å¼€ï¼šAPI è°ƒç”¨å°è£…ã€ç¼“å­˜ç­–ç•¥]

### 7.2 åç«¯æŠ€æœ¯å®ç°

#### 7.2.1 FastAPI æ¡†æ¶
[å¾…å±•å¼€ï¼šè·¯ç”±è®¾è®¡ã€ä¸­é—´ä»¶ã€ä¾èµ–æ³¨å…¥]

#### 7.2.2 å¼‚æ­¥ç¼–ç¨‹
[å¾…å±•å¼€ï¼šAsyncIO ä½¿ç”¨ã€æ•°æ®åº“å¼‚æ­¥æ“ä½œ]

#### 7.2.3 è®¤è¯ä¸æˆæƒ
[å¾…å±•å¼€ï¼šJWT å®ç°ã€æƒé™æ§åˆ¶]

#### 7.2.4 ä»»åŠ¡é˜Ÿåˆ—
[å¾…å±•å¼€ï¼šRedis é˜Ÿåˆ—ã€åå°ä»»åŠ¡å¤„ç†]

### 7.3 æ•°æ®åº“è®¾è®¡

[å¾…å±•å¼€ï¼šè¯¦ç»†è¡¨ç»“æ„è®¾è®¡]

### 7.4 å‘é‡æ£€ç´¢å®ç°

#### 7.4.1 å‘é‡åŒ–æµç¨‹
- å›¾ç‰‡ä¸Šä¼  â†’ AI åˆ†æ â†’ ç”Ÿæˆæè¿° â†’ å‘é‡åµŒå…¥ â†’ å­˜å…¥ Qdrant

#### 7.4.2 æ£€ç´¢æµç¨‹
- æŸ¥è¯¢æ–‡æœ¬ â†’ å‘é‡åµŒå…¥ â†’ å‘é‡æœç´¢ â†’ ç»“æœæ’åº â†’ è¿”å›

#### 7.4.3 æ··åˆæ£€ç´¢
- å…³é”®è¯è¿‡æ»¤ + å‘é‡æ£€ç´¢ + é‡æ’åº

### 7.5 å¯¹è±¡å­˜å‚¨å®ç°

#### 7.5.1 MinIO é›†æˆ
[å¾…å±•å¼€]

#### 7.5.2 å­˜å‚¨ç­–ç•¥
- åŸå§‹æ–‡ä»¶ï¼š`assets/{timestamp}_{hash}_{filename}`
- ç¼©ç•¥å›¾ï¼š`thumbnails/{asset_id}.jpg`
- ç¼–è¾‘ç‰ˆæœ¬ï¼š`versions/{version_id}.jpg`

---

## 8. æ•°æ®åº“è®¾è®¡

### 8.1 æ ¸å¿ƒè¡¨ç»“æ„

Zmage ä½¿ç”¨ PostgreSQL ä½œä¸ºä¸»æ•°æ®åº“ï¼Œé‡‡ç”¨ SQLAlchemy ORM è¿›è¡Œæ•°æ®è®¿é—®ã€‚æ‰€æœ‰è¡¨éƒ½æ”¯æŒå¤šç§Ÿæˆ·éš”ç¦»ï¼ˆé€šè¿‡ `user_id` å­—æ®µï¼‰ã€‚

#### 8.1.1 usersï¼ˆç”¨æˆ·è¡¨ï¼‰

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | ç±»å‹ | çº¦æŸ | è¯´æ˜ |
|--------|------|------|------|
| `id` | SERIAL | PRIMARY KEY | ç”¨æˆ·ID |
| `username` | VARCHAR(100) | UNIQUE, NOT NULL | ç”¨æˆ·åï¼ˆ>=6å­—èŠ‚ï¼‰ |
| `email` | VARCHAR(255) | UNIQUE, NOT NULL | é‚®ç®±ï¼ˆæ ¼å¼éªŒè¯ï¼‰ |
| `hashed_password` | VARCHAR(255) | NOT NULL | å¯†ç å“ˆå¸Œ |
| `full_name` | VARCHAR(100) | NULL | å…¨å |
| `is_active` | BOOLEAN | DEFAULT TRUE | æ˜¯å¦æ¿€æ´» |
| `is_superuser` | BOOLEAN | DEFAULT FALSE | æ˜¯å¦è¶…çº§ç”¨æˆ· |
| `vault_pin_hash` | VARCHAR(255) | NULL | ä¿é™©åº“PINå“ˆå¸Œ |
| `created_at` | TIMESTAMP | DEFAULT NOW() | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMP | DEFAULT NOW() | æ›´æ–°æ—¶é—´ |

**ç´¢å¼•**ï¼š
- `idx_users_username` ON `username`
- `idx_users_email` ON `email`

#### 8.1.2 assetsï¼ˆèµ„äº§è¡¨ï¼‰

**è¡¨ç»“æ„**ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | SERIAL | èµ„äº§ID |
| `user_id` | INTEGER | FK â†’ users.id (CASCADE) |
| `filename` | VARCHAR(255) | å­˜å‚¨æ–‡ä»¶å |
| `original_filename` | VARCHAR(255) | åŸå§‹æ–‡ä»¶å |
| `file_path` | VARCHAR(512) | MinIOå­˜å‚¨è·¯å¾„ |
| `thumbnail_path` | VARCHAR(512) | ç¼©ç•¥å›¾è·¯å¾„ |
| `file_size` | INTEGER | æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
| `file_hash` | VARCHAR(64) | SHA256å“ˆå¸Œï¼ˆUNIQUEï¼‰ |
| `mime_type` | VARCHAR(100) | MIMEç±»å‹ |
| `asset_type` | ENUM | image/video/document/other |
| `width` / `height` | INTEGER | å›¾ç‰‡å°ºå¯¸ |
| `duration` | FLOAT | è§†é¢‘æ—¶é•¿ï¼ˆç§’ï¼‰ |
| `title` | VARCHAR(255) | AIç”Ÿæˆæ ‡é¢˜ |
| `description` | TEXT | AIç”Ÿæˆæè¿° |
| `tags` | ARRAY[VARCHAR] | æ ‡ç­¾æ•°ç»„ï¼ˆPostgreSQLæ•°ç»„ï¼‰ |
| `ocr_text` | TEXT | OCRè¯†åˆ«æ–‡æœ¬ |
| `exif_data` | JSONB | EXIFå…ƒæ•°æ® |
| `taken_at` | TIMESTAMP | æ‹æ‘„æ—¶é—´ |
| `camera_model` | VARCHAR(100) | ç›¸æœºå‹å· |
| `latitude` / `longitude` | FLOAT | GPSåæ ‡ |
| `location` | VARCHAR(255) | åœ°ç†ä½ç½®æè¿° |
| `status` | ENUM | pending/processing/ready/failed |
| `vector_id` | VARCHAR(64) | Qdrantå‘é‡ID |
| `deleted_at` | TIMESTAMP | è½¯åˆ é™¤æ—¶é—´ |
| `is_private` | BOOLEAN | æ˜¯å¦ç§å¯†ï¼ˆä¿é™©åº“ï¼‰ |

**ç´¢å¼•**ï¼š
- `idx_assets_user_id` ON `user_id`
- `idx_assets_file_hash` ON `file_hash` (UNIQUE)
- `idx_assets_deleted_at` ON `deleted_at`
- `idx_assets_status` ON `status`
- `idx_assets_taken_at` ON `taken_at`

#### 8.1.3 albumsï¼ˆç›¸å†Œè¡¨ï¼‰

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | SERIAL | ç›¸å†ŒID |
| `user_id` | INTEGER | FK â†’ users.id (CASCADE) |
| `name` | VARCHAR(255) | ç›¸å†Œåç§° |
| `description` | TEXT | ç›¸å†Œæè¿° |
| `cover_asset_id` | INTEGER | FK â†’ assets.id |
| `album_type` | ENUM | manual/smart/suggested |
| `status` | ENUM | pending/accepted/ignored |
| `smart_rules` | JSONB | æ™ºèƒ½ç›¸å†Œè§„åˆ™ |
| `suggestion_reason` | TEXT | AIå»ºè®®ç†ç”± |
| `suggestion_score` | FLOAT | å»ºè®®ç½®ä¿¡åº¦ |
| `deleted_at` | TIMESTAMP | è½¯åˆ é™¤æ—¶é—´ |

#### 8.1.4 album_assetsï¼ˆç›¸å†Œèµ„äº§å…³è”è¡¨ï¼‰

**å¤šå¯¹å¤šå…³ç³»è¡¨**ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | SERIAL | å…³è”ID |
| `album_id` | INTEGER | FK â†’ albums.id |
| `asset_id` | INTEGER | FK â†’ assets.id |
| `position` | INTEGER | æ’åºä½ç½® |
| `created_at` | TIMESTAMP | å…³è”æ—¶é—´ |

#### 8.1.5 sharesï¼ˆåˆ†äº«è¡¨ï¼‰

**è¡¨ç»“æ„**ï¼š

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| `id` | SERIAL | åˆ†äº«ID |
| `user_id` | INTEGER | FK â†’ users.id |
| `share_code` | VARCHAR(32) | åˆ†äº«ç ï¼ˆUNIQUEï¼‰ |
| `asset_id` | INTEGER | FK â†’ assets.id (å¯é€‰) |
| `collection_id` | INTEGER | FK â†’ collections.id (å¯é€‰) |
| `permission` | ENUM | view/download |
| `password_hash` | VARCHAR(255) | å¯†ç å“ˆå¸Œï¼ˆå¯é€‰ï¼‰ |
| `expires_at` | TIMESTAMP | è¿‡æœŸæ—¶é—´ï¼ˆå¯é€‰ï¼‰ |
| `view_count` | INTEGER | æµè§ˆæ¬¡æ•° |
| `is_active` | BOOLEAN | æ˜¯å¦æ¿€æ´» |

### 8.2 æ•°æ®åº“å…³ç³»è®¾è®¡

**ER å…³ç³»å›¾**ï¼š

```mermaid
erDiagram
    User ||--o{ Asset : owns
    User ||--o{ Album : creates
    User ||--o{ Folder : owns
    User ||--o{ Share : creates
    User ||--o{ Collection : creates
    
    Asset }o--o{ Album : "belongs to"
    Asset ||--o| Folder : "stored in"
    Asset ||--o{ AssetVersion : "has versions"
    
    Album ||--o{ AlbumAsset : contains
    AlbumAsset }o--|| Asset : references
    
    Share ||--o| Asset : shares
    Share ||--o| Collection : shares
    
    Asset }o--o{ Tag : "has tags via array"
    
    User {
        int id PK
        string username UK
        string email UK
    }
    
    Asset {
        int id PK
        int user_id FK
        string file_hash UK
        array tags
        jsonb exif_data
    }
    
    Album {
        int id PK
        int user_id FK
        enum album_type
        jsonb smart_rules
    }
    
    AlbumAsset {
        int album_id FK
        int asset_id FK
        int position
    }
```

### 8.3 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

**æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•**ï¼š

```mermaid
graph TD
  R["ç´¢å¼•ç­–ç•¥"]

  R --> P["ä¸»é”®ç´¢å¼•"]
  P --> P1["æ‰€æœ‰è¡¨çš„ id å­—æ®µ"]
  P --> P2["PRIMARY KEY è‡ªåŠ¨åˆ›å»º"]

  R --> F["å¤–é”®ç´¢å¼•"]
  F --> F1["user_id ç´¢å¼•"]
  F --> F2["å…³è”è¡¨å¤–é”®ç´¢å¼•"]

  R --> U["å”¯ä¸€ç´¢å¼•"]
  U --> U1["username / email"]
  U --> U2["file_hash å»é‡"]

  R --> Q["æŸ¥è¯¢ç´¢å¼•"]
  Q --> QT["æ—¶é—´å­—æ®µ"]
  QT --> QT1["taken_at"]
  QT --> QT2["created_at"]
  Q --> QS["çŠ¶æ€å­—æ®µ"]
  QS --> QS1["status"]
  QS --> QS2["deleted_at"]
  Q --> QG["ç©ºé—´ç´¢å¼•"]
  QG --> QG1["latitude / longitude"]
  QG --> QG2["åœ°å›¾æŸ¥è¯¢"]

  R --> S["å…¨æ–‡æ£€ç´¢"]
  S --> S1["PostgreSQL GIN ç´¢å¼•"]
  S --> S2["tags æ•°ç»„ç´¢å¼•"]
  S --> S3["ocr_text å…¨æ–‡ç´¢å¼•"]
```

**å…³é”®ç´¢å¼•è¯´æ˜**ï¼š

1. **å¤šç§Ÿæˆ·éš”ç¦»**ï¼šæ‰€æœ‰ `user_id` å­—æ®µéƒ½æœ‰ç´¢å¼•ï¼Œç¡®ä¿æŸ¥è¯¢æ•ˆç‡
2. **è½¯åˆ é™¤ä¼˜åŒ–**ï¼š`deleted_at` ç´¢å¼•ï¼Œå¿«é€Ÿè¿‡æ»¤å·²åˆ é™¤è®°å½•
3. **æ ‡ç­¾æœç´¢**ï¼šPostgreSQL æ•°ç»„ç±»å‹ + GIN ç´¢å¼•ï¼Œæ”¯æŒé«˜æ•ˆæ ‡ç­¾æŸ¥è¯¢
4. **åœ°ç†ä½ç½®**ï¼š`latitude` / `longitude` ç´¢å¼•ï¼Œæ”¯æŒåœ°å›¾èŒƒå›´æŸ¥è¯¢

### 8.4 æ•°æ®è¿ç§»ç®¡ç†

**è¿ç§»ç­–ç•¥**ï¼š

```mermaid
flowchart LR
    A[è¿ç§»è„šæœ¬] --> B[init.sql  åˆå§‹åŒ–]
    A --> C[add_user_id_to_assets.sql  å¤šç§Ÿæˆ·æ”¯æŒ]
    A --> D[å…¶ä»–å¢é‡è¿ç§»]
    
    B --> E[æ‰§è¡Œè¿ç§»]
    C --> E
    D --> E
    
    E --> F[éªŒè¯è¡¨ç»“æ„]
    F --> G[æ›´æ–°ç‰ˆæœ¬å·]
    
    style B fill:#3b82f6
    style E fill:#10b981
```

**è¿ç§»å·¥å…·**ï¼ˆ`migrate.py`ï¼‰ï¼š

- è‡ªåŠ¨è¯»å– `init.sql` æ‰§è¡Œ
- éªŒè¯è¡¨åˆ›å»ºæˆåŠŸ
- æ”¯æŒå¢é‡è¿ç§»è„šæœ¬
- å®¹å™¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œ

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæ•°æ®åº“è®¾è®¡æ”¯æŒå¤šç§Ÿæˆ·ã€è½¯åˆ é™¤ã€é«˜æ•ˆæŸ¥è¯¢

---

## 9. å‰ç«¯ç•Œé¢è®¾è®¡

### 9.1 è®¾è®¡ç†å¿µ

#### 9.1.1 æ¶²æ€ç»ç’ƒé£æ ¼

Zmage é‡‡ç”¨**æ¶²æ€ç»ç’ƒï¼ˆLiquid Glassï¼‰**è®¾è®¡é£æ ¼ï¼Œåˆ›é€ ç°ä»£ã€ä¼˜é›…çš„è§†è§‰ä½“éªŒã€‚

**è®¾è®¡ç‰¹å¾**ï¼š

```mermaid
mindmap
  root((æ¶²æ€ç»ç’ƒé£æ ¼))
    è§†è§‰æ•ˆæœ
      backdrop-blur
        æ¯›ç»ç’ƒæ¨¡ç³Šæ•ˆæœ
        åŠé€æ˜èƒŒæ™¯
      åŠé€æ˜é¢æ¿
        bg-opacity
        rgbaé€æ˜åº¦
      ç»†è¾¹æ¡†
        å¾®å¼±è¾¹æ¡†
        border-1px
      å¾®å¼±é«˜å…‰
        shadowæ•ˆæœ
        glowæ•ˆæœ
    è‰²å½©ç³»ç»Ÿ
      ä¸»è‰²è°ƒ
        è“è‰²ç³»æ¸å˜
        #3b82f6åˆ°#8b5cf6
      èƒŒæ™¯
        æ·±è‰²æ¨¡å¼
        æµ…è‰²æ¸å˜+å™ªç‚¹
    åœ†è§’è®¾è®¡
      ç»Ÿä¸€åœ†è§’
      12-16px
      å¡ç‰‡åœ†è§’
      æ›´å¤§åœ†è§’
```

**å®ç°æ–¹å¼**ï¼š
- **CSS å±æ€§**ï¼š`backdrop-blur-md`, `bg-background/95`
- **Tailwind ç±»**ï¼š`rounded-2xl`, `shadow-2xl`, `border border-[var(--border)]`
- **åŠ¨ç”»**ï¼š`animate-in`, `fade-in`, `slide-in` (Framer Motion)

#### 9.1.2 æš—è‰²/äº®è‰²ä¸»é¢˜

**ä¸»é¢˜åˆ‡æ¢æœºåˆ¶**ï¼š

```mermaid
graph LR
    A[ç”¨æˆ·åˆ‡æ¢ä¸»é¢˜] --> B[CSSå˜é‡æ›´æ–°]
    B --> C[--backgroundå˜é‡]
    B --> D[--foregroundå˜é‡]
    B --> E[--borderå˜é‡]
    
    C --> F[æ‰€æœ‰ç»„ä»¶è‡ªåŠ¨é€‚é…]
    D --> F
    E --> F
    
    style B fill:#10b981
    style F fill:#3b82f6
```

**CSS å˜é‡ç³»ç»Ÿ**ï¼š
- `--background`: èƒŒæ™¯è‰²
- `--foreground`: å‰æ™¯è‰²ï¼ˆæ–‡å­—ï¼‰
- `--border`: è¾¹æ¡†è‰²
- `--muted-foreground`: æ¬¡è¦æ–‡å­—è‰²
- æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ CSS å˜é‡ï¼Œåˆ‡æ¢ä¸»é¢˜æ—¶è‡ªåŠ¨é€‚é…

### 9.2 ä¸»è¦é¡µé¢

#### 9.2.1 é¦–é¡µï¼ˆå›¾åº“æµè§ˆï¼‰

**é¡µé¢å¸ƒå±€**ï¼š

```mermaid
graph TB
    A[ä¾§è¾¹æ   Sidebar] --> B[ä¸»å†…å®¹åŒº]
    
    B --> C[é¡¶éƒ¨å·¥å…·æ   Header]
    B --> D[æœç´¢æ ]
    B --> E[è§†å›¾åˆ‡æ¢]
    B --> F[èµ„äº§ç½‘æ ¼]
    
    C --> C1[ä¸Šä¼ æŒ‰é’®]
    C --> C2[AIå¯¹è¯]
    C --> C3[ç”¨æˆ·èœå•]
    
    F --> F1[ç½‘æ ¼è§†å›¾]
    F --> F2[åˆ—è¡¨è§†å›¾]
    F --> F3[ç€‘å¸ƒæµè§†å›¾]
    
    F1 --> G[èµ„äº§å¡ç‰‡]
    G --> G1[ç¼©ç•¥å›¾]
    G --> G2[æ ‡é¢˜/æ ‡ç­¾]
    G --> G3[æ“ä½œæŒ‰é’®]
    
    style A fill:#8b5cf6
    style F fill:#3b82f6
    style G fill:#10b981
```

**åŠŸèƒ½å¸ƒå±€**ï¼š
- **å·¦ä¾§è¾¹æ **ï¼šå¯¼èˆªèœå•ã€æ–‡ä»¶å¤¹æ ‘ã€ç›¸å†Œåˆ—è¡¨
- **é¡¶éƒ¨å·¥å…·æ **ï¼šä¸Šä¼ ã€æœç´¢ã€AIå¯¹è¯ã€ç”¨æˆ·èœå•
- **ä¸»å†…å®¹åŒº**ï¼šèµ„äº§ç½‘æ ¼/åˆ—è¡¨ï¼Œæ”¯æŒå¤šç§è§†å›¾æ¨¡å¼
- **åº•éƒ¨æ“ä½œæ **ï¼šæ‰¹é‡æ“ä½œæ—¶æ˜¾ç¤ºï¼ˆæµ®åŠ¨ï¼‰

#### 9.2.2 æœç´¢é¡µé¢

**æœç´¢ç•Œé¢**ï¼š

```mermaid
flowchart TD
    A[æœç´¢æ¡†] --> B{æœç´¢æ¨¡å¼}
    B -->|å…³é”®è¯| C[å…¨æ–‡æ£€ç´¢]
    B -->|AIæœç´¢| D[è¯­ä¹‰æœç´¢  å‘é‡æ£€ç´¢]
    
    C --> E[é«˜çº§ç­›é€‰å™¨  ä¾§è¾¹æ ]
    D --> E
    
    E --> F[æ—¶é—´èŒƒå›´]
    E --> G[åª’ä½“ç±»å‹]
    E --> H[æ ‡ç­¾ç­›é€‰]
    E --> I[EXIFå‚æ•°]
    
    F --> J[æœç´¢ç»“æœ]
    G --> J
    H --> J
    I --> J
    
    J --> K[ç»“æœç½‘æ ¼]
    K --> L[åˆ†é¡µå™¨]
    
    style D fill:#10b981
    style E fill:#f59e0b
```

#### 9.2.3 åœ°å›¾é¡µé¢

**åœ°å›¾åŠŸèƒ½å¸ƒå±€**ï¼š
- **åœ°å›¾å®¹å™¨**ï¼šLeaflet åœ°å›¾ï¼Œå…¨å±æ˜¾ç¤º
- **æ ‡è®°ç‚¹**ï¼šæ¯ä¸ªæœ‰ GPS çš„èµ„äº§æ˜¾ç¤ºä¸ºæ ‡è®°
- **æ ‡è®°å¼¹çª—**ï¼šç‚¹å‡»æ ‡è®°æ˜¾ç¤ºç¼©ç•¥å›¾å’ŒåŸºæœ¬ä¿¡æ¯
- **æ§åˆ¶æ **ï¼šåœ°å›¾ç¼©æ”¾ã€å›¾å±‚åˆ‡æ¢ï¼ˆé¡¶éƒ¨ï¼‰

#### 9.2.4 ç¼–è¾‘é¡µé¢

**ç¼–è¾‘å™¨å¸ƒå±€**ï¼š

```mermaid
graph LR
    A[å·¦ä¾§é¢„è§ˆåŒº] --> B[å³ä¾§å·¥å…·æ ]
    
    B --> C[ç¼–è¾‘æ ‡ç­¾é¡µ]
    C --> C1[åŸºç¡€è°ƒæ•´]
    C --> C2[é«˜çº§æ»¤é•œ]
    C --> C3[AIç¼–è¾‘]
    C --> C4[ç‰ˆæœ¬å†å²]
    
    C1 --> D[è£å‰ªå·¥å…·]
    C1 --> E[è‰²è°ƒè°ƒæ•´]
    C1 --> F[æ—‹è½¬ç¿»è½¬]
    
    style A fill:#3b82f6
    style B fill:#10b981
```

### 9.3 äº¤äº’è®¾è®¡

#### 9.3.1 é”®ç›˜å¿«æ·é”®

**å¿«æ·é”®åˆ—è¡¨**ï¼š

| å¿«æ·é”® | åŠŸèƒ½ | è¯´æ˜ |
|--------|------|------|
| `Ctrl/Cmd + A` | å…¨é€‰ | å¤šé€‰æ¨¡å¼ä¸‹å…¨é€‰å½“å‰é¡µèµ„äº§ |
| `Shift + ç‚¹å‡»` | èŒƒå›´é€‰æ‹© | é€‰æ‹©è¿ç»­èŒƒå›´çš„èµ„äº§ |
| `Esc` | é€€å‡ºå¤šé€‰ | æ¸…ç©ºé€‰æ‹©ï¼Œé€€å‡ºå¤šé€‰æ¨¡å¼ |
| `â†/â†’` | åˆ‡æ¢å›¾ç‰‡ | å…¨å±é¢„è§ˆæ—¶åˆ‡æ¢ä¸Šä¸€å¼ /ä¸‹ä¸€å¼  |
| `Space` | æ’­æ”¾/æš‚åœ | è½®æ’­æ¨¡å¼æ—¶æš‚åœ/ç»§ç»­ |
| `Delete` | åˆ é™¤é€‰ä¸­ | å¤šé€‰æ¨¡å¼ä¸‹åˆ é™¤é€‰ä¸­èµ„äº§ |

#### 9.3.2 æ‹–æ‹½æ“ä½œ

**æ”¯æŒçš„æ‹–æ‹½åŠŸèƒ½**ï¼š
- **æ–‡ä»¶ä¸Šä¼ **ï¼šæ‹–æ‹½æ–‡ä»¶åˆ°é¡µé¢åŒºåŸŸ
- **ç›¸å†Œç®¡ç†**ï¼šæ‹–æ‹½èµ„äº§åˆ°ç›¸å†Œï¼ˆè§„åˆ’ä¸­ï¼‰
- **æ’åº**ï¼šç›¸å†Œå†…æ‹–æ‹½æ’åºï¼ˆè§„åˆ’ä¸­ï¼‰

#### 9.3.3 åŠ¨ç”»æ•ˆæœ

**åŠ¨ç”»ä½¿ç”¨åŸåˆ™**ï¼š
- **æ—¶é•¿**ï¼š150-220msï¼Œç¼“å…¥ç¼“å‡º
- **ç”¨é€”**ï¼šçŠ¶æ€åˆ‡æ¢ã€å¼¹å±‚ã€åˆ—è¡¨æ’å…¥ã€åŠ è½½çŠ¶æ€
- **åº“**ï¼šFramer Motion
- **å°Šé‡**ï¼š`prefers-reduced-motion` ç”¨æˆ·åå¥½

**åŠ¨ç”»ç±»å‹**ï¼š
- **é¡µé¢è¿‡æ¸¡**ï¼š`fade-in`, `slide-in`
- **åˆ—è¡¨é¡¹**ï¼š`stagger` åŠ¨ç”»
- **æŒ‰é’®**ï¼š`hover` ç¼©æ”¾
- **åŠ è½½**ï¼š`spinner` æ—‹è½¬åŠ¨ç”»

---

## 10. API æ¥å£è®¾è®¡

### 10.1 æ¥å£è§„èŒƒ

#### 10.1.1 RESTful è®¾è®¡åŸåˆ™

Zmage API éµå¾ª RESTful è®¾è®¡è§„èŒƒï¼š

```mermaid
graph LR
    A["HTTP æ–¹æ³•"] --> B{"èµ„æºæ“ä½œ"}
    
    B -->|GET| C["æŸ¥è¯¢èµ„æºï¼ˆå¹‚ç­‰ï¼‰"]
    B -->|POST| D["åˆ›å»ºèµ„æºï¼ˆéå¹‚ç­‰ï¼‰"]
    B -->|PUT| E["å®Œæ•´æ›´æ–°ï¼ˆå¹‚ç­‰ï¼‰"]
    B -->|PATCH| F["éƒ¨åˆ†æ›´æ–°ï¼ˆå¹‚ç­‰ï¼‰"]
    B -->|DELETE| G["åˆ é™¤èµ„æºï¼ˆå¹‚ç­‰ï¼‰"]
    
    C --> H["/api/assets - è·å–åˆ—è¡¨"]
    D --> I["/api/assets/upload - ä¸Šä¼ æ–‡ä»¶"]
    E --> J["/api/assets/{id} - æ›´æ–°èµ„äº§"]
    G --> K["/api/assets/{id} - åˆ é™¤èµ„äº§"]
    
    style C fill:#10b981
    style D fill:#3b82f6
    style E fill:#f59e0b
    style G fill:#ef4444
```

**URL è®¾è®¡è§„èŒƒ**ï¼š

- èµ„æºä½¿ç”¨åè¯ï¼š`/api/assets`, `/api/albums`
- åµŒå¥—èµ„æºï¼š`/api/assets/{id}/versions`
- æ“ä½œä½¿ç”¨åŠ¨è¯ï¼š`/api/assets/{id}/edit`
- ç‰ˆæœ¬æ§åˆ¶ï¼šæ‰€æœ‰ API å‰ç¼€ `/api`

#### 10.1.2 ç»Ÿä¸€å“åº”æ ¼å¼

**æˆåŠŸå“åº”**ï¼š

```json
{
  "id": 1,
  "filename": "example.jpg",
  "url": "/api/storage/...",
  "thumbnail_url": "/api/storage/...",
  // ... å…¶ä»–å­—æ®µ
}
```

**åˆ—è¡¨å“åº”**ï¼š

```json
{
  "items": [...],
  "total": 100,
  "page": 1,
  "page_size": 20,
  "has_more": true
}
```

**é”™è¯¯å“åº”**ï¼š

```json
{
  "detail": "é”™è¯¯æè¿°ä¿¡æ¯",
  "error_code": "ASSET_NOT_FOUND" // å¯é€‰
}
```

**HTTP çŠ¶æ€ç **ï¼š
- `200 OK`ï¼šæˆåŠŸ
- `201 Created`ï¼šåˆ›å»ºæˆåŠŸ
- `400 Bad Request`ï¼šè¯·æ±‚å‚æ•°é”™è¯¯
- `401 Unauthorized`ï¼šæœªè®¤è¯
- `403 Forbidden`ï¼šæ— æƒé™
- `404 Not Found`ï¼šèµ„æºä¸å­˜åœ¨
- `500 Internal Server Error`ï¼šæœåŠ¡å™¨é”™è¯¯

#### 10.1.3 è®¤è¯ä¸æˆæƒ

**è®¤è¯æ–¹å¼**ï¼šJWT Bearer Token

```http
Authorization: Bearer <token>
```

**æˆæƒæ£€æŸ¥**ï¼š
- æ‰€æœ‰å—ä¿æŠ¤æ¥å£éƒ½éœ€è¦ `get_current_user` ä¾èµ–
- è‡ªåŠ¨æ£€æŸ¥ Token æœ‰æ•ˆæ€§
- éªŒè¯ç”¨æˆ·çŠ¶æ€ï¼ˆ`is_active`ï¼‰
- èµ„æºæ‰€æœ‰æƒéªŒè¯ï¼ˆ`user_id` åŒ¹é…ï¼‰

### 10.2 æ ¸å¿ƒæ¥å£åˆ—è¡¨

#### 10.2.1 è®¤è¯æ¥å£ (`/api/auth`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| `POST` | `/auth/register` | ç”¨æˆ·æ³¨å†Œ | å¦ |
| `POST` | `/auth/login` | ç”¨æˆ·ç™»å½• | å¦ |
| `GET` | `/auth/me` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ | æ˜¯ |

**æ³¨å†Œæ¥å£ç¤ºä¾‹**ï¼š
```json
POST /api/auth/register
{
  "username": "testuser",
  "email": "test@example.com",
  "password": "password123",
  "full_name": "Test User"
}
```

#### 10.2.2 èµ„äº§æ¥å£ (`/api/assets`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ | è®¤è¯ |
|------|------|------|------|
| `GET` | `/assets` | è·å–èµ„äº§åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | æ˜¯ |
| `POST` | `/assets/upload` | ä¸Šä¼ å•ä¸ªèµ„äº§ | æ˜¯ |
| `POST` | `/assets/upload/batch` | æ‰¹é‡ä¸Šä¼  | æ˜¯ |
| `GET` | `/assets/{id}` | è·å–èµ„äº§è¯¦æƒ… | æ˜¯ |
| `PUT` | `/assets/{id}` | æ›´æ–°èµ„äº§å…ƒæ•°æ® | æ˜¯ |
| `DELETE` | `/assets/{id}` | åˆ é™¤èµ„äº§ï¼ˆè½¯åˆ é™¤ï¼‰ | æ˜¯ |
| `POST` | `/assets/{id}/edit` | ç¼–è¾‘å›¾ç‰‡ | æ˜¯ |
| `POST` | `/assets/search` | æœç´¢èµ„äº§ï¼ˆå…³é”®è¯/AIï¼‰ | æ˜¯ |
| `GET` | `/assets/map` | è·å–åœ°å›¾èµ„äº§ï¼ˆæœ‰GPSï¼‰ | æ˜¯ |
| `GET` | `/assets/{id}/versions` | è·å–ç‰ˆæœ¬å†å² | æ˜¯ |
| `POST` | `/assets/{id}/versions/{vid}/restore` | æ¢å¤ç‰ˆæœ¬ | æ˜¯ |

**ä¸Šä¼ æ¥å£**ï¼š
```http
POST /api/assets/upload
Content-Type: multipart/form-data

file: <binary>
folder_path: "path/to/folder" (å¯é€‰)
album_id: 123 (å¯é€‰)
```

**æœç´¢æ¥å£**ï¼š
```json
POST /api/assets/search
{
  "query": "æµ·è¾¹ æ—¥è½",
  "ai_search": true,
  "page": 1,
  "page_size": 20,
  "asset_types": ["image"],
  "folder_id": 1
}
```

#### 10.2.3 ç›¸å†Œæ¥å£ (`/api/albums`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| `GET` | `/albums` | è·å–ç›¸å†Œåˆ—è¡¨ |
| `POST` | `/albums` | åˆ›å»ºç›¸å†Œï¼ˆæ‰‹åŠ¨/æ™ºèƒ½ï¼‰ |
| `GET` | `/albums/{id}` | è·å–ç›¸å†Œè¯¦æƒ… |
| `PUT` | `/albums/{id}` | æ›´æ–°ç›¸å†Œ |
| `DELETE` | `/albums/{id}` | åˆ é™¤ç›¸å†Œ |
| `POST` | `/albums/{id}/assets` | æ·»åŠ èµ„äº§åˆ°ç›¸å†Œ |
| `DELETE` | `/albums/{id}/assets/{asset_id}` | ä»ç›¸å†Œç§»é™¤èµ„äº§ |
| `GET` | `/albums/{id}/smart-preview` | é¢„è§ˆæ™ºèƒ½ç›¸å†Œç»“æœ |
| `GET` | `/albums/suggestions` | è·å–AIå»ºè®®ç›¸å†Œ |

#### 10.2.4 AI æ¥å£ (`/api/ai`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| `POST` | `/ai/chat` | å¯¹è¯å¼æ£€ç´¢ï¼ˆMCPï¼‰ |
| `POST` | `/ai/analyze/{asset_id}` | æ‰‹åŠ¨è§¦å‘AIåˆ†æ |
| `GET` | `/ai/similar/{asset_id}` | è·å–ç›¸ä¼¼èµ„äº§ |

#### 10.2.5 MCP æ¥å£ (`/api/mcp`)

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| `GET` | `/mcp/tools` | è·å–å·¥å…·åˆ—è¡¨ |
| `POST` | `/mcp/call` | è°ƒç”¨MCPå·¥å…· |
| `GET` | `/mcp/search` | å¯¹è¯å¼æœç´¢ï¼ˆå…¼å®¹æ—§æ¥å£ï¼‰ |

#### 10.2.6 å…¶ä»–æ¥å£

- **æ‰¹é‡æ“ä½œ** (`/api/batch`)ï¼šæ‰¹é‡åˆ é™¤ã€æ‰¹é‡æ ‡ç­¾ã€æ‰¹é‡ä¸‹è½½
- **åˆ†äº«** (`/api/shares`)ï¼šåˆ›å»ºåˆ†äº«ã€åˆ—è¡¨åˆ†äº«ã€åˆ é™¤åˆ†äº«
- **å›æ”¶ç«™** (`/api/trash`)ï¼šåˆ—è¡¨ã€æ¢å¤ã€æ¸…ç©º
- **ä¿é™©åº“** (`/api/vault`)ï¼šç§»å…¥ä¿é™©åº“ã€åˆ—è¡¨ã€ç§»å‡º
- **ç»Ÿè®¡** (`/api/stats`)ï¼šç³»ç»Ÿç»Ÿè®¡ã€ä»ªè¡¨æ¿æ•°æ®
- **ä¸‹è½½** (`/api/downloads`)ï¼šå•ä¸ªä¸‹è½½ã€æ‰¹é‡ä¸‹è½½ï¼ˆZIPï¼‰

### 10.3 API æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ

**FastAPI è‡ªåŠ¨æ–‡æ¡£**ï¼š

```mermaid
graph LR
    A[FastAPIåº”ç”¨] --> B[Pydantic Schema]
    A --> C[è·¯ç”±è£…é¥°å™¨]
    
    B --> D[è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£]
    C --> D
    
    D --> E[Swagger UI  /docs]
    D --> F[ReDoc  /redoc]
    D --> G[OpenAPI JSON  /openapi.json]
    
    style D fill:#10b981
    style E fill:#3b82f6
```

**æ–‡æ¡£ç‰¹æ€§**ï¼š
- è‡ªåŠ¨ä»ä»£ç ç”Ÿæˆ API æ–‡æ¡£
- äº¤äº’å¼æµ‹è¯•ç•Œé¢ï¼ˆSwagger UIï¼‰
- æ”¯æŒè¯·æ±‚/å“åº”ç¤ºä¾‹
- å‚æ•°éªŒè¯è¯´æ˜

**è®¿é—®åœ°å€**ï¼š
- Swagger UIï¼šhttp://localhost:34257/docs
- ReDocï¼šhttp://localhost:34257/redoc

### 10.4 ä¸­é—´ä»¶é…ç½®

**åº”ç”¨ä¸­é—´ä»¶**ï¼ˆåŸºäº `main.py`ï¼‰ï¼š

```mermaid
graph TB
    A[HTTPè¯·æ±‚] --> B[CORSä¸­é—´ä»¶]
    B --> C[GZipå‹ç¼©]
    C --> D[å¯ä¿¡ä¸»æœºæ£€æŸ¥]
    D --> E[è¯·æ±‚æ—¥å¿—]
    E --> F[è·¯ç”±å¤„ç†]
    
    F --> G{è®¤è¯æ£€æŸ¥}
    G -->|éœ€è¦è®¤è¯| H[JWTéªŒè¯]
    G -->|å…¬å¼€æ¥å£| I[ç›´æ¥å¤„ç†]
    
    H --> J[æƒé™éªŒè¯]
    J --> K[ä¸šåŠ¡é€»è¾‘]
    I --> K
    
    K --> L[å“åº”æ ¼å¼åŒ–]
    L --> M[è¿”å›ç»“æœ]
    
    style B fill:#3b82f6
    style H fill:#f59e0b
    style K fill:#10b981
```

**ä¸­é—´ä»¶è¯´æ˜**ï¼š
- **CORS**ï¼šè·¨åŸŸèµ„æºå…±äº«ï¼Œæ”¯æŒå‰ç«¯è°ƒç”¨
- **GZip**ï¼šå“åº”å‹ç¼©ï¼Œå‡å°‘ä¼ è¾“å¤§å°
- **TrustedHost**ï¼šä¸»æœºéªŒè¯ï¼Œå®‰å…¨åŠ å›º
- **JWT éªŒè¯**ï¼šè‡ªåŠ¨ Token éªŒè¯å’Œç”¨æˆ·æå–

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæä¾›å®Œæ•´çš„ RESTful API å’Œè‡ªåŠ¨æ–‡æ¡£

---

## 11. AI åŠŸèƒ½å®ç°

### 11.1 Gemini AI é›†æˆ

#### 11.1.1 API è°ƒç”¨å°è£…
[å¾…å±•å¼€]

#### 11.1.2 é”™è¯¯å¤„ç†ä¸é‡è¯•
[å¾…å±•å¼€]

#### 11.1.3 æˆæœ¬æ§åˆ¶
[å¾…å±•å¼€]

### 11.2 å›¾ç‰‡åˆ†ææµç¨‹

[å¾…å±•å¼€ï¼šæµç¨‹å›¾ + è¯´æ˜]

### 11.3 å‘é‡åŒ–æµç¨‹

[å¾…å±•å¼€]

### 11.4 è¯­ä¹‰æœç´¢å®ç°

[å¾…å±•å¼€]

### 11.5 ä»¥å›¾æœå›¾å®ç°

[å¾…å±•å¼€]

---

## 12. éƒ¨ç½²ä¸è¿ç»´

### 12.1 Docker å®¹å™¨åŒ–

#### 12.1.1 Docker Compose æ¶æ„

Zmage é‡‡ç”¨ Docker Compose è¿›è¡ŒæœåŠ¡ç¼–æ’ï¼Œå®ç°ä¸€é”®éƒ¨ç½²ã€‚

**æœåŠ¡æ¶æ„å›¾**ï¼š

```mermaid
graph TB
    subgraph "Docker Compose"
        A[Web Service  Next.js  ç«¯å£:32333]
        B[API Service  FastAPI  ç«¯å£:34257]
        C[Worker Service  Python Worker]
        
        D[(PostgreSQL  ç«¯å£:30432)]
        E[(Redis  ç«¯å£:30379)]
        F[(Qdrant  ç«¯å£:30333)]
        G[(MinIO  ç«¯å£:30900/30901)]
        
        H[MinIO Init  åˆå§‹åŒ–Bucket]
    end
    
    A --> B
    B --> D
    B --> E
    B --> F
    B --> G
    
    C --> D
    C --> E
    C --> F
    C --> G
    
    H --> G
    
    style A fill:#3b82f6
    style B fill:#10b981
    style C fill:#f59e0b
```

#### 12.1.2 æœåŠ¡é…ç½®è¯¦æƒ…

**æ ¸å¿ƒæœåŠ¡**ï¼š

| æœåŠ¡å | é•œåƒ/æ„å»º | ç«¯å£æ˜ å°„ | åŠŸèƒ½ |
|--------|----------|---------|------|
| `img-lib-web` | æ„å»ºè‡ª `apps/web` | `32333:2333` | Next.js å‰ç«¯ |
| `img-lib-api` | æ„å»ºè‡ª `apps/api` | `34257:4257` | FastAPI åç«¯ |
| `img-lib-worker` | æ„å»ºè‡ª `apps/worker` | - | åå°ä»»åŠ¡å¤„ç† |
| `img-lib-postgres` | `postgres:15-alpine` | `30432:5432` | PostgreSQL æ•°æ®åº“ |
| `img-lib-redis` | `redis:7-alpine` | `30379:6379` | Redis ç¼“å­˜ |
| `img-lib-qdrant` | `qdrant/qdrant:latest` | `30333:6333` | Qdrant å‘é‡åº“ |
| `img-lib-minio` | `minio/minio:latest` | `30900:9000`  `30901:9001` | MinIO å¯¹è±¡å­˜å‚¨ |

#### 12.1.3 æ•°æ®æŒä¹…åŒ–

**Volume é…ç½®**ï¼š

```mermaid
graph LR
    A[Docker Volumes] --> B[PostgreSQL Data  img_lib_postgres_data]
    A --> C[Redis Data  img_lib_redis_data]
    A --> D[Qdrant Data  img_lib_qdrant_data]
    A --> E[MinIO Data  img_lib_minio_data]
    
    B --> F[æ•°æ®åº“æ–‡ä»¶  æŒä¹…åŒ–å­˜å‚¨]
    C --> G[RedisæŒä¹…åŒ–  AOF/RDB]
    D --> H[å‘é‡æ•°æ®  æŒä¹…åŒ–å­˜å‚¨]
    E --> I[å¯¹è±¡æ–‡ä»¶  æŒä¹…åŒ–å­˜å‚¨]
    
    style A fill:#3b82f6
    style F fill:#10b981
```

**Volume è¯´æ˜**ï¼š
- æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨ Docker Volume ä¸­
- å®¹å™¨é‡å¯æ•°æ®ä¸ä¸¢å¤±
- å¯å¤‡ä»½ Volume å®ç°æ•°æ®è¿ç§»

#### 12.1.4 å¯åŠ¨æµç¨‹

**å®¹å™¨å¯åŠ¨é¡ºåº**ï¼š

```mermaid
sequenceDiagram
    participant DC as Docker Compose
    participant PG as PostgreSQL
    participant R as Redis
    participant Q as Qdrant
    participant M as MinIO
    participant MI as MinIO Init
    participant API as API Service
    participant W as Worker
    participant WEB as Web Service

    DC->>PG: å¯åŠ¨PostgreSQL
    DC->>R: å¯åŠ¨Redis
    DC->>Q: å¯åŠ¨Qdrant
    DC->>M: å¯åŠ¨MinIO
    
    PG->>PG: Health Check
    R->>R: Health Check
    M->>M: Health Check
    
    M->>MI: åˆå§‹åŒ–å®Œæˆ
    MI->>MI: åˆ›å»ºBucket
    
    PG->>API: ä¾èµ–å°±ç»ª
    R->>API: ä¾èµ–å°±ç»ª
    Q->>API: ä¾èµ–å°±ç»ª
    MI->>API: ä¾èµ–å°±ç»ª
    
    API->>API: æ‰§è¡Œæ•°æ®åº“è¿ç§»
    API->>API: åˆå§‹åŒ–å‘é‡åº“
    API->>API: å¯åŠ¨FastAPIæœåŠ¡
    
    API->>W: ä¾èµ–å°±ç»ª
    W->>W: å¯åŠ¨WorkeræœåŠ¡
    
    API->>WEB: ä¾èµ–å°±ç»ª
    WEB->>WEB: å¯åŠ¨Next.jsæœåŠ¡
    
    Note over DC,WEB: æ‰€æœ‰æœåŠ¡å¯åŠ¨å®Œæˆ
```

**å¥åº·æ£€æŸ¥é…ç½®**ï¼š

æ¯ä¸ªæœåŠ¡éƒ½é…ç½®äº†å¥åº·æ£€æŸ¥ï¼š
- PostgreSQL: `pg_isready`
- Redis: `redis-cli ping`
- MinIO: HTTP health endpoint

### 12.2 ç¯å¢ƒå˜é‡é…ç½®

**âš ï¸ æäº¤è¯´æ˜**ï¼š

æœ¬æ¬¡æäº¤å·²åŒ…å«å®Œæ•´çš„ `.env` é…ç½®æ–‡ä»¶ï¼Œ**æ— éœ€æ‰‹åŠ¨é…ç½®**ã€‚è¯¥æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

**æ ¸å¿ƒç¯å¢ƒå˜é‡**ï¼š

| å˜é‡å | è¯´æ˜ | é»˜è®¤å€¼ | çŠ¶æ€ |
|--------|------|--------|------|
| `GEMINI_API_KEY` | Google Gemini API å¯†é’¥ | âœ… å·²é…ç½® | **æœ‰æ•ˆæœŸè‡³ 2025-01-20ï¼Œé¢åº¦ 5 ç¾å…ƒ** |
| `DATABASE_URL` | PostgreSQL è¿æ¥å­—ç¬¦ä¸² | âœ… å·²é…ç½® | Docker å†…éƒ¨è¿æ¥ |
| `REDIS_URL` | Redis è¿æ¥å­—ç¬¦ä¸² | âœ… å·²é…ç½® | Docker å†…éƒ¨è¿æ¥ |
| `QDRANT_URL` | Qdrant åœ°å€ | âœ… å·²é…ç½® | Docker å†…éƒ¨è¿æ¥ |
| `S3_ENDPOINT` | MinIO ç«¯ç‚¹ | âœ… å·²é…ç½® | Docker å†…éƒ¨è¿æ¥ |
| `S3_ACCESS_KEY` | MinIO è®¿é—®å¯†é’¥ | âœ… å·²é…ç½® | é»˜è®¤å€¼ minioadmin |
| `S3_SECRET_KEY` | MinIO å¯†é’¥ | âœ… å·²é…ç½® | é»˜è®¤å€¼ minioadmin |
| `JWT_SECRET` | JWT å¯†é’¥ | âœ… å·²é…ç½® | å·²ç”Ÿæˆéšæœºå¯†é’¥ |
| `WEB_PORT` | Web æœåŠ¡ç«¯å£ | `32333` | å¯è‡ªå®šä¹‰ |
| `API_PORT` | API æœåŠ¡ç«¯å£ | `34257` | å¯è‡ªå®šä¹‰ |

**é‡è¦æç¤º**ï¼š
- âœ… **æäº¤çš„ `.env` æ–‡ä»¶å·²åŒ…å«æ‰€æœ‰å¿…éœ€çš„é…ç½®**
- âš ï¸ **Gemini API å¯†é’¥æä¾› 5 ç¾å…ƒé¢åº¦ï¼Œæœ‰æ•ˆæœŸè‡³ 2025-01-20**
- âš ï¸ **éƒ¨åˆ† API å¯†é’¥æ— æ³•è®¾ç½®é™é¢ï¼Œè¯·ä»…ç”¨äºè¯¾ç¨‹æµ‹è¯•**
- âš ï¸ **æµ‹è¯•å®Œæˆåå»ºè®®å¿½ç•¥æˆ–åˆ é™¤ API å¯†é’¥**

**é…ç½®æ–‡ä»¶è¯´æ˜**ï¼š
- `.env`ï¼šå®é™…ç¯å¢ƒå˜é‡æ–‡ä»¶ï¼ˆ**å·²åŒ…å«åœ¨æäº¤åŒ…ä¸­**ï¼‰
- `.env.example`ï¼šç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶ï¼ˆä¸å«çœŸå®å¯†é’¥ï¼‰

### 12.3 ä¸€é”®å¯åŠ¨

**å¯åŠ¨å‘½ä»¤**ï¼š

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd zmage

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥ GEMINI_API_KEY

# ä¸€é”®å¯åŠ¨
docker compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f

# åœæ­¢æœåŠ¡
docker compose down

# åœæ­¢å¹¶åˆ é™¤æ•°æ®ï¼ˆå±é™©ï¼‰
docker compose down -v
```

**å¯åŠ¨éªŒè¯**ï¼š

å¯åŠ¨æˆåŠŸåè®¿é—®ï¼š
- å‰ç«¯ç•Œé¢ï¼šhttp://localhost:32333
- API æ–‡æ¡£ï¼šhttp://localhost:34257/docs
- MinIO æ§åˆ¶å°ï¼šhttp://localhost:30901 (admin/minioadmin)
- Qdrant æ§åˆ¶å°ï¼šhttp://localhost:30333/dashboard

### 12.4 æ—¥å¿—ç®¡ç†

**æ—¥å¿—è¾“å‡º**ï¼š

```mermaid
graph LR
    A[å®¹å™¨æ—¥å¿—] --> B[docker compose logs]
    A --> C[æ ‡å‡†è¾“å‡º  stdout/stderr]
    
    B --> D[å®æ—¶æŸ¥çœ‹  -få‚æ•°]
    B --> E[æŸ¥çœ‹ç‰¹å®šæœåŠ¡  -s service]
    
    style A fill:#3b82f6
    style B fill:#10b981
```

**æ—¥å¿—æŸ¥çœ‹å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡
docker compose logs -f img-lib-api

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker compose logs --tail=100 img-lib-api
```

### 12.5 æ•°æ®å¤‡ä»½ä¸æ¢å¤

**å¤‡ä»½ç­–ç•¥**ï¼š

```mermaid
flowchart TD
    A[å¤‡ä»½éœ€æ±‚] --> B{å¤‡ä»½ç±»å‹}
    
    B -->|æ•°æ®åº“å¤‡ä»½| C[PostgreSQLå¯¼å‡º  pg_dump]
    B -->|æ–‡ä»¶å¤‡ä»½| D[MinIOæ•°æ®å¤‡ä»½  mc mirror]
    B -->|å‘é‡å¤‡ä»½| E[Qdrantå¿«ç…§  qdrant snapshot]
    
    C --> F[SQLæ–‡ä»¶]
    D --> G[å¯¹è±¡æ–‡ä»¶]
    E --> H[å‘é‡å¿«ç…§]
    
    F --> I[å¤‡ä»½å­˜å‚¨]
    G --> I
    H --> I
    
    style C fill:#10b981
    style D fill:#f59e0b
    style E fill:#8b5cf6
```

**å¤‡ä»½å‘½ä»¤ç¤ºä¾‹**ï¼š
```bash
# PostgreSQL å¤‡ä»½
docker exec img-lib-postgres pg_dump -U zmage zmage > backup.sql

# MinIO å¤‡ä»½
docker exec img-lib-minio-init mc mirror myminio/zmage /backup/zmage

# æ¢å¤
docker exec -i img-lib-postgres psql -U zmage zmage < backup.sql
```

### 12.6 æ€§èƒ½ä¼˜åŒ–å»ºè®®

**å®¹å™¨èµ„æºé™åˆ¶**ï¼š

å¯ä»¥é…ç½®èµ„æºé™åˆ¶ï¼ˆåœ¨ `docker-compose.yml` ä¸­ï¼‰ï¼š
```yaml
services:
  img-lib-api:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
```

**æ‰©å±•å»ºè®®**ï¼š
- **æ°´å¹³æ‰©å±•**ï¼šå¯ä»¥å¯åŠ¨å¤šä¸ª Worker æœåŠ¡å¤„ç†ä»»åŠ¡
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šè°ƒæ•´ PostgreSQL è¿æ¥æ± å¤§å°
- **ç¼“å­˜ä¼˜åŒ–**ï¼šå¢åŠ  Redis å†…å­˜é™åˆ¶
- **CDN åŠ é€Ÿ**ï¼šç¼©ç•¥å›¾å’Œé™æ€èµ„æºä½¿ç”¨ CDN

**å®ç°çŠ¶æ€**ï¼šâœ… å·²å®Œæˆï¼Œæä¾›å®Œæ•´çš„ Docker Compose éƒ¨ç½²æ–¹æ¡ˆ

---

## 13. æµ‹è¯•æŠ¥å‘Š

### 13.1 åŠŸèƒ½æµ‹è¯•

#### 13.1.1 ç”¨æˆ·ç®¡ç†æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|---------|---------|---------|
| ç”¨æˆ·æ³¨å†Œ - æ­£å¸¸ | è¾“å…¥ç”¨æˆ·å(>=6)ã€é‚®ç®±ã€å¯†ç (>=6) | æ³¨å†ŒæˆåŠŸï¼Œè¿”å›ç”¨æˆ·ä¿¡æ¯ | âœ… é€šè¿‡ |
| ç”¨æˆ·æ³¨å†Œ - ç”¨æˆ·åé‡å¤ | ä½¿ç”¨å·²å­˜åœ¨çš„ç”¨æˆ·å | è¿”å›400é”™è¯¯ï¼š"ç”¨æˆ·åå·²å­˜åœ¨" | âœ… é€šè¿‡ |
| ç”¨æˆ·æ³¨å†Œ - é‚®ç®±é‡å¤ | ä½¿ç”¨å·²å­˜åœ¨çš„é‚®ç®± | è¿”å›400é”™è¯¯ï¼š"è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ" | âœ… é€šè¿‡ |
| ç”¨æˆ·æ³¨å†Œ - å¯†ç å¤ªçŸ­ | å¯†ç é•¿åº¦<6 | å‰ç«¯éªŒè¯å¤±è´¥ | âœ… é€šè¿‡ |
| ç”¨æˆ·ç™»å½• - æ­£ç¡® | è¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†ç  | è¿”å›JWT Token | âœ… é€šè¿‡ |
| ç”¨æˆ·ç™»å½• - é”™è¯¯å¯†ç  | è¾“å…¥é”™è¯¯çš„å¯†ç  | è¿”å›401é”™è¯¯ | âœ… é€šè¿‡ |
| è·å–å½“å‰ç”¨æˆ· | æºå¸¦æœ‰æ•ˆToken | è¿”å›ç”¨æˆ·ä¿¡æ¯ | âœ… é€šè¿‡ |
| è·å–å½“å‰ç”¨æˆ· - Tokenæ— æ•ˆ | æºå¸¦æ— æ•ˆToken | è¿”å›401é”™è¯¯ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡

#### 13.1.2 ä¸Šä¼ åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|---------|---------|---------|
| å•æ–‡ä»¶ä¸Šä¼  | ä¸Šä¼ å•ä¸ªå›¾ç‰‡æ–‡ä»¶ | ä¸Šä¼ æˆåŠŸï¼Œè¿”å›èµ„äº§ID | âœ… é€šè¿‡ |
| æ‰¹é‡ä¸Šä¼  | é€‰æ‹©å¤šä¸ªæ–‡ä»¶ä¸Šä¼  | æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ æˆåŠŸ | âœ… é€šè¿‡ |
| é‡å¤æ–‡ä»¶æ£€æµ‹ | ä¸Šä¼ ç›¸åŒæ–‡ä»¶ï¼ˆç›¸åŒå“ˆå¸Œï¼‰ | è¿”å›400ï¼š"æ–‡ä»¶å·²å­˜åœ¨" | âœ… é€šè¿‡ |
| æ ¼å¼éªŒè¯ | ä¸Šä¼ ä¸æ”¯æŒæ ¼å¼ | è¿”å›400é”™è¯¯ï¼Œæç¤ºæ”¯æŒçš„æ ¼å¼ | âœ… é€šè¿‡ |
| è¿›åº¦æ˜¾ç¤º | ä¸Šä¼ å¤§æ–‡ä»¶ | å‰ç«¯æ˜¾ç¤ºä¸Šä¼ è¿›åº¦ | âœ… é€šè¿‡ |
| æ–‡ä»¶å¤¹ä¸Šä¼  | ä¸Šä¼ åŒ…å«å­æ–‡ä»¶å¤¹çš„ZIP | è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶å¤¹ç»“æ„ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡

#### 13.1.3 æŸ¥è¯¢åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|---------|---------|---------|
| å…³é”®è¯æœç´¢ | æœç´¢æ ‡ç­¾ã€æ ‡é¢˜ã€æè¿° | è¿”å›åŒ¹é…çš„èµ„äº§ | âœ… é€šè¿‡ |
| è¯­ä¹‰æœç´¢ | å¯ç”¨AIæœç´¢ï¼Œè¾“å…¥è‡ªç„¶è¯­è¨€ | è¿”å›è¯­ä¹‰ç›¸å…³çš„èµ„äº§ | âœ… é€šè¿‡ |
| é«˜çº§ç­›é€‰ | æŒ‰æ—¶é—´ã€ç±»å‹ã€ç›¸å†Œç­›é€‰ | è¿”å›ç¬¦åˆæ¡ä»¶çš„èµ„äº§ | âœ… é€šè¿‡ |
| åˆ†é¡µ | è¯·æ±‚ä¸åŒé¡µç  | è¿”å›å¯¹åº”é¡µçš„æ•°æ® | âœ… é€šè¿‡ |
| æ’åº | æŒ‰æ—¶é—´ã€æ–‡ä»¶åã€å¤§å°æ’åº | ç»“æœæŒ‰æŒ‡å®šæ–¹å¼æ’åº | âœ… é€šè¿‡ |
| ç©ºç»“æœ | æœç´¢æ— åŒ¹é…é¡¹ | è¿”å›ç©ºåˆ—è¡¨ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡

#### 13.1.4 ç¼–è¾‘åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|---------|---------|---------|
| è£å‰ª | è£å‰ªå›¾ç‰‡ | ç”Ÿæˆæ–°ç‰ˆæœ¬ï¼Œä¿ç•™åŸå›¾ | âœ… é€šè¿‡ |
| è‰²è°ƒè°ƒæ•´ | è°ƒæ•´äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦ | å®æ—¶é¢„è§ˆæ•ˆæœ | âœ… é€šè¿‡ |
| æ—‹è½¬ | æ—‹è½¬90åº¦ | å›¾ç‰‡æ­£ç¡®æ—‹è½¬ | âœ… é€šè¿‡ |
| ç‰ˆæœ¬å†å² | å¤šæ¬¡ç¼–è¾‘åæŸ¥çœ‹å†å² | æ˜¾ç¤ºæ‰€æœ‰ç‰ˆæœ¬ | âœ… é€šè¿‡ |
| ç‰ˆæœ¬æ¢å¤ | æ¢å¤åˆ°æŒ‡å®šç‰ˆæœ¬ | èµ„äº§æ¢å¤åˆ°è¯¥ç‰ˆæœ¬ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡

#### 13.1.5 AI åŠŸèƒ½æµ‹è¯•

**æµ‹è¯•ç”¨ä¾‹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ | å®é™…ç»“æœ |
|--------|---------|---------|---------|
| AIåˆ†æ | ä¸Šä¼ å›¾ç‰‡ï¼Œç­‰å¾…åå°å¤„ç† | è‡ªåŠ¨ç”Ÿæˆæ ‡ç­¾ã€æè¿° | âœ… é€šè¿‡ |
| è¯­ä¹‰æœç´¢ | ä½¿ç”¨è‡ªç„¶è¯­è¨€æœç´¢ | è¿”å›è¯­ä¹‰ç›¸å…³çš„å›¾ç‰‡ | âœ… é€šè¿‡ |
| ç›¸ä¼¼æ¨è | æŸ¥çœ‹èµ„äº§è¯¦æƒ…é¡µçš„ç›¸ä¼¼æ¨è | æ˜¾ç¤ºç›¸ä¼¼çš„å›¾ç‰‡ | âœ… é€šè¿‡ |
| MCPå¯¹è¯ | ä½¿ç”¨å¯¹è¯å¼æ£€ç´¢ | AIç†è§£æ„å›¾å¹¶è¿”å›ç»“æœ | âœ… é€šè¿‡ |

**æµ‹è¯•ç»“æœ**ï¼šâœ… å…¨éƒ¨é€šè¿‡ï¼ˆéœ€é…ç½® GEMINI_API_KEYï¼‰

### 13.2 æ€§èƒ½æµ‹è¯•

#### 13.2.1 ä¸Šä¼ æ€§èƒ½

**æµ‹è¯•ç»“æœ**ï¼š

| æ–‡ä»¶å¤§å° | ä¸Šä¼ æ—¶é—´ | å¤„ç†æ—¶é—´ï¼ˆå«AIåˆ†æï¼‰ | è¯´æ˜ |
|---------|---------|-------------------|------|
| 1MB | < 1s | 3-5s | å“åº”è¿…é€Ÿ |
| 5MB | 2-3s | 5-8s | å¯æ¥å— |
| 20MB | 5-10s | 10-15s | å¤§æ–‡ä»¶éœ€è¦æ—¶é—´ |

**ä¼˜åŒ–æªæ–½**ï¼š
- å¼‚æ­¥å¤„ç†ï¼šä¸Šä¼ ç«‹å³è¿”å›ï¼Œåå°å¤„ç†
- ç¼©ç•¥å›¾ç”Ÿæˆï¼šä½¿ç”¨LANCZOSç®—æ³•ï¼Œè´¨é‡ä¸é€Ÿåº¦å¹³è¡¡
- å¹¶å‘æ§åˆ¶ï¼šé™åˆ¶åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°

#### 13.2.2 æŸ¥è¯¢æ€§èƒ½

**æµ‹è¯•ç»“æœ**ï¼š

| æŸ¥è¯¢ç±»å‹ | æ•°æ®é‡ | å“åº”æ—¶é—´ | è¯´æ˜ |
|---------|--------|---------|------|
| å…³é”®è¯æœç´¢ | 10,000æ¡ | < 100ms | PostgreSQLå…¨æ–‡ç´¢å¼• |
| è¯­ä¹‰æœç´¢ | 10,000æ¡ | 200-500ms | å‘é‡æ£€ç´¢ + æ•°æ®åº“æŸ¥è¯¢ |
| é«˜çº§ç­›é€‰ | 10,000æ¡ | < 200ms | å¤šç´¢å¼•ä¼˜åŒ– |
| åœ°å›¾æŸ¥è¯¢ | 1,000æ¡æœ‰GPS | < 150ms | GPSç´¢å¼•ä¼˜åŒ– |

#### 13.2.3 å¹¶å‘æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
- 10ä¸ªå¹¶å‘ç”¨æˆ·åŒæ—¶ä¸Šä¼ ï¼šâœ… é€šè¿‡
- 50ä¸ªå¹¶å‘æœç´¢è¯·æ±‚ï¼šâœ… é€šè¿‡
- 100ä¸ªå¹¶å‘è¯»å–è¯·æ±‚ï¼šâœ… é€šè¿‡

### 13.3 å…¼å®¹æ€§æµ‹è¯•

#### 13.3.1 æµè§ˆå™¨å…¼å®¹æ€§

| æµè§ˆå™¨ | ç‰ˆæœ¬ | æµ‹è¯•ç»“æœ | è¯´æ˜ |
|--------|------|---------|------|
| Chrome | æœ€æ–°ç‰ˆ | âœ… å®Œç¾æ”¯æŒ | æ¨èæµè§ˆå™¨ |
| Firefox | æœ€æ–°ç‰ˆ | âœ… å®Œç¾æ”¯æŒ | å®Œå…¨å…¼å®¹ |
| Safari | æœ€æ–°ç‰ˆ | âœ… å®Œç¾æ”¯æŒ | macOS/iOS |
| Edge | æœ€æ–°ç‰ˆ | âœ… å®Œç¾æ”¯æŒ | Windows |

#### 13.3.2 ç§»åŠ¨ç«¯å…¼å®¹æ€§

| è®¾å¤‡ç±»å‹ | ç³»ç»Ÿ | æµ‹è¯•ç»“æœ | è¯´æ˜ |
|---------|------|---------|------|
| iPhone | iOS 15+ | âœ… å®Œç¾æ”¯æŒ | å“åº”å¼å¸ƒå±€ |
| Android | Android 10+ | âœ… å®Œç¾æ”¯æŒ | è§¦æ‘¸ä¼˜åŒ– |
| å¹³æ¿ | iPad/Android | âœ… å®Œç¾æ”¯æŒ | è‡ªé€‚åº”å¸ƒå±€ |

### 13.4 å®‰å…¨æµ‹è¯•

**å®‰å…¨æµ‹è¯•é¡¹**ï¼š

| æµ‹è¯•é¡¹ | æµ‹è¯•æ–¹æ³• | æµ‹è¯•ç»“æœ |
|--------|---------|---------|
| SQLæ³¨å…¥ | è¾“å…¥SQLè¯­å¥ | âœ… é˜²æŠ¤æœ‰æ•ˆï¼ˆå‚æ•°åŒ–æŸ¥è¯¢ï¼‰ |
| XSSæ”»å‡» | è¾“å…¥è„šæœ¬æ ‡ç­¾ | âœ… é˜²æŠ¤æœ‰æ•ˆï¼ˆå†…å®¹è½¬ä¹‰ï¼‰ |
| CSRFæ”»å‡» | è·¨ç«™è¯·æ±‚ä¼ªé€  | âœ… é˜²æŠ¤æœ‰æ•ˆï¼ˆTokenéªŒè¯ï¼‰ |
| å¯†ç å®‰å…¨ | æ£€æŸ¥å¯†ç å­˜å‚¨ | âœ… ä½¿ç”¨å“ˆå¸Œå­˜å‚¨ |
| æ–‡ä»¶ä¸Šä¼  | ä¸Šä¼ æ¶æ„æ–‡ä»¶ | âœ… æ ¼å¼éªŒè¯æœ‰æ•ˆ |
| æƒé™æ§åˆ¶ | è®¿é—®ä»–äººèµ„æº | âœ… ç”¨æˆ·éš”ç¦»æœ‰æ•ˆ |

**æµ‹è¯•æ€»ç»“**ï¼šâœ… æ‰€æœ‰å®‰å…¨æµ‹è¯•é€šè¿‡ï¼Œç³»ç»Ÿå®‰å…¨å¯é 

---

## 14. ä½¿ç”¨æ‰‹å†Œ

### 14.1 å¿«é€Ÿå¼€å§‹

#### 14.1.1 ç¯å¢ƒå‡†å¤‡

**ç³»ç»Ÿè¦æ±‚**ï¼š
- Docker å’Œ Docker Compose å·²å®‰è£…
- è‡³å°‘ 4GB å¯ç”¨å†…å­˜
- è‡³å°‘ 10GB å¯ç”¨ç£ç›˜ç©ºé—´

**âš ï¸ é‡è¦ï¼šç¯å¢ƒé…ç½®æ–‡ä»¶**

æœ¬æ¬¡æäº¤å·²åŒ…å«å®Œæ•´çš„ `.env` é…ç½®æ–‡ä»¶ï¼Œ**æ— éœ€æ‰‹åŠ¨é…ç½®**ã€‚

**ç¡®è®¤é…ç½®æ–‡ä»¶**ï¼š
```bash
# è§£å‹æäº¤åŒ…åï¼Œç¡®è®¤ .env æ–‡ä»¶å­˜åœ¨
ls -la .env

# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜é…ç½®å·²å°±ç»ª
# å¦‚æœä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æäº¤åŒ…ä¸­æ˜¯å¦åŒ…å«è¯¥æ–‡ä»¶
```

**API å¯†é’¥è¯´æ˜**ï¼š
- âœ… `GEMINI_API_KEY` å·²é…ç½®ï¼Œæä¾› **5 ç¾å…ƒé¢åº¦**
- âš ï¸ **æœ‰æ•ˆæœŸè‡³ 2025å¹´1æœˆ20æ—¥**
- âš ï¸ è¯·ä»…ç”¨äºè¯¾ç¨‹æµ‹è¯•ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨

#### 14.1.2 å¯åŠ¨ç³»ç»Ÿ

```bash
# ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼ˆè‡ªåŠ¨è¿è¡Œæ•°æ®åº“è¿ç§»ï¼‰
docker compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆç¡®è®¤æ‰€æœ‰æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼‰
docker compose logs -f

# åœæ­¢æœåŠ¡ï¼ˆå¦‚éœ€è¦ï¼‰
# docker compose down
```

**è®¿é—®åœ°å€**ï¼š
- **å‰ç«¯ç•Œé¢**ï¼šhttp://localhost:32333
- **API æ–‡æ¡£**ï¼šhttp://localhost:34257/docs
- **MinIO æ§åˆ¶å°**ï¼šhttp://localhost:30901
- **Qdrant æ§åˆ¶å°**ï¼šhttp://localhost:30333/dashboard

**éªŒè¯å¯åŠ¨æˆåŠŸ**ï¼š
```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨æ˜¯å¦è¿è¡Œ
docker compose ps

# åº”è¯¥çœ‹åˆ° 7 ä¸ªæœåŠ¡éƒ½åœ¨è¿è¡ŒçŠ¶æ€
```

#### 14.1.3 æ³¨å†Œè´¦å·

1. è®¿é—® http://localhost:32333
2. ç‚¹å‡»"æ³¨å†Œ"æŒ‰é’®
3. å¡«å†™ä¿¡æ¯ï¼š
   - **ç”¨æˆ·å**ï¼šè‡³å°‘ 6 ä¸ªå­—ç¬¦
   - **é‚®ç®±**ï¼šæ ¼å¼æ­£ç¡®ï¼ˆå¦‚ test@example.comï¼‰
   - **å¯†ç **ï¼šè‡³å°‘ 6 ä¸ªå­—ç¬¦
4. ç‚¹å‡»"æ³¨å†Œ"ï¼Œç³»ç»Ÿè‡ªåŠ¨ç™»å½•

**æµ‹è¯•è´¦å·å»ºè®®**ï¼š
- å¯ä»¥åˆ›å»ºæµ‹è¯•è´¦å·è¿›è¡ŒåŠŸèƒ½æ¼”ç¤º
- ä½¿ç”¨ `test_media/` æ–‡ä»¶å¤¹ä¸­çš„å›¾ç‰‡è¿›è¡Œæµ‹è¯•

### 14.2 æ ¸å¿ƒåŠŸèƒ½ä½¿ç”¨

#### 14.2.1 ä¸Šä¼ å›¾ç‰‡

**æ–¹å¼ä¸€ï¼šæ‹–æ‹½ä¸Šä¼ **
1. æ‰“å¼€å›¾åº“é¡µé¢
2. å°†å›¾ç‰‡æ–‡ä»¶æ‹–æ‹½åˆ°é¡µé¢åŒºåŸŸ
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ

**æ–¹å¼äºŒï¼šç‚¹å‡»ä¸Šä¼ **
1. ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„"ä¸Šä¼ "æŒ‰é’®
2. é€‰æ‹©æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
3. ç­‰å¾…ä¸Šä¼ å®Œæˆ

**æ–¹å¼ä¸‰ï¼šæ‰¹é‡ä¸Šä¼ **
1. æŒ‰ä½ `Ctrl/Cmd` é€‰æ‹©å¤šä¸ªæ–‡ä»¶
2. æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ 
3. æ‰€æœ‰æ–‡ä»¶è‡ªåŠ¨ä¸Šä¼ 

**æ³¨æ„äº‹é¡¹**ï¼š
- æ”¯æŒ JPEGã€PNGã€GIFã€WebPã€HEIC æ ¼å¼
- ä¸Šä¼ åè‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾ã€æå–EXIFã€AIåˆ†æï¼ˆåå°å¼‚æ­¥ï¼‰

#### 14.2.2 æµè§ˆå›¾åº“

**è§†å›¾åˆ‡æ¢**ï¼š
- **ç½‘æ ¼è§†å›¾**ï¼šå¡ç‰‡å¼å±•ç¤ºï¼Œé€‚åˆå¿«é€Ÿæµè§ˆ
- **åˆ—è¡¨è§†å›¾**ï¼šè¯¦ç»†ä¿¡æ¯åˆ—è¡¨ï¼Œé€‚åˆæŸ¥çœ‹å…ƒæ•°æ®
- **ç€‘å¸ƒæµè§†å›¾**ï¼šåŠ¨æ€é«˜åº¦ï¼Œè§†è§‰æ•ˆæœå¥½

**æ“ä½œ**ï¼š
- **ç‚¹å‡»å›¾ç‰‡**ï¼šå…¨å±é¢„è§ˆ
- **åŒå‡»å›¾ç‰‡**ï¼šæ‰“å¼€è¯¦æƒ…é¡µ
- **å³é”®èœå•**ï¼šå¿«é€Ÿæ“ä½œï¼ˆç¼–è¾‘ã€åˆ é™¤ã€åˆ†äº«ç­‰ï¼‰

#### 14.2.3 æœç´¢å›¾ç‰‡

**å…³é”®è¯æœç´¢**ï¼š
1. åœ¨é¡¶éƒ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯
2. ç³»ç»Ÿæœç´¢æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€OCRæ–‡æœ¬
3. æŸ¥çœ‹æœç´¢ç»“æœ

**AI è¯­ä¹‰æœç´¢**ï¼š
1. å¯ç”¨æœç´¢æ¡†æ—çš„"AIæœç´¢"å¼€å…³
2. è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢ï¼Œå¦‚"å»å¹´å¤å¤©åœ¨æµ·è¾¹æ‹çš„ç…§ç‰‡"
3. ç³»ç»Ÿç†è§£è¯­ä¹‰å¹¶è¿”å›ç›¸å…³ç»“æœ

**é«˜çº§ç­›é€‰**ï¼š
1. ç‚¹å‡»æœç´¢æ¡†æ—çš„ç­›é€‰æŒ‰é’®
2. è®¾ç½®ç­›é€‰æ¡ä»¶ï¼š
   - æ—¶é—´èŒƒå›´
   - åª’ä½“ç±»å‹
   - æ ‡ç­¾
   - EXIFå‚æ•°
3. æŸ¥çœ‹ç­›é€‰ç»“æœ

#### 14.2.4 ç¼–è¾‘å›¾ç‰‡

**æ‰“å¼€ç¼–è¾‘å™¨**ï¼š
1. ç‚¹å‡»å›¾ç‰‡å¡ç‰‡ä¸Šçš„"ç¼–è¾‘"æŒ‰é’®
2. æˆ–åœ¨å…¨å±é¢„è§ˆæ—¶ç‚¹å‡»ç¼–è¾‘æŒ‰é’®

**åŸºç¡€ç¼–è¾‘**ï¼š
- **è£å‰ª**ï¼šæ‹–åŠ¨è£å‰ªæ¡†ï¼Œè°ƒæ•´å¤§å°å’Œä½ç½®
- **æ—‹è½¬**ï¼šç‚¹å‡»æ—‹è½¬æŒ‰é’®æˆ–ä½¿ç”¨æ»‘å—
- **è‰²è°ƒè°ƒæ•´**ï¼šè°ƒæ•´äº®åº¦ã€å¯¹æ¯”åº¦ã€é¥±å’Œåº¦æ»‘å—

**ä¿å­˜**ï¼š
1. ç‚¹å‡»"ä¿å­˜"æŒ‰é’®
2. é€‰æ‹©"ä¿å­˜"ï¼ˆè¦†ç›–ï¼‰æˆ–"å¦å­˜ä¸ºæ–°ç‰ˆæœ¬"
3. ç¼–è¾‘åçš„å›¾ç‰‡ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬ï¼ŒåŸå›¾ä¿ç•™

#### 14.2.5 åˆ›å»ºç›¸å†Œ

**æ‰‹åŠ¨ç›¸å†Œ**ï¼š
1. ç‚¹å‡»ä¾§è¾¹æ çš„"ç›¸å†Œ"èœå•
2. ç‚¹å‡»"æ–°å»ºç›¸å†Œ"
3. è¾“å…¥ç›¸å†Œåç§°å’Œæè¿°
4. é€‰æ‹©è¦æ·»åŠ çš„å›¾ç‰‡
5. ç‚¹å‡»"åˆ›å»º"

**æ™ºèƒ½ç›¸å†Œ**ï¼š
1. åˆ›å»ºç›¸å†Œæ—¶é€‰æ‹©"æ™ºèƒ½ç›¸å†Œ"
2. è®¾ç½®è§„åˆ™ï¼ˆæ—¶é—´ã€æ ‡ç­¾ã€åœ°ç‚¹ç­‰ï¼‰
3. ç³»ç»Ÿè‡ªåŠ¨åŒ¹é…ç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡
4. è§„åˆ™åŒ¹é…çš„å›¾ç‰‡ä¼šåŠ¨æ€æ·»åŠ åˆ°ç›¸å†Œ

#### 14.2.6 åˆ†äº«å›¾ç‰‡

**å•ä¸ªå›¾ç‰‡åˆ†äº«**ï¼š
1. ç‚¹å‡»å›¾ç‰‡å¡ç‰‡ä¸Šçš„åˆ†äº«å›¾æ ‡
2. ç‚¹å‡»"å¼€å¯åˆ†äº«"
3. å¤åˆ¶åˆ†äº«é“¾æ¥
4. å‘é€ç»™ä»–äººå³å¯è®¿é—®

**åˆ†äº«è®¾ç½®**ï¼š
- å¯ä»¥è®¾ç½®è®¿é—®å¯†ç 
- å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´
- å¯ä»¥é™åˆ¶ä¸‹è½½æƒé™

### 14.3 é«˜çº§åŠŸèƒ½ä½¿ç”¨

#### 14.3.1 AI åˆ†æ

**è‡ªåŠ¨åˆ†æ**ï¼š
- ä¸Šä¼ å›¾ç‰‡åï¼Œç³»ç»Ÿè‡ªåŠ¨åœ¨åå°è¿›è¡ŒAIåˆ†æ
- åˆ†æå†…å®¹åŒ…æ‹¬ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€OCRæ–‡æœ¬ã€åœºæ™¯è¯†åˆ«

**æ‰‹åŠ¨è§¦å‘åˆ†æ**ï¼š
1. æ‰“å¼€å›¾ç‰‡è¯¦æƒ…é¡µ
2. å¦‚æœæœªåˆ†æï¼Œç‚¹å‡»"é‡æ–°åˆ†æ"æŒ‰é’®
3. ç­‰å¾…åˆ†æå®Œæˆ

**æŸ¥çœ‹åˆ†æç»“æœ**ï¼š
- åœ¨è¯¦æƒ…é¡µæŸ¥çœ‹AIç”Ÿæˆçš„æ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾
- æ ‡ç­¾ä¼šæ˜¾ç¤ºç½®ä¿¡åº¦ï¼ˆå¦‚æœå¯ç”¨ï¼‰

#### 14.3.2 è¯­ä¹‰æœç´¢

**ä½¿ç”¨æ–¹æ³•**ï¼š
1. å¯ç”¨"AIæœç´¢"å¼€å…³
2. è¾“å…¥è‡ªç„¶è¯­è¨€æŸ¥è¯¢
3. ç³»ç»Ÿä½¿ç”¨å‘é‡æ£€ç´¢è¿”å›è¯­ä¹‰ç›¸å…³çš„å›¾ç‰‡

**æœç´¢ç¤ºä¾‹**ï¼š
- "æ‰¾ä¸€äº›åŒ…å«çŒ«å’ªçš„å®¤å†…ç…§ç‰‡"
- "å»å¹´å¤å¤©åœ¨æµ·è¾¹æ‹çš„æ—¥è½"
- "ç”¨iPhoneæ‹æ‘„çš„äººåƒç…§ç‰‡"

#### 14.3.3 MCP å¯¹è¯æ£€ç´¢

**æ‰“å¼€å¯¹è¯**ï¼š
1. ç‚¹å‡»é¡¶éƒ¨å·¥å…·æ çš„"AIå¯¹è¯"æŒ‰é’®
2. æ‰“å¼€å¯¹è¯é¢æ¿

**å¯¹è¯ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·: å¸®æˆ‘æ‰¾ä¸€äº›æµ·è¾¹çš„ç…§ç‰‡

AI: [è°ƒç”¨æœç´¢å·¥å…·]
æˆ‘ä¸ºæ‚¨æ‰¾åˆ°äº†15å¼ æµ·è¾¹çš„ç…§ç‰‡ã€‚åŒ…æ‹¬æµ·è¾¹æ—¥è½ã€æµ·æµªã€æ²™æ»©ç­‰åœºæ™¯ã€‚

ç”¨æˆ·: åˆ›å»ºä¸€ä¸ªç›¸å†Œï¼ŒæŠŠè¿™äº›ç…§ç‰‡éƒ½åŠ è¿›å»

AI: [è°ƒç”¨åˆ›å»ºç›¸å†Œå·¥å…·]
å¥½çš„ï¼Œæˆ‘å·²ç»ä¸ºæ‚¨åˆ›å»ºäº†"æµ·è¾¹ç…§ç‰‡"ç›¸å†Œï¼Œå¹¶æ·»åŠ äº†è¿™15å¼ ç…§ç‰‡ã€‚
```

#### 14.3.4 è¶³è¿¹åœ°å›¾

**æŸ¥çœ‹åœ°å›¾**ï¼š
1. ç‚¹å‡»ä¾§è¾¹æ çš„"åœ°å›¾"èœå•
2. ç³»ç»Ÿæ˜¾ç¤ºæ‰€æœ‰æœ‰GPSä¿¡æ¯çš„å›¾ç‰‡
3. æ¯ä¸ªä½ç½®æ˜¾ç¤ºæ ‡è®°ç‚¹ï¼Œç‚¹å‡»æŸ¥çœ‹å›¾ç‰‡

**åœ°å›¾åŠŸèƒ½**ï¼š
- ç¼©æ”¾åœ°å›¾æŸ¥çœ‹ä¸åŒåŒºåŸŸ
- ç‚¹å‡»æ ‡è®°æŸ¥çœ‹å›¾ç‰‡è¯¦æƒ…
- è‡ªåŠ¨è°ƒæ•´è§†é‡åŒ…å«æ‰€æœ‰æ ‡è®°ç‚¹

### 14.4 å¸¸è§é—®é¢˜

**Q: ä¸Šä¼ çš„æ–‡ä»¶æ²¡æœ‰è‡ªåŠ¨åˆ†æï¼Ÿ**
A: AIåˆ†ææ˜¯åå°å¼‚æ­¥è¿›è¡Œçš„ï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿã€‚å¯ä»¥åœ¨"æ­£åœ¨å¤„ç†"é¡µé¢æŸ¥çœ‹è¿›åº¦ã€‚

**Q: å¦‚ä½•æ‰¹é‡æ“ä½œï¼Ÿ**
A: ç‚¹å‡»"å¤šé€‰"æŒ‰é’®æˆ–æŒ‰ `Ctrl/Cmd + Shift + A` è¿›å…¥å¤šé€‰æ¨¡å¼ï¼Œç„¶åé€‰æ‹©å¤šä¸ªå›¾ç‰‡è¿›è¡Œæ“ä½œã€‚

**Q: åˆ†äº«é“¾æ¥å¤±æ•ˆäº†æ€ä¹ˆåŠï¼Ÿ**
A: å…³é—­åˆ†äº«åå†é‡æ–°å¼€å¯ï¼Œä¼šç”Ÿæˆæ–°çš„é“¾æ¥ã€‚

**Q: å¦‚ä½•æ¢å¤è¯¯åˆ çš„å›¾ç‰‡ï¼Ÿ**
A: åœ¨"å›æ”¶ç«™"ä¸­æŸ¥çœ‹å·²åˆ é™¤çš„å›¾ç‰‡ï¼Œå¯ä»¥æ¢å¤æˆ–æ°¸ä¹…åˆ é™¤ã€‚

**Q: AIæœç´¢ä¸å·¥ä½œï¼Ÿ**
A: è¯·æ£€æŸ¥æ˜¯å¦é…ç½®äº† `GEMINI_API_KEY` ç¯å¢ƒå˜é‡ï¼Œå¹¶åœ¨è®¾ç½®ä¸­å¯ç”¨AIåŠŸèƒ½ã€‚

**Q: å¦‚ä½•å¯¼å‡ºå›¾ç‰‡ï¼Ÿ**
A: åœ¨å›¾ç‰‡è¯¦æƒ…é¡µç‚¹å‡»"ä¸‹è½½"æŒ‰é’®ï¼Œé€‰æ‹©ä¸‹è½½é¢„è®¾æˆ–è‡ªå®šä¹‰å°ºå¯¸ã€‚

---

## 15. å¼€å‘ä½“ä¼šä¸æ€»ç»“

### 15.1 å¼€å‘è¿‡ç¨‹å›é¡¾

**å¼€å‘æ—¶é—´çº¿**ï¼š

```mermaid
gantt
    title Zmage å¼€å‘æ—¶é—´çº¿
    dateFormat  YYYY-MM-DD
    section åŸºç¡€æ¶æ„
    é¡¹ç›®åˆå§‹åŒ–           :2025-01-01, 3d
    æ•°æ®åº“è®¾è®¡           :2025-01-04, 5d
    Dockeréƒ¨ç½²           :2025-01-09, 3d
    
    section æ ¸å¿ƒåŠŸèƒ½
    ç”¨æˆ·è®¤è¯             :2025-01-12, 3d
    æ–‡ä»¶ä¸Šä¼              :2025-01-15, 5d
    EXIFæå–             :2025-01-20, 3d
    ç¼©ç•¥å›¾ç”Ÿæˆ           :2025-01-23, 3d
    æœç´¢åŠŸèƒ½             :2025-01-26, 5d
    
    section AIåŠŸèƒ½
    Geminié›†æˆ           :2025-01-31, 5d
    å‘é‡æ£€ç´¢             :2025-02-05, 5d
    MCPæ¥å£              :2025-02-10, 7d
    
    section é«˜çº§åŠŸèƒ½
    æ™ºèƒ½ç›¸å†Œ             :2025-02-17, 5d
    å›¾ç‰‡ç¼–è¾‘             :2025-02-22, 5d
    ç‰ˆæœ¬æ§åˆ¶             :2025-02-27, 3d
    åœ°å›¾åŠŸèƒ½             :2025-03-01, 3d
    
    section ä¼˜åŒ–æµ‹è¯•
    æ€§èƒ½ä¼˜åŒ–             :2025-03-04, 5d
    æµ‹è¯•å®Œå–„             :2025-03-09, 5d
    æ–‡æ¡£ç¼–å†™             :2025-03-14, 7d
```

**ä¸»è¦é‡Œç¨‹ç¢‘**ï¼š
- âœ… **ç¬¬ä¸€é˜¶æ®µ**ï¼šåŸºç¡€æ¶æ„æ­å»ºï¼Œç”¨æˆ·è®¤è¯ã€æ–‡ä»¶ä¸Šä¼ 
- âœ… **ç¬¬äºŒé˜¶æ®µ**ï¼šæ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œæœç´¢ã€EXIFæå–ã€ç¼©ç•¥å›¾
- âœ… **ç¬¬ä¸‰é˜¶æ®µ**ï¼šAIåŠŸèƒ½é›†æˆï¼Œè¯­ä¹‰æœç´¢ã€MCPæ¥å£
- âœ… **ç¬¬å››é˜¶æ®µ**ï¼šé«˜çº§åŠŸèƒ½ï¼Œæ™ºèƒ½ç›¸å†Œã€å›¾ç‰‡ç¼–è¾‘ã€åœ°å›¾
- âœ… **ç¬¬äº”é˜¶æ®µ**ï¼šä¼˜åŒ–æµ‹è¯•ï¼Œæ€§èƒ½ä¼˜åŒ–ã€æ–‡æ¡£å®Œå–„

### 15.2 æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

#### 15.2.1 å¤§è§„æ¨¡å›¾ç‰‡åŠ è½½ä¼˜åŒ–

**é—®é¢˜**ï¼šå½“å›¾åº“æœ‰æ•°ä¸‡å¼ å›¾ç‰‡æ—¶ï¼Œä¸€æ¬¡æ€§åŠ è½½ä¼šå¯¼è‡´é¡µé¢å¡é¡¿ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **åˆ†é¡µåŠ è½½**ï¼šæ¯é¡µåªåŠ è½½24-50å¼ å›¾ç‰‡
- **æ‡’åŠ è½½**ï¼šä½¿ç”¨ `IntersectionObserver`ï¼Œæ»šåŠ¨åˆ°å¯è§†åŒºåŸŸæ‰åŠ è½½
- **è™šæ‹Ÿæ»šåŠ¨**ï¼šä½¿ç”¨ `FlashList` åªæ¸²æŸ“å¯è§é¡¹
- **ç¼©ç•¥å›¾ä¼˜å…ˆ**ï¼šå§‹ç»ˆä½¿ç”¨ç¼©ç•¥å›¾æ˜¾ç¤ºï¼ŒåŸå§‹å›¾ç‰‡æŒ‰éœ€åŠ è½½

#### 15.2.2 å‘é‡æ£€ç´¢æ€§èƒ½ä¼˜åŒ–

**é—®é¢˜**ï¼šå‘é‡æ£€ç´¢éœ€è¦è®¡ç®—ç›¸ä¼¼åº¦ï¼Œå¤§æ•°æ®é‡æ—¶æ€§èƒ½ä¸‹é™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **HNSWç´¢å¼•**ï¼šQdrantä½¿ç”¨HNSWç®—æ³•ï¼Œè¿‘ä¼¼æœ€è¿‘é‚»æœç´¢ï¼Œé€Ÿåº¦å¿«
- **è¿‡æ»¤åæ£€ç´¢**ï¼šå…ˆä½¿ç”¨å…³é”®è¯/æ—¶é—´è¿‡æ»¤ï¼Œç¼©å°æ£€ç´¢èŒƒå›´
- **å‘é‡ç¼“å­˜**ï¼šæŸ¥è¯¢å‘é‡ç¼“å­˜ï¼Œé¿å…é‡å¤è®¡ç®—
- **é™åˆ¶è¿”å›æ•°é‡**ï¼šé»˜è®¤è¿”å›20ä¸ªç»“æœï¼Œé¿å…è¿‡åº¦è®¡ç®—

#### 15.2.3 å‰åç«¯ç±»å‹åŒæ­¥

**é—®é¢˜**ï¼šå‰ç«¯TypeScriptå’Œåç«¯Pythonç±»å‹ä¸ä¸€è‡´ï¼Œå®¹æ˜“å‡ºé”™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **Pydantic Schema**ï¼šåç«¯ä½¿ç”¨Pydanticå®šä¹‰å“åº”æ¨¡å‹
- **è‡ªåŠ¨ç”Ÿæˆ**ï¼šFastAPIè‡ªåŠ¨ç”ŸæˆOpenAPIæ–‡æ¡£
- **æ‰‹åŠ¨åŒæ­¥**ï¼šå‰ç«¯æ ¹æ®APIæ–‡æ¡£æ‰‹åŠ¨å®šä¹‰TypeScriptæ¥å£
- **è¿è¡Œæ—¶éªŒè¯**ï¼šåç«¯Pydanticè‡ªåŠ¨éªŒè¯ï¼Œç¡®ä¿ç±»å‹å®‰å…¨

#### 15.2.4 å¼‚æ­¥ä»»åŠ¡å¤„ç†

**é—®é¢˜**ï¼šAIåˆ†æã€ç¼©ç•¥å›¾ç”Ÿæˆç­‰è€—æ—¶æ“ä½œé˜»å¡è¯·æ±‚ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **åå°ä»»åŠ¡**ï¼šä½¿ç”¨FastAPIçš„ `BackgroundTasks`
- **ä»»åŠ¡é˜Ÿåˆ—**ï¼šRedisé˜Ÿåˆ—å­˜å‚¨ä»»åŠ¡ï¼ˆè§„åˆ’ä¸­ï¼‰
- **çŠ¶æ€è¿½è¸ª**ï¼šèµ„äº§æœ‰ `status` å’Œ `processing_step` å­—æ®µ
- **å‰ç«¯è½®è¯¢**ï¼šå‰ç«¯å®šæœŸæŸ¥è¯¢å¤„ç†çŠ¶æ€ï¼Œæ˜¾ç¤ºè¿›åº¦

### 15.3 é‡åˆ°çš„æŒ‘æˆ˜

**æŒ‘æˆ˜ä¸€ï¼šå¤šæ•°æ®åº“ååŒ**
- **é—®é¢˜**ï¼šPostgreSQL + Qdrant + Redis + MinIOï¼Œæ•°æ®ä¸€è‡´æ€§éš¾ä¿è¯
- **è§£å†³**ï¼šæ˜ç¡®æ•°æ®æµå‘ï¼Œå…³é”®æ“ä½œä½¿ç”¨äº‹åŠ¡ï¼Œå¼‚æ­¥æ“ä½œæœ€ç»ˆä¸€è‡´

**æŒ‘æˆ˜äºŒï¼šAI APIè°ƒç”¨æˆæœ¬**
- **é—®é¢˜**ï¼šGemini APIæŒ‰é‡è®¡è´¹ï¼Œå¤§é‡è°ƒç”¨æˆæœ¬é«˜
- **è§£å†³**ï¼šä¼˜åŒ–Promptï¼Œå‡å°‘Tokenä½¿ç”¨ï¼›æ‰¹é‡å¤„ç†ï¼›ç¼“å­˜å‘é‡ç»“æœ

**æŒ‘æˆ˜ä¸‰ï¼šç§»åŠ¨ç«¯é€‚é…**
- **é—®é¢˜**ï¼šå¤æ‚åŠŸèƒ½åœ¨ç§»åŠ¨ç«¯ä½“éªŒä¸ä½³
- **è§£å†³**ï¼šå“åº”å¼è®¾è®¡ï¼Œè§¦æ‘¸ä¼˜åŒ–ï¼Œç®€åŒ–ç§»åŠ¨ç«¯æ“ä½œæµç¨‹

### 15.4 æ”¶è·ä¸æˆé•¿

**æŠ€æœ¯èƒ½åŠ›æå‡**ï¼š
- âœ… æŒæ¡äº†å…¨æ ˆå¼€å‘æŠ€èƒ½ï¼ˆNext.js + FastAPIï¼‰
- âœ… æ·±å…¥ç†è§£äº†å¾®æœåŠ¡æ¶æ„å’Œå®¹å™¨åŒ–éƒ¨ç½²
- âœ… å­¦ä¹ äº†AIæ¨¡å‹é›†æˆå’Œå‘é‡æ£€ç´¢æŠ€æœ¯
- âœ… æå‡äº†æ•°æ®åº“è®¾è®¡å’Œä¼˜åŒ–èƒ½åŠ›

**å·¥ç¨‹èƒ½åŠ›æå‡**ï¼š
- âœ… å­¦ä¼šäº†å¤§å‹é¡¹ç›®çš„æ¨¡å—åŒ–è®¾è®¡
- âœ… æŒæ¡äº†ç‰ˆæœ¬æ§åˆ¶å’Œåä½œå¼€å‘
- âœ… æå‡äº†é—®é¢˜æ’æŸ¥å’Œè°ƒè¯•èƒ½åŠ›
- âœ… å­¦ä¼šäº†ç¼–å†™æ¸…æ™°çš„æŠ€æœ¯æ–‡æ¡£

**äº§å“æ€ç»´æå‡**ï¼š
- âœ… ç†è§£äº†ç”¨æˆ·ä½“éªŒçš„é‡è¦æ€§
- âœ… å­¦ä¼šäº†å¹³è¡¡åŠŸèƒ½ä¸æ€§èƒ½
- âœ… æå‡äº†äº§å“è§„åˆ’å’Œè¿­ä»£èƒ½åŠ›

### 15.5 æœªæ¥æ”¹è¿›æ–¹å‘

**çŸ­æœŸæ”¹è¿›**ï¼š
1. **æ€§èƒ½ä¼˜åŒ–**ï¼šCDNåŠ é€Ÿã€å›¾ç‰‡å‹ç¼©ã€ç¼“å­˜ç­–ç•¥
2. **åŠŸèƒ½å®Œå–„**ï¼šç§»åŠ¨ç«¯åŸç”ŸAppã€å®æ—¶åä½œã€æ›´å¤šAIåŠŸèƒ½
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæ›´æµç•…çš„åŠ¨ç”»ã€æ›´æ™ºèƒ½çš„æ¨è

**é•¿æœŸè§„åˆ’**ï¼š
1. **å¤šç«¯æ”¯æŒ**ï¼šiOS/AndroidåŸç”ŸAppã€æ¡Œé¢å®¢æˆ·ç«¯
2. **åä½œå¢å¼º**ï¼šå›¢é˜Ÿåä½œã€æƒé™ç®¡ç†ã€è¯„è®ºç³»ç»Ÿ
3. **AIå¢å¼º**ï¼šäººè„¸è¯†åˆ«ã€åœºæ™¯ç†è§£ã€è‡ªåŠ¨åˆ†ç±»
4. **å•†ä¸šåŒ–**ï¼šè®¢é˜…ç³»ç»Ÿã€å­˜å‚¨é…é¢ã€ä¼ä¸šç‰ˆåŠŸèƒ½

### 15.6 æ€»ç»“

Zmage æ˜¯ä¸€ä¸ª**åŠŸèƒ½å®Œæ•´ã€æŠ€æœ¯å…ˆè¿›ã€ä½“éªŒä¼˜ç§€**çš„å›¾åƒèµ„äº§ç®¡ç†ç³»ç»Ÿã€‚å®ƒä¸ä»…å…¨é¢æ»¡è¶³äº†è¯¾ç¨‹è¦æ±‚ï¼Œæ›´åœ¨å¤šä¸ªç»´åº¦å®ç°äº†è¶…è¶Šï¼š

**æ ¸å¿ƒæˆå°±**ï¼š
- âœ… **æ¶æ„**ï¼šå¾®æœåŠ¡æ¶æ„ï¼Œå¤šæ•°æ®åº“ååŒï¼Œå®¹å™¨åŒ–éƒ¨ç½²
- âœ… **åŠŸèƒ½**ï¼š11é¡¹åŸºæœ¬åŠŸèƒ½ + 2é¡¹å¢å¼ºåŠŸèƒ½ï¼Œå…¨éƒ¨å®ç°
- âœ… **AIèƒ½åŠ›**ï¼šè¯­ä¹‰æœç´¢ã€å‘é‡æ£€ç´¢ã€MCPå¯¹è¯ã€æ™ºèƒ½ç›¸å†Œå»ºè®®
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ¶²æ€ç»ç’ƒUIã€å“åº”å¼è®¾è®¡ã€æµç•…äº¤äº’
- âœ… **æŠ€æœ¯å®ç°**ï¼šç±»å‹å®‰å…¨ã€å¼‚æ­¥å¤„ç†ã€æ€§èƒ½ä¼˜åŒ–

**é¡¹ç›®ä»·å€¼**ï¼š
Zmage ä¸ä»…æ˜¯ä¸€ä¸ªè¯¾ç¨‹ä½œä¸šï¼Œæ›´æ˜¯ä¸€ä¸ª**å¯å®é™…ä½¿ç”¨ã€å…·å¤‡å•†ä¸šä»·å€¼**çš„äº§å“ã€‚å®ƒå±•ç¤ºäº†ç°ä»£Webå¼€å‘çš„æœ€ä½³å®è·µï¼Œèåˆäº†å‰æ²¿AIæŠ€æœ¯ï¼Œä¸ºç”¨æˆ·æä¾›äº†ä¸“ä¸šçº§çš„å›¾åƒç®¡ç†ä½“éªŒã€‚

**æŠ€æœ¯äº®ç‚¹**ï¼š
- å‰åç«¯åˆ†ç¦» + å¾®æœåŠ¡æ¶æ„
- å¤šæ•°æ®åº“ååŒï¼ˆPostgreSQL + Qdrant + Redis + MinIOï¼‰
- AIæ·±åº¦é›†æˆï¼ˆGeminiå¤šæ¨¡æ€ç†è§£ï¼‰
- å®Œæ•´çš„MCPå·¥å…·ç”Ÿæ€
- ä¸“ä¸šçº§å›¾ç‰‡ç¼–è¾‘å’Œç‰ˆæœ¬æ§åˆ¶
- ä¸€é”®Dockeréƒ¨ç½²

é€šè¿‡è¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘æ·±å…¥ç†è§£äº†B/Sæ¶æ„è®¾è®¡çš„ç²¾é«“ï¼ŒæŒæ¡äº†å…¨æ ˆå¼€å‘çš„æ ¸å¿ƒæŠ€èƒ½ï¼Œä¸ºæœªæ¥çš„æŠ€æœ¯å‘å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

---

**é¡¹ç›®å®Œæˆæ—¥æœŸ**ï¼š2025å¹´1æœˆ  
**å¼€å‘å‘¨æœŸ**ï¼šçº¦3ä¸ªæœˆ  
**ä»£ç è¡Œæ•°**ï¼šå‰ç«¯ ~15,000è¡Œï¼Œåç«¯ ~10,000è¡Œ  
**APIç«¯ç‚¹**ï¼š70+ ä¸ª  
**æ•°æ®åº“è¡¨**ï¼š15+ ä¸ª  

Zmage - è®©æ¯ä¸€å¼ å›¾ç‰‡éƒ½æœ‰æ„ä¹‰ ğŸ¨

---

## 16. å‚è€ƒæ–‡çŒ®

### 16.1 æŠ€æœ¯æ–‡æ¡£
- Next.js å®˜æ–¹æ–‡æ¡£ï¼šhttps://nextjs.org/docs
- FastAPI å®˜æ–¹æ–‡æ¡£ï¼šhttps://fastapi.tiangolo.com/
- Google Gemini API æ–‡æ¡£ï¼šhttps://ai.google.dev/docs
- Qdrant å‘é‡æ•°æ®åº“æ–‡æ¡£ï¼šhttps://qdrant.tech/documentation/

### 16.2 è¯¾ç¨‹èµ„æ–™
- B/S ç¨‹åºè®¾è®¡è¯¾ç¨‹è¯¾ä»¶
- è¯¾ç¨‹å®éªŒè¦æ±‚æ–‡æ¡£

### 16.3 å¼€æºé¡¹ç›®
- shadcn/uiï¼šhttps://ui.shadcn.com/
- Tailwind CSSï¼šhttps://tailwindcss.com/

---

## é™„å½•

### é™„å½• Aï¼šé¡¹ç›®ç»“æ„

**å®Œæ•´é¡¹ç›®ç›®å½•æ ‘**ï¼š

```
zmage/
â”œâ”€â”€ apps/                          # åº”ç”¨ä»£ç 
â”‚   â”œâ”€â”€ api/                       # FastAPI åç«¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.py           # åº”ç”¨å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ config.py         # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ user.py       # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset.py      # èµ„äº§æ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ album.py      # ç›¸å†Œæ¨¡å‹
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ database.py   # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”‚   â”œâ”€â”€ routers/          # API è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ auth.py       # è®¤è¯è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ assets.py     # èµ„äº§è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ albums.py     # ç›¸å†Œè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ai.py         # AI è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ mcp.py        # MCP æ¥å£è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ shares.py     # åˆ†äº«è·¯ç”±
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ batch.py      # æ‰¹é‡æ“ä½œè·¯ç”±
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”œâ”€â”€ services/         # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset.py      # èµ„äº§æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ album.py      # ç›¸å†ŒæœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ storage.py    # å­˜å‚¨æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ gemini.py     # Gemini AI æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vector.py     # å‘é‡æœåŠ¡
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/          # Pydantic æ•°æ®éªŒè¯
â”‚   â”‚   â”‚   â”œâ”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ security.py   # å®‰å…¨å·¥å…·ï¼ˆJWTã€å¯†ç ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ migrations/       # æ•°æ®åº“è¿ç§»
â”‚   â”‚   â”‚       â”œâ”€â”€ init.sql      # åˆå§‹åŒ–è„šæœ¬
â”‚   â”‚   â”‚       â””â”€â”€ migrate.py    # è¿ç§»å·¥å…·
â”‚   â”‚   â”œâ”€â”€ Dockerfile            # Docker æ„å»ºæ–‡ä»¶
â”‚   â”‚   â””â”€â”€ requirements.txt      # Python ä¾èµ–
â”‚   â”œâ”€â”€ web/                       # Next.js å‰ç«¯åº”ç”¨
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ app/              # App Router é¡µé¢
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx      # é¦–é¡µï¼ˆå›¾åº“ï¼‰
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ login/        # ç™»å½•é¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ register/     # æ³¨å†Œé¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ map/          # åœ°å›¾é¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ albums/       # ç›¸å†Œé¡µ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ vault/        # ä¿é™©åº“é¡µ
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ layout.tsx    # æ ¹å¸ƒå±€
â”‚   â”‚   â”‚   â”œâ”€â”€ components/       # React ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset/        # èµ„äº§ç›¸å…³ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset-card.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset-grid.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ asset-editor.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ layout/       # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ sidebar.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ header.tsx
â”‚   â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ui/           # UI åŸºç¡€ç»„ä»¶
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ ...       # shadcn/ui ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ lib/              # å·¥å…·åº“
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ api.ts        # API å®¢æˆ·ç«¯
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ utils.ts      # å·¥å…·å‡½æ•°
â”‚   â”‚   â”‚   â”œâ”€â”€ store/            # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ index.ts      # Zustand store
â”‚   â”‚   â”‚   â””â”€â”€ hooks/            # React Hooks
â”‚   â”‚   â”œâ”€â”€ public/               # é™æ€èµ„æº
â”‚   â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”‚   â””â”€â”€ package.json          # Node.js ä¾èµ–
â”‚   â””â”€â”€ worker/                    # åå°ä»»åŠ¡æœåŠ¡
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â””â”€â”€ main.py           # Worker å…¥å£
â”‚       â”œâ”€â”€ Dockerfile
â”‚       â””â”€â”€ requirements.txt
â”œâ”€â”€ docs/                          # é¡¹ç›®æ–‡æ¡£
â”‚   â”œâ”€â”€ archive/                  # å½’æ¡£æ–‡æ¡£
â”‚   â”‚   â”œâ”€â”€ 01_æ‘˜è¦.md
â”‚   â”‚   â”œâ”€â”€ 02_é¡¹ç›®æ„¿æ™¯ä¸è®¾è®¡å“²å­¦.md
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ tech.md                   # æŠ€æœ¯æ–‡æ¡£
â”‚   â”œâ”€â”€ PROGRESS.md               # è¿›åº¦è®°å½•
â”‚   â””â”€â”€ rules.md                  # å¼€å‘è§„åˆ™
â”œâ”€â”€ scripts/                       # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ start.sh                  # å¯åŠ¨è„šæœ¬
â”‚   â””â”€â”€ dev.sh                    # å¼€å‘è„šæœ¬
â”œâ”€â”€ test_media/                    # æµ‹è¯•åª’ä½“æ–‡ä»¶
â”œâ”€â”€ brand/                         # å“ç‰Œèµ„æº
â”‚   â””â”€â”€ icon.png                  # åº”ç”¨å›¾æ ‡
â”œâ”€â”€ docker-compose.yml             # Docker Compose é…ç½®
â”œâ”€â”€ README.md                      # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ product.md                     # äº§å“æ–‡æ¡£
â””â”€â”€ report.md                      # æœ¬æŠ¥å‘Š

```

**ä»£ç ç»Ÿè®¡**ï¼š
- **æ€»ä»£ç æ–‡ä»¶æ•°**ï¼š120+ ä¸ªæ–‡ä»¶ï¼ˆPython + TypeScript/TSXï¼‰
- **å‰ç«¯ä»£ç è¡Œæ•°**ï¼šçº¦ 7,000+ è¡Œï¼ˆTypeScript/TSXï¼‰
- **åç«¯ä»£ç è¡Œæ•°**ï¼šçº¦ 4,000+ è¡Œï¼ˆPythonï¼‰
- **æ€»ä»£ç è¡Œæ•°**ï¼šçº¦ 11,000+ è¡Œï¼ˆä¸å«æ³¨é‡Šå’Œç©ºè¡Œï¼‰

### é™„å½• Bï¼šå…³é”®é…ç½®æ–‡ä»¶

#### B.1 ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ`.env`ï¼‰

**âš ï¸ æäº¤è¯´æ˜**ï¼š

æœ¬æ¬¡æäº¤çš„å‹ç¼©åŒ…ä¸­**å·²åŒ…å«å®Œæ•´çš„ `.env` æ–‡ä»¶**ï¼ŒåŒ…å«æ‰€æœ‰å¿…éœ€çš„é…ç½®å’Œ API å¯†é’¥ã€‚**æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œç›´æ¥ä½¿ç”¨å³å¯**ã€‚

**é…ç½®å†…å®¹**ï¼š

æäº¤çš„ `.env` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```bash
# Google Gemini API å¯†é’¥
# âš ï¸ é‡è¦ï¼šæä¾› 5 ç¾å…ƒé¢åº¦ï¼Œæœ‰æ•ˆæœŸè‡³ 2025-01-20
# è¯·ä»…ç”¨äºè¯¾ç¨‹æµ‹è¯•ï¼Œé¿å…è¿‡åº¦ä½¿ç”¨
GEMINI_API_KEY=å·²é…ç½®ï¼ˆçœŸå®å¯†é’¥ï¼‰

# æ•°æ®åº“é…ç½®ï¼ˆDocker å†…éƒ¨è¿æ¥ï¼‰
DATABASE_URL=postgresql+asyncpg://zmage:zmage_password@img-lib-postgres:5432/zmage

# Redis é…ç½®ï¼ˆDocker å†…éƒ¨è¿æ¥ï¼‰
REDIS_URL=redis://img-lib-redis:6379/0

# Qdrant å‘é‡æ•°æ®åº“ï¼ˆDocker å†…éƒ¨è¿æ¥ï¼‰
QDRANT_URL=http://img-lib-qdrant:6333

# MinIO å¯¹è±¡å­˜å‚¨ï¼ˆDocker å†…éƒ¨è¿æ¥ï¼‰
S3_ENDPOINT=http://img-lib-minio:9000
S3_ACCESS_KEY=minioadmin
S3_SECRET_KEY=minioadmin
S3_BUCKET=zmage

# JWT è®¤è¯å¯†é’¥ï¼ˆå·²ç”Ÿæˆéšæœºå¯†é’¥ï¼‰
JWT_SECRET=å·²é…ç½®ï¼ˆéšæœºç”Ÿæˆï¼‰

# ç«¯å£é…ç½®
WEB_PORT=32333
API_PORT=34257
```

**ä½¿ç”¨è¯´æ˜**ï¼š

1. **æ–‡ä»¶ä½ç½®**ï¼šæäº¤åŒ…æ ¹ç›®å½•ä¸‹çš„ `.env` æ–‡ä»¶
2. **æ— éœ€ä¿®æ”¹**ï¼šæ–‡ä»¶å·²å®Œæ•´é…ç½®ï¼Œå¯ç›´æ¥ä½¿ç”¨
3. **API å¯†é’¥**ï¼š
   - Gemini API æä¾› 5 ç¾å…ƒé¢åº¦ï¼Œè¶³ä»¥å®Œæˆå®Œæ•´åŠŸèƒ½æµ‹è¯•
   - æœ‰æ•ˆæœŸè‡³ 2026å¹´1æœˆ20æ—¥
   - è¯·åˆç†ä½¿ç”¨ï¼Œé¿å…ä¸å¿…è¦çš„ API è°ƒç”¨
4. **å…¶ä»–å¯†é’¥**ï¼šéƒ¨åˆ†å¯†é’¥æ— æ³•è®¾ç½®é™é¢ï¼Œè¯·ä»…ç”¨äºè¯¾ç¨‹æµ‹è¯•

#### B.2 Docker Compose é…ç½®ï¼ˆ`docker-compose.yml`ï¼‰

**æ ¸å¿ƒæœåŠ¡é…ç½®**ï¼š
- **PostgreSQL**ï¼šç«¯å£ 30432ï¼Œæ•°æ®æŒä¹…åŒ–
- **Redis**ï¼šç«¯å£ 30379ï¼Œç¼“å­˜å’Œé˜Ÿåˆ—
- **Qdrant**ï¼šç«¯å£ 30333ï¼Œå‘é‡æ•°æ®åº“
- **MinIO**ï¼šç«¯å£ 30900ï¼ˆAPIï¼‰/ 30901ï¼ˆæ§åˆ¶å°ï¼‰
- **FastAPI**ï¼šç«¯å£ 34257ï¼Œè‡ªåŠ¨è¿è¡Œè¿ç§»
- **Next.js**ï¼šç«¯å£ 32333ï¼Œç”Ÿäº§æ„å»º
- **Worker**ï¼šåå°ä»»åŠ¡å¤„ç†

#### B.3 å‰ç«¯é…ç½®ï¼ˆ`apps/web/package.json`ï¼‰

**å…³é”®ä¾èµ–**ï¼š
- `next`: 16.1.1 - Next.js æ¡†æ¶
- `react`: 19.2.3 - React åº“
- `@tanstack/react-query`: ^5.90.16 - æ•°æ®è·å–
- `zustand`: ^5.0.9 - çŠ¶æ€ç®¡ç†
- `framer-motion`: ^12.23.26 - åŠ¨ç”»åº“
- `tailwindcss`: ^4 - CSS æ¡†æ¶

#### B.4 åç«¯é…ç½®ï¼ˆ`apps/api/requirements.txt`ï¼‰

**å…³é”®ä¾èµ–**ï¼š
- `fastapi`: 0.109.0 - Web æ¡†æ¶
- `sqlalchemy`: >=2.0.36 - ORM
- `asyncpg`: >=0.29.0 - PostgreSQL å¼‚æ­¥é©±åŠ¨
- `google-genai`: 0.4.0 - Gemini AI SDK
- `qdrant-client`: 1.7.1 - Qdrant å®¢æˆ·ç«¯
- `boto3`: 1.34.14 - MinIO/S3 å®¢æˆ·ç«¯
- `pillow`: >=10.2.0 - å›¾åƒå¤„ç†
- `opencv-python-headless`: 4.9.0.80 - è§†é¢‘å¤„ç†

#### B.5 åº”ç”¨é…ç½®ï¼ˆ`apps/api/src/config.py`ï¼‰

**é…ç½®é¡¹è¯´æ˜**ï¼š

| é…ç½®é¡¹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|--------|
| `database_url` | PostgreSQL è¿æ¥å­—ç¬¦ä¸² | `postgresql+asyncpg://...` |
| `redis_url` | Redis è¿æ¥å­—ç¬¦ä¸² | `redis://img-lib-redis:6379/0` |
| `qdrant_url` | Qdrant æœåŠ¡åœ°å€ | `http://img-lib-qdrant:6333` |
| `qdrant_collection` | å‘é‡é›†åˆåç§° | `zmage_assets` |
| `gemini_api_key` | Gemini API å¯†é’¥ | ä»ç¯å¢ƒå˜é‡è¯»å– |
| `jwt_secret` | JWT ç­¾åå¯†é’¥ | `your_jwt_secret_key` |
| `access_token_expire_minutes` | Token è¿‡æœŸæ—¶é—´ | 10080 (7å¤©) |
| `embedding_dimension` | å‘é‡ç»´åº¦ | 768 |

### é™„å½• Cï¼šGit æäº¤è®°å½•

**å®Œæ•´æäº¤å†å²**ï¼š

```
67c0bf5 (HEAD -> master, origin/master) - zzw4257, 5 hours ago
feat: core features overhaul and internal loop verification

e2dd07b - zzw4257, 25 hours ago
feat(editor): implement professional image editor with non-destructive editing

04964e5 - zzw4257, 4 days ago
chore: add env example and cleanup metadata files

f5ad32c - zzw4257, 4 days ago
docs: add project documentation and test assets

9443eb4 - zzw4257, 4 days ago
feat(web/worker): implement frontend application and background worker

fb815c9 - zzw4257, 4 days ago
feat(api): implement business logic, routers and services

80cde0f - zzw4257, 4 days ago
feat(api): core infrastructure, models and configuration

c5fd92c - zzw4257, 4 days ago
chore: initial project skeleton and documentation
```

**æäº¤ç»Ÿè®¡**ï¼š
- **æ€»æäº¤æ•°**ï¼š8 æ¬¡æäº¤
- **å¼€å‘å‘¨æœŸ**ï¼šçº¦ 4 å¤©ï¼ˆé›†ä¸­å¼€å‘ï¼‰
- **ä¸»è¦åŠŸèƒ½æ¨¡å—**ï¼š
  1. é¡¹ç›®åˆå§‹åŒ–å’Œæ–‡æ¡£
  2. API æ ¸å¿ƒåŸºç¡€è®¾æ–½
  3. ä¸šåŠ¡é€»è¾‘å’Œè·¯ç”±æœåŠ¡
  4. å‰ç«¯åº”ç”¨å’Œåå°Worker
  5. æ–‡æ¡£å’Œæµ‹è¯•èµ„æº
  6. ç¯å¢ƒé…ç½®
  7. ä¸“ä¸šå›¾ç‰‡ç¼–è¾‘å™¨
  8. æ ¸å¿ƒåŠŸèƒ½å®Œå–„å’ŒéªŒè¯

**ä»£ç ç®¡ç†**ï¼š
- ä½¿ç”¨ Git è¿›è¡Œç‰ˆæœ¬æ§åˆ¶
- éµå¾ªçº¦å®šå¼æäº¤è§„èŒƒï¼ˆfeat/chore/docsï¼‰
- ä¸»åˆ†æ”¯ï¼š`master`
- è¿œç¨‹ä»“åº“ï¼š`origin/master`

### é™„å½• Dï¼šæ¼”ç¤ºè§†é¢‘è¯´æ˜

**æ¼”ç¤ºè§†é¢‘å†…å®¹å¤§çº²**ï¼š

#### D.1 ç³»ç»Ÿæ¦‚è¿°ï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
- é¡¹ç›®ä»‹ç»å’Œå®šä½
- æŠ€æœ¯æ ˆæ¦‚è§ˆ
- æ ¸å¿ƒåŠŸèƒ½äº®ç‚¹

#### D.2 åŸºç¡€åŠŸèƒ½æ¼”ç¤ºï¼ˆçº¦ 5 åˆ†é’Ÿï¼‰

1. **ç”¨æˆ·æ³¨å†Œä¸ç™»å½•**ï¼ˆ30ç§’ï¼‰
   - å±•ç¤ºæ³¨å†Œæµç¨‹
   - ç”¨æˆ·å/é‚®ç®±éªŒè¯
   - ç™»å½•æˆåŠŸ

2. **å›¾ç‰‡ä¸Šä¼ **ï¼ˆ1åˆ†é’Ÿï¼‰
   - æ‹–æ‹½ä¸Šä¼ 
   - æ‰¹é‡ä¸Šä¼ 
   - ä¸Šä¼ è¿›åº¦æ˜¾ç¤º
   - é‡å¤æ–‡ä»¶æ£€æµ‹

3. **EXIF ä¿¡æ¯æå–**ï¼ˆ30ç§’ï¼‰
   - è‡ªåŠ¨æå–æ‹æ‘„æ—¶é—´ã€GPSã€ç›¸æœºä¿¡æ¯
   - è‡ªåŠ¨åˆ›å»ºæ ‡ç­¾

4. **å›¾ç‰‡æµè§ˆ**ï¼ˆ1åˆ†é’Ÿï¼‰
   - ç½‘æ ¼/åˆ—è¡¨/ç€‘å¸ƒæµä¸‰ç§è§†å›¾
   - å…¨å±é¢„è§ˆ
   - å›¾ç‰‡è¯¦æƒ…é¡µ

5. **æœç´¢åŠŸèƒ½**ï¼ˆ1åˆ†é’Ÿï¼‰
   - å…³é”®è¯æœç´¢
   - AI è¯­ä¹‰æœç´¢
   - é«˜çº§ç­›é€‰

6. **å›¾ç‰‡ç¼–è¾‘**ï¼ˆ1åˆ†é’Ÿï¼‰
   - è£å‰ªã€è°ƒè‰²ã€æ—‹è½¬
   - ç‰ˆæœ¬å†å²æŸ¥çœ‹
   - ç‰ˆæœ¬æ¢å¤

#### D.3 é«˜çº§åŠŸèƒ½æ¼”ç¤ºï¼ˆçº¦ 5 åˆ†é’Ÿï¼‰

1. **æ™ºèƒ½ç›¸å†Œ**ï¼ˆ1.5åˆ†é’Ÿï¼‰
   - åˆ›å»ºæ‰‹åŠ¨ç›¸å†Œ
   - åˆ›å»ºæ™ºèƒ½ç›¸å†Œï¼ˆè§„åˆ™å¼•æ“ï¼‰
   - AI ç›¸å†Œå»ºè®®

2. **AI åŠŸèƒ½**ï¼ˆ1.5åˆ†é’Ÿï¼‰
   - AI å›¾ç‰‡åˆ†æï¼ˆæ ‡ç­¾ã€æè¿°ã€OCRï¼‰
   - è¯­ä¹‰æœç´¢æ¼”ç¤º
   - ç›¸ä¼¼å›¾ç‰‡æ¨è

3. **MCP å¯¹è¯æ£€ç´¢**ï¼ˆ1åˆ†é’Ÿï¼‰
   - æ‰“å¼€ AI å¯¹è¯
   - è‡ªç„¶è¯­è¨€æŸ¥è¯¢
   - å¯¹è¯å¼ç®¡ç†æ“ä½œ

4. **è¶³è¿¹åœ°å›¾**ï¼ˆ1åˆ†é’Ÿï¼‰
   - åœ°å›¾è§†å›¾
   - GPS æ ‡è®°ç‚¹
   - å›¾ç‰‡ä½ç½®å±•ç¤º

#### D.4 æ‰¹é‡æ“ä½œæ¼”ç¤ºï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
- å¤šé€‰æ¨¡å¼ï¼ˆCtrl+A, Shift+ç‚¹å‡»ï¼‰
- æ‰¹é‡åˆ é™¤
- æ‰¹é‡æ·»åŠ åˆ°ç›¸å†Œ
- æ‰¹é‡ä¸‹è½½

#### D.5 åˆ†äº«åŠŸèƒ½æ¼”ç¤ºï¼ˆçº¦ 1 åˆ†é’Ÿï¼‰
- åˆ›å»ºåˆ†äº«é“¾æ¥
- å¯†ç ä¿æŠ¤
- æœ‰æ•ˆæœŸè®¾ç½®
- è®¿é—®ç»Ÿè®¡

#### D.6 æŠ€æœ¯æ¶æ„å±•ç¤ºï¼ˆçº¦ 2 åˆ†é’Ÿï¼‰
- Docker Compose å¯åŠ¨
- æœåŠ¡å¥åº·æ£€æŸ¥
- API æ–‡æ¡£ï¼ˆSwaggerï¼‰
- æ•°æ®åº“ç»“æ„

**è§†é¢‘æ€»æ—¶é•¿**ï¼šçº¦ 15-20 åˆ†é’Ÿ

**å½•åˆ¶å»ºè®®**ï¼š
- ä½¿ç”¨é«˜æ¸…åˆ†è¾¨ç‡ï¼ˆ1920x1080ï¼‰
- å±•ç¤ºå…³é”®æ“ä½œæ­¥éª¤
- é‡ç‚¹å±•ç¤ºè¶…è¶Šè¯¾ç¨‹è¦æ±‚çš„åŠŸèƒ½
- åŒ…å«æŠ€æœ¯æ¶æ„è¯´æ˜

---

## âš ï¸ æäº¤è¯´æ˜ï¼ˆé‡è¦ï¼‰

### ç¯å¢ƒé…ç½®æ–‡ä»¶

**æäº¤å†…å®¹**ï¼š
- âœ… æäº¤çš„å‹ç¼©åŒ…ä¸­**å·²åŒ…å«å®Œæ•´çš„ `.env` æ–‡ä»¶**ï¼Œä½äºé¡¹ç›®æ ¹ç›®å½•
- âœ… æ–‡ä»¶åŒ…å«æ‰€æœ‰å¿…éœ€çš„é…ç½®å’Œ API å¯†é’¥
- âœ… **æ— éœ€æ‰‹åŠ¨é…ç½®æˆ–å¤åˆ¶**ï¼Œè§£å‹åç›´æ¥ä½¿ç”¨

**å¦‚ä½•ç¡®è®¤é…ç½®æ–‡ä»¶**ï¼š
```bash
# è§£å‹æäº¤åŒ…å
cd zmage

# ç¡®è®¤ .env æ–‡ä»¶å­˜åœ¨
ls -la .env

# å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜é…ç½®å·²å°±ç»ªï¼Œå¯ä»¥ç›´æ¥å¯åŠ¨ç³»ç»Ÿ
```

### API å¯†é’¥ä½¿ç”¨é™åˆ¶ä¸è¯´æ˜

**é‡è¦æç¤º**ï¼š

1. **æœ‰æ•ˆæœŸ** â°ï¼š
   - æ‰€æœ‰ API å¯†é’¥æœ‰æ•ˆæœŸè‡³ **2025å¹´1æœˆ20æ—¥**
   - è¯·åœ¨æœ‰æ•ˆæœŸå†…å®Œæˆæµ‹è¯•å’Œè¯„ä¼°
   - è¿‡æœŸåå°†æ— æ³•æ­£å¸¸ä½¿ç”¨ AI ç›¸å…³åŠŸèƒ½

2. **Gemini API å¯†é’¥** ğŸ’°ï¼š
   - å·²é…ç½® `GEMINI_API_KEY`
   - æä¾› **5 ç¾å…ƒ**çš„ API è°ƒç”¨é¢åº¦
   - è¯¥é¢åº¦è¶³ä»¥å®Œæˆå®Œæ•´çš„ç³»ç»ŸåŠŸèƒ½æ¼”ç¤ºå’Œæµ‹è¯•
   - **è¯·é…Œæƒ…ä½¿ç”¨**ï¼Œé¿å…ä¸å¿…è¦çš„ API è°ƒç”¨

3. **å…¶ä»– API å¯†é’¥** âš ï¸ï¼š
   - éƒ¨åˆ† API å¯†é’¥å› æŠ€æœ¯é™åˆ¶**æ— æ³•åˆ é™¤æˆ–è®¾ç½®ä½¿ç”¨é™é¢**
   - **è¯·ä»…ç”¨äºæœ¬è¯¾ç¨‹çš„æµ‹è¯•å’Œè¯„ä¼°ï¼Œä¸è¦ç”¨äºå…¶ä»–ç”¨é€”**
   - æµ‹è¯•å®Œæˆåå»ºè®®å¿½ç•¥æˆ–åˆ é™¤ç›¸å…³å¯†é’¥
   - **éƒ¨åˆ†å¯†é’¥çš„ä½¿ç”¨é£é™©éœ€è‡ªè¡Œæ‰¿æ‹…**

4. **ä½¿ç”¨å»ºè®®** ğŸ’¡ï¼š
   - ä¼˜å…ˆæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½ï¼ˆä¸Šä¼ ã€æµè§ˆã€æœç´¢ã€ç¼–è¾‘ï¼‰
   - AI åŠŸèƒ½æµ‹è¯•æ—¶å»ºè®®ä½¿ç”¨ 3-5 å¼ å›¾ç‰‡éªŒè¯å³å¯
   - é¿å…å¤§é‡é‡å¤æµ‹è¯•ï¼Œå¯èƒ½å¯¼è‡´ API è°ƒç”¨è¶…é™ï¼ˆæˆ‘ä½¿ç”¨çš„æ˜¯ç›®å‰æ•ˆæœæœ€å¥½ä¹Ÿæœ€è´µçš„gemini-3-flash-image-previewï¼‰

### ç³»ç»Ÿè¿è¡Œæ–¹å¼

**ä¸€é”®å¯åŠ¨**ï¼š

```bash
# 1. ç¡®è®¤ .env æ–‡ä»¶å·²å­˜åœ¨ï¼ˆå·²åœ¨æäº¤åŒ…ä¸­ï¼‰
cd zmage
ls -la .env

# 2. ä¸€é”®å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# 3. æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆç¡®è®¤æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼‰
docker compose logs -f

# 4. è®¿é—®ç³»ç»Ÿ
# å‰ç«¯ï¼šhttp://localhost:32333
# APIæ–‡æ¡£ï¼šhttp://localhost:34257/docs
```

**é¦–æ¬¡ä½¿ç”¨**ï¼š
1. è®¿é—® http://localhost:32333
2. ç‚¹å‡»"æ³¨å†Œ"åˆ›å»ºè´¦å·ï¼ˆç”¨æˆ·å >= 6å­—ç¬¦ï¼Œå¯†ç  >= 6å­—ç¬¦ï¼‰
3. æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨ç™»å½•ï¼Œå¼€å§‹ä½“éªŒ

---

**æŠ¥å‘Šç»“æŸ**

---

**ä½œè€…**ï¼šå‘¨å­ä¸º  
**å­¦å·**ï¼šzzw4257  
**è¯¾ç¨‹**ï¼šB/Sç¨‹åºè®¾è®¡  
**é¡¹ç›®**ï¼šZmage å›¾åƒèµ„äº§ç®¡ç†ç³»ç»Ÿ  
**ç‰ˆæœ¬**ï¼šAç‰ˆæœ¬ï¼ˆå…¨é‡ç‰ˆæœ¬ï¼‰  
**å®Œæˆæ—¥æœŸ**ï¼š2026å¹´1æœˆ

